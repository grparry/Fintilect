"use strict";define("Wiki/View",["require","exports","react","VSS/Platform/History","VSS/Platform/Layout","VSSUI/Page","VSSUI/Spinner","Wiki/Overview/Components/OverviewContainer","Wiki/ViewCommon/Constants","Wiki/ViewCommon/Utils/PathHelper","Wiki/ViewCommon/Utils/WikiHelper","Wiki/ViewCommon/Utils/WikiPermissionsHelper"],(function(i,e,t,s,n,o,a,r,c,l,k,h){var g,p;g=e[p="Resources"]={},e[p].LoadingSpinnerLabel="Loading...",function(i){e[i]={};class p extends n.VssComponent{constructor(i,e){super(i,e),this._onHistoryPopped=i=>{const{newState:e,oldState:t}=i,s=P(t),n=P(e);if(e&&e.state&&t&&t.routeId===e.routeId&&s===n){(0,k.setWikiWindowTitle)(this.context.pageContext,e.state);const i=v(e.state),t={path:i.pagePath||e.data&&e.data.pagePath,id:i.pageId},s={action:i._a||"view",anchor:i.anchor};this.setState({wikiPageInfo:t,wikiViewOptions:s})}},this._contributionService=this.context.pageContext.getService("IVssContributionService");const t=this._contributionService.getData(c.WikiDataProviderContributionId),s=W(this.context.pageContext,t),n=w(t);this._historyService=e.pageContext.getService("IVssHistoryService");const{_a:o,anchor:a,pagePath:r,pageId:h,unfollow:g}=this._historyService.getState();let p=!1;const m=Boolean(t&&!t.landingWikiPage&&!h&&r);t&&!m||(p=!0,this._reattemptDataProvider=!0,this._reattemptRequestParameters=m?{pagePath:(0,l.normalizeWikiPagePath)(r)}:void 0,(0,k.publish)(this.context.pageContext,"WikiDataProviderCallFromClient",s&&s.wiki?s.wiki.type:void 0,{pageId:n&&n.id,isWikiPagePathIncorrect:m})),d(this.context.pageContext,n,s);const u={action:o||"view",anchor:a,unfollow:"true"===g||void 0};this.state={wikiViewOptions:u,wikiInfo:s,wikiPageInfo:n,wikiPages:t&&t.pages?t.pages:[],showPublishCodeWikiAction:C(t,s),showCreateNewProjectWikiAction:f(t,s),isHandleBrokenLinksEnabled:b(t),isEmptyWiki:S(this.context.pageContext,t,r),isStakeHolder:!t||t.isStakeholder,hasDefaultWikiAccess:!!t&&!!t.hasDefaultWikiAccess,permissionError:t&&t.permissionError,isTfvcOnlyProject:!!t&&!!t.isTfvcOnlyProject,isProjectWikiExisting:!!t&&!!t.isProjectWikiExisting,isUserGivenWiki:!!t&&!!t.isUserGivenWiki,isRepositoryDisabled:!!t&&!!t.isRepositoryDisabled,isLoading:p,isInitialTreeDataPopulated:!!t&&!!t.isInitialTreeDataPopulated,isIllegalPath:!1}}componentDidMount(){if(super.componentDidMount(),this._historyService.subscribe(this._onHistoryPopped,s.HistoryServiceEventNames.statePopped),this._reattemptDataProvider)this._reattemptDataProvider=!1,this.trackPromise(this._contributionService.getDataAsync(c.WikiDataProviderContributionId,this._reattemptRequestParameters)).promise.then((i=>{if(i){const e=W(this.context.pageContext,i),t=w(i);e&&m(this.context.pageContext,e,t,this.state.wikiViewOptions);const{pagePath:s}=this._historyService.getState();d(this.context.pageContext,t,e),this.setState({wikiInfo:e,wikiPageInfo:t,showPublishCodeWikiAction:C(i,e),showCreateNewProjectWikiAction:f(i,e),wikiPages:i.pages,isHandleBrokenLinksEnabled:b(i),isEmptyWiki:S(this.context.pageContext,i,s),isStakeHolder:i.isStakeholder,hasDefaultWikiAccess:!!i.hasDefaultWikiAccess,permissionError:i.permissionError,isTfvcOnlyProject:!!i.isTfvcOnlyProject,isProjectWikiExisting:!!i.isProjectWikiExisting,isUserGivenWiki:i.isUserGivenWiki,isLoading:!1,isInitialTreeDataPopulated:!!i.isInitialTreeDataPopulated})}else{const i=this._contributionService.getDataProviderExceptions();if(i){const e=i[c.WikiDataProviderContributionId];e&&"WikiIllegalCharacterPathException"===e.exceptionType&&this.setState({isIllegalPath:!0})}this.setState({isLoading:!1})}}),(()=>{this.setState({isLoading:!1})}));else{const{wikiInfo:i,wikiPageInfo:e,wikiViewOptions:t}=this.state;i&&m(this.context.pageContext,i,e,t)}}componentWillUnmount(){super.componentWillUnmount(),this._historyService.unsubscribe(this._onHistoryPopped,s.HistoryServiceEventNames.statePopped)}render(){const{wikiViewOptions:i,wikiInfo:e,wikiPageInfo:s,showCreateNewProjectWikiAction:n,showPublishCodeWikiAction:c,isLoading:l}=this.state;return l?t.createElement(a.Spinner,{className:"flex-grow",label:g.LoadingSpinnerLabel}):t.createElement(t.Fragment,null,e?t.createElement(o.Page,{className:"flex-grow"},t.createElement(r.OverviewContainer,{wikiInfo:e,wikiPageInfo:s,wikiViewOptions:i,showPublishCodeWikiAction:c,showCreateNewProjectWikiAction:n,wikiPages:this.state.wikiPages,isHandleBrokenLinksEnabled:this.state.isHandleBrokenLinksEnabled,isEmptyWiki:this.state.isEmptyWiki,isInitialTreeDataPopulated:this.state.isInitialTreeDataPopulated,isPageCommentsReadOnly:!e.wikiPermissions.hasWikiPageCommentsWritePermission})):this._renderNoWikiExperiences())}_renderNoWikiExperiences(){return t.createElement(n.WrappedComponent,{wrappedType:"Wiki.NoWiki",dependencies:["ms.vss-wiki-web.wiki-nowiki-experience"],isStakeHolder:this.state.isStakeHolder,hasDefaultWikiAccess:this.state.hasDefaultWikiAccess,permissionError:this.state.permissionError,isTfvcOnlyProject:this.state.isTfvcOnlyProject,isProjectWikiExisting:this.state.isProjectWikiExisting,isUserGivenWiki:this.state.isUserGivenWiki,isIllegalPath:this.state.isIllegalPath,isRepositoryDisabled:this.state.isRepositoryDisabled})}}function d(i,e,t){e&&e.isNonConformant&&(0,k.publish)(i,"NonConformantPageSelected",t&&t.wiki?t.wiki.type:void 0,{path:e.path})}function P(i){let e;return i&&i.state&&(e=i.state.wikiIdentifier),e}function m(i,e,t,s){let n;n={_a:s.action},t&&(n=Object.assign(Object.assign({},n),{pagePath:t.path,pageId:t.id}));const o={[c.UrlConstants.WikiIdentifierParam]:e.wiki.name,[c.UrlConstants.WikiVersionParam]:(0,k.getVersionFromBranchName)(e.wikiVersion.version)};(0,k.updateUrl)(i,n,o,2,!0)}function W(i,e){return e&&e.landingWiki&&e.landingWikiVersion?{wiki:e.landingWiki,wikiVersion:e.landingWikiVersion,wikiRepositoryData:e.repositoryData,wikiPermissions:u(i,e.landingWiki,e.isStakeholder)}:void 0}function w(i){return i&&i.landingWikiPage?Object.assign(Object.assign({},i.landingWikiPage),{version:i.landingPageVersion}):void 0}function u(i,e,t){return{hasWikiRenamePermission:h.hasWikiRenamePermission(i,e,t),hasWikiContributePermission:h.hasWikiContributePermission(i,e,t),hasWikiManagePermission:h.hasWikiManagePermission(i,e,t),hasWikiCreatePermission:h.hasWikiCreatePermission(i,e.projectId,t),hasWikiPageCommentsWritePermission:h.hasWikiPageCommentsWritePermission(i,e,t)}}function v(i,e){const t=Object.assign(Object.assign({},e),i);return t._a&&(t._a=t._a.toLowerCase()),t.pagePath&&(t.pagePath=(0,l.normalizeWikiPagePath)(t.pagePath)),t}function C(i,e){return Boolean(i&&e&&!i.isTfvcOnlyProject&&e.wikiPermissions.hasWikiContributePermission)}function f(i,e){return Boolean(i&&e&&!i.isProjectWikiExisting&&e.wikiPermissions.hasWikiCreatePermission)}function b(i){return Boolean(i&&i.isBrokenLinksHandlingEnabled)}function S(i,e,t){return Boolean(!t&&e&&e.landingWiki&&(0===e.landingWiki.type||(0,k.isCodeEditEnabled)(i))&&!e.landingWikiPage&&(!e.pages||1===e.pages.length))}e[i].View=p,e[i]._publishNonConformantPage=d,e[i]._getWikiIdentitiferFromNavHistoryEntry=P,e[i]._updateInitialUrl=m,e[i]._getWikiInfo=W,e[i]._getWikiPageInfo=w,e[i]._getWikiPermissions=u,e[i]._getNormalizedUrlParameters=v,e[i]._getPublishCodeWikiActionFlag=C,e[i]._getCreateNewProjectWikiActionFlag=f,e[i]._getHandleBrokenLinksFlag=b,e[i]._checkIfEmptyWiki=S,n.VssComponent.register("TFS.Wiki.View",p)}("View")}),["Resources","View"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-wiki-web.wiki-content"}}));