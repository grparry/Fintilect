"use strict";define("Wiki/Renderer",["require","exports","VSS/Features/Markdown/Utils/UrlHelper","VSS/Features/Markdown/Utils/UserContentAnchorHelper","VSS/Platform/Util/Url","Wiki/ViewCommon/Constants","Wiki/ViewCommon/Utils/PathHelper","Wiki/ViewCommon/Utils/WikiHelper","VSS/Platform/Feature","VSS/Core/Util/String","VSS/Features/Markdown/MarkdownConstants","Wiki/Clients/Wiki/RestClient/Wiki","Wiki/ViewCommon/Utils/PageHelper","react","VSS/Features/Markdown/MarkdownRenderer","VSS/Features/Markdown/MarkdownRendererComponent","VSS/Features/Markdown/Plugins/AnchoredHeaders","VSS/Platform/FPS","VSS/Platform/Layout"],(function(e,t,n,i,r,o,s,a,p,c,l,h,d,u,m,g,_,f,k){var w,C,P,M,S,x,y,v,T,b,I;w=t[I="Resources"]={},t[I].TemplatesCycleDetectedMessage="Can't render {0} as interdependent templates are not supported.",t[I].TemplateNotFoundMessage="template {0} does not exist",function(e){function p(e){if(!e)return null;e=e.replace(" ","+");const t=encodeURIComponent(e),n=i.UserContentAnchorHelper.convertAnchorName(t);return document.getElementById(n)||document.getElementById(t)}function c(e,t){return!!(0,n.isExternalUrl)(e)||!function(e,t){const n=new r.Uri(e);return new r.Uri(t).path.toLowerCase().startsWith(n.path.toLowerCase())}(e,t)}function l(){return!!/chrome\/([\d+.]+)/i.exec(navigator.userAgent)}C=t[e]={},t[e].isInternalAnchorLink=function(e,t,n,i,s){let p=0===e.indexOf("#");if(!p&&i)try{const c=new r.Uri(e);let l=c.getQueryParam(o.UrlConstants.PagePathParam)===i;if(!l&&t&&n&&n.name&&s){const e=t.getService("ITfsPageService").getData();if(e&&e.project){const i=(0,a.getSimpleUrl)(t,{[o.UrlConstants.ProjectParam]:e.project.name,[o.UrlConstants.WikiIdentifierParam]:n.name,[o.UrlConstants.PageIdParam]:s.toString()});l=c.absoluteUri.indexOf(i)>0}}const h=c.getQueryParam(o.UrlConstants.AnchorParam);p=l&&!!h}catch(e){return!1}return p},t[e].getExternalWikiHubPageUrl=function(e,t){const n={},i=e.getService("ITfsPageService").getData();i&&i.project&&(n[o.UrlConstants.ProjectParam]=i.project.name);const r=(0,a.getNewWikiState)(e,Object.assign(Object.assign({},n),t),{},0);return(0,a.routeUrlFromRouteTemplate)(e,"{project}/_wiki/wikis/{*wikiIdentifier}",r)},t[e].wikiLinkOnClickEventHelper=function(e,t){const n=e.ctrlKey&&l()||e.metaKey&&(0,a.isSafari)()||1===e.button&&(0,a.isFirefox)(),i=!(e.ctrlKey||e.altKey||e.shiftKey||e.metaKey);if(!n&&!i)return!0;if(e.stopPropagation(),e.preventDefault(),n){const t=window.open(e.currentTarget.href,"_blank");t&&(t.opener=null)}else i&&t();return!1},t[e].scrollToAnchor=function(e){if(e){const t=p(e);if(t)return t.scrollIntoView(),!1}return!0},t[e].focusAnchor=function(e){if(e){const t=p(e);(null==t?void 0:t.firstElementChild)&&t.firstElementChild.focus()}},t[e].isBrokenLink=function(e,t,n){try{if(c(e,n))return!1;let i=new r.Uri(e).getQueryParam(o.UrlConstants.PagePathParam);i=i&&i.replace(/\\/g,"/");const a=i&&(0,s.decodeHyphenAndSpacesInPath)(i);if(a)return!t(a.toLocaleLowerCase())}catch(e){return!1}return!1},t[e].isUrlExternalToWiki=c,t[e]._isChrome=l}("Helpers"),function(e){function n(e,t){e||(e=""),t||(t="");const n=r(e),i=function(e,t){let n="";"/"===e.charAt(0)&&(e=e.slice(1),n="/");"/"===t.charAt(0)&&(t=t.slice(1));let i=0;"/"===e.charAt(e.length-1)?e=e.slice(0,e.length-1):e.length>0&&(i=1);const r=e.length?e.split(/[\\\/]/):[],o=t.split(/[\\\/]/);let s=!0,a=0;for(let e=0;s&&e<o.length;e++)"."===o[e]?(o.splice(e,1),e--):".."===o[e]?a++:s=!1;let p=[];a<r.length&&(p=r.slice(0,r.length-i-a));const c=o.slice(a),l=p.concat(c).join("/");return n+l}(r(t),n);return decodeURIComponent(i)}function i(e){if(e){const t=e.lastIndexOf("/");if(t>=0)return e.substr(0,t+1)}return""}function r(e){const t=e.split(/[\\\/]/);for(let e=0;e<t.length;e++)t[e]=encodeURIComponent(t[e]);return t.join("/")}P=t[e]={},t[e].combine=function(e,t){if(!e)return void 0!==t?t:"";if(!t)return void 0!==e?e:"";let r=e,o=t;return"/"===t.charAt(0)&&(r="/",o=t.substr(1)),o=n(o,i(r)),o},t[e].getFileExtension=function(e){let t="";const n=(0,s.getFileName)(e),i=n.lastIndexOf(".");return i>=0&&(t=n.substring(i+1)),t},t[e]._resolveRelativePath=n,t[e]._getDirectory=i}("VCPathHelper"),function(e){M=t[e]={};t[e].getGitFileContentUrl=function(e,t,n,i,r,s=!1,c=!1){const l={area:"git",project:t,repositoryId:n,resource:"Items"},h={path:r,download:!s,resolveLfs:!0,$format:"octetStream","api-version":"5.0-preview.1"};return(0,p.isFeatureFlagEnabled)(e,o.AttachSvgFileFF,!1)&&(h.sanitize=!0),c&&(h.includeContentMetadata=!0),i&&(h["versionDescriptor.version"]=i.version,i.versionOptions&&(h["versionDescriptor.versionOptions"]=i.versionOptions),i.versionType&&(h["versionDescriptor.versionType"]=i.versionType)),(0,a.routeUrlFromRouteTemplate)(e,"{project}/_apis/{area}/repositories/{repositoryId}/{resource}",Object.assign(Object.assign({},l),h))}}("VCUrlHelper"),function(e){S=t[e]={};t[e].ImageTransformer=class{constructor(e,t,n,i,r){this._pageContext=e,this._projectId=t,this._repositoryId=n,this._versionDescriptor=i,this._wikiRootPath=r}transformImage(e,t,i=""){if(!e||(0,n.isAbsoluteUrl)(e)){try{e=decodeURIComponent(e)}catch(e){}return e}const o=decodeURIComponent(new r.Uri(e).absoluteUri),a=(0,s.getFileName)(o);if(t){const e=t[a];if(e)return e.objectUrl}const p=(0,s.getGitItemPath)(i,this._wikiRootPath),l="/"===this._wikiRootPath?this._wikiRootPath:this._wikiRootPath+"/",h=(0,c.startsWith)(o,"/")||(0,c.startsWith)(o,"/.attachments".substr(1))?l:p,d=(0,c.startsWith)(o,"/")?o.substr(1):o,u=P.combine(h,d);return(0,M.getGitFileContentUrl)(this._pageContext,this._projectId,this._repositoryId,this._versionDescriptor,u,!0)}}}("ImageTransformer"),function(e){x=t[e]={};function i(e,t,n,i,r){try{i=decodeURIComponent(i)}catch(e){}return(0,M.getGitFileContentUrl)(e,t,n,r,i,!0,!0)}function p(e,t,n,i=!1){if(l(t,(0,r.combineUrlPaths)(n,"/.attachments")))return!0;if(i){const n=(0,c.format)(".{0}",P.getFileExtension(t));return!(-1===o.PathConstants.AllowedAttachmentFileTypes(e).indexOf(n.toUpperCase()))}return!1}function l(e,t){return e.substr(0,t.length)===t}function h(e){const t=e.indexOf("#"),n=e.split("#");return t>0&&!!n[0]&&!!n[1]}function d(e){return(0,n.isExternalUrl)(e)?e:e.replace(o.UrlEscapeConstants.HyphenRegExp,o.UrlEscapeConstants.SpaceEncoding)}t[e].LinkTransformer=class{constructor(e,t,n,i,r,o,s){this._pageContext=e,this._projectId=t,this._repositoryId=n,this._wikiMappedPath=i,this._isHostedOutsideWikiHub=r,this._wikiIdentifier=o,this._wikiVersion=s}transformLink(e,t="",o){if((0,n.isAbsoluteUrl)(e)||(0,n.isSafeProtocol)(e)||(0,C.isInternalAnchorLink)(e))return e;const u=e.split("#");let m=u[0];const g=u[1],_=(0,s.removeMdExtensionFromPagePath)((0,s.getGitItemPath)(t,this._wikiMappedPath)),f="/"===this._wikiMappedPath?this._wikiMappedPath:this._wikiMappedPath+"/",k=(0,c.startsWith)(m,"/")||(0,c.startsWith)(m,"/.attachments".substr(1))?f:_,w=m&&"/"===m.charAt(0)?m.substr(1):m,M=P.combine(k,w),S=P.getFileExtension(M),x=(0,c.format)(".{0}",S),y=x&&".md"===x.toLowerCase(),v=!(0,c.startsWith)(M,f);if(y){if(l(M,(0,r.combineUrlPaths)(this._wikiMappedPath,"/.attachments"))||l(M,(0,r.combineUrlPaths)(this._wikiMappedPath,"/.templates"))||v)return i(this._pageContext,this._projectId,this._repositoryId,M,this._wikiVersion)}else{if(p(this._pageContext,M,this._wikiMappedPath,!0))return i(this._pageContext,this._projectId,this._repositoryId,M,this._wikiVersion);if(!S&&v)return i(this._pageContext,this._projectId,this._repositoryId,M+".md",this._wikiVersion)}if(o){const e=o(m.toLocaleLowerCase());e&&(m=e.path)}const T={},b=m&&"/"===m.charAt(0)?m.substr(1):m;let I,R=P.combine(k,b);R="/"!==this._wikiMappedPath?R.substr(this._wikiMappedPath.length):R,R=(0,s.removeMdExtensionFromPagePath)(R);const E=d(R);try{I=decodeURIComponent(E)}catch(e){I=E}if(T.pagePath=I,g&&h(e))try{T.anchor=decodeURIComponent(g.toLowerCase())}catch(e){T.anchor=g.toLowerCase()}return this._isHostedOutsideWikiHub?(T.wikiIdentifier=this._wikiIdentifier,(0,C.getExternalWikiHubPageUrl)(this._pageContext,T)):(0,a.getPagePathBasedUrlAndState)(this._pageContext,T,{wikiIdentifier:this._wikiIdentifier,wikiVersion:this._wikiVersion&&(0,a.getVersionFromBranchName)(this._wikiVersion.version)}).url}},t[e]._getAttachmentFileContentUrl=i,t[e]._isWikiAttachment=p,t[e]._isPathInGivenFolder=l,t[e]._isDeepAnchorLink=h,t[e]._getEscapedInternalWikiLink=d}("LinkTransformer"),function(e){var n;y=t[e]={},function(e){e.Off=1,e.On=2}(n=t[e].PreviewMode||(t[e].PreviewMode={}));function i(e,t){return`<img src="${e.getService("IVssLocationService").getAssetLocation((0,r.combineUrlPaths)("ms.vss-wiki-web/wiki-renderer-content/images/",t))}"></img>`}function o(e){const t=e.split(/(\s+)/).filter((e=>e.trim().length>0));return t.length>0?t[0]:""}function s(e){const t=e.split(/(\s+)/).filter((e=>e.trim().length>0));return t.length>0?t.slice(1).join(" "):""}function a(e,t,n){let i=s(e[t].info);for(let r=t+1;r<n;r++)r>t+1&&r<n-1&&""===e[r].content?i+="\n":i+=e[r].content;return i}function p(e,t,n){const i=e.getService("IVssContributionService"),r=i.getContributionChildren(t),o=[];if(r&&r.length>0){const e=i.getContributionsByType(n);for(const t of r){const i=e[t];i&&o.push({description:"",id:t,properties:i,includes:[],targets:[],type:n})}}return o}function h(e,t,n){let i;for(i=n+1;t[n].level!==t[i].level||t[i].type!=="container_"+e+"_close";i++)t[i].type=l.MarkdownConstants.MaskedTokenType;return t}t[e].MarkdownSyntaxExtensionProvider=class{constructor(e,t,r){this._pageContext=e,this._viewModeObj=t,this._className=r,this._elementInstanceMap=new Map,this._keywordContributionMap=new Map,this._seenKeywordsSet=new Set,this.name="markdownExtension",this.createContributionsHosts=()=>{this._seenKeywordsSet.forEach(this._createContributionHosts)},this.fetchMarkdownSyntaxContributors=e=>{let t=p(this._pageContext,"ms.vss-tfs-web.markdown-extension-syntax","ms.vss-tfs-web.markdown-extension");if(e){const n=p(this._pageContext,e,"ms.vss-tfs-web.markdown-extension");t=t.concat(n)}return this._buildContributionsMap(t),t},this.render=(e,t)=>{if(1===e[t].nesting)return this._curentKeyWord=o(e[t].info),this._seenKeywordsSet.add(this._curentKeyWord),this._currentElementId=(0,c.newGuid)(),this._currentTokenIndex=t,e=h(this.name,e,t),`<DIV class=${this._curentKeyWord} id=${this._currentElementId}>`;{const r=a(e,this._currentTokenIndex,t),o=this._keywordContributionMap.get(this._curentKeyWord),s=this._elementInstanceMap.get(this._currentElementId);return s?s.data=r:this._elementInstanceMap.set(this._currentElementId,{data:r}),this._viewModeObj.getViewMode()===n.On&&o&&o.properties.previewSrc?i(this._pageContext,o.properties.previewSrc)+"</DIV>":"</DIV>"}},this.validate=e=>{const t=o(e);return!!t&&this._keywordContributionMap.has(t)},this._buildContributionsMap=e=>{e.forEach((e=>{this._keywordContributionMap.set(e.properties.keyword,e)}))},this._createContributionHosts=e=>{const t=this._keywordContributionMap.get(e),i=document.querySelectorAll(`${this._className} .${e}`);for(let e=0;e<i.length;e++){const r=i[e],o=this._elementInstanceMap.get(r.id);this._elementInstanceMap.delete(r.id),o&&!o.instance&&t&&this._createLegacyContributionsControl(r,t).then((e=>{o.instance=e,e.sendContent(o.data||"",this._viewModeObj.getViewMode()===n.On,this._pageContext)}))}},this._createLegacyContributionsControl=(e,t)=>{const n=this._pageContext.getService("ILegacyPlatformService");return this._contributedControlHelperModulePromise||(this._contributedControlHelperModulePromise=n.requireModules(["Wiki/Scripts/ContributedControlHelper"])),this._contributedControlHelperModulePromise.then((([n])=>n.createContributedControl(e,t)))}}},t[e]._getPreview=i,t[e]._extractKeyWord=o,t[e]._removeKeyWord=s,t[e]._extractContent=a,t[e]._getContributionsForTarget=p,t[e]._modifyContainerTokens=h}("MarkdownSyntaxExtensionProvider"),function(e){v=t[e]={};t[e].MentionSyntaxProcessor=class{constructor(e){const t=e.getService("ILegacyPlatformService");this._legacyMentionSyntaxProcessorPromise=t.requireModules(["Mention/Scripts/MentionSyntaxProcessor","Mention/Scripts/TFS.Mention.WorkItems.Registration","Mention/Scripts/TFS.Mention.People.Registration"]).then((([e])=>new e.MentionSyntaxProcessor))}preProcess(e){return this._legacyMentionSyntaxProcessorPromise.then((t=>t.preProcess(e)))}postProcess(e){return this._legacyMentionSyntaxProcessorPromise.then((t=>t.postProcess(e)))}}}("MentionSyntaxProcessor"),function(e){T=t[e]={};t[e].TemplateProcessor=class{constructor(e,t){this._pageContext=e,this._wikiMarkdownRendererBridge=t,this._renderer=void 0,this._isPageTemplateFree=!0,this.name="template",this.marker=":",this.render=(e,t)=>{if("container_template_open"===e[t].type)this._handleTemplateFreePage(e),e=function(e,t){for(let n=t+1;e[t].level!==e[n].level||"container_template_close"!==e[n].type;n++)e[n].type=l.MarkdownConstants.MaskedTokenType;return e}(e,t);else{const n=function(e,t){for(let n=t-1;n>=0;n--)if(e[t].level===e[n].level&&"container_template_open"===e[n].type)return n;return-1}(e,t),i=p(this._templateDefRE,e[n].info);this._templateContentProvider.downloadTemplate(i)}return`<div>${e[t].markup}${e[t].info}</div>`},this.fetchUpdatedMarkdown=(e,t)=>{if(e&&t)if(this._templateContentProvider.updateTemplateContentAndSourceMap(this._getRenderer().parse(e),t),this._templateContentProvider.isSourceMapForTemplateEmpty(t))this._isPageTemplateFree=!0;else{if(this._templateContentProvider.areAllTemplatesDownloaded())return this._templateContentProvider.constructContent(e,t);this._templateContentProvider.downloadPendingTemplates()}},this.validate=e=>Boolean(e.match(this._templateDefRE)),this._getRenderer=()=>(this._renderer||(this._renderer=this._wikiMarkdownRendererBridge.createMarkdownRenderer()),this._renderer),this._handleTemplateFreePage=e=>{this._isPageTemplateFree&&(this._isPageTemplateFree=!1,this._templateContentProvider.updateTemplateContentAndSourceMap(e,this._wikiPagePath),this._updatedMdRendererContentIfNeeded())},this._updatedMdRendererContentIfNeeded=()=>{this._templateContentProvider.areAllTemplatesDownloaded()&&this._updateMdRendererContent()},this._updateMdRendererContent=()=>{this._wikiMarkdownRendererBridge._updateContent(this._templateContentProvider.constructContent(this._props.content,this._wikiPagePath,""))},this._templateDefRE=new RegExp(`^\\s*(${this.marker}{3})?\\s*${this.name}\\s+([^\\s]+)\\s*$`);const i=this._props.wiki?this._props.wiki.id:this._props.wikiIdentifier?this._props.wikiIdentifier:this._props.repositoryId;this._templateContentProvider=new n(this._pageContext,this._props.projectId,i,this._props.wikiVersion,this._templateDefRE,this._getRenderer,this._updateMdRendererContent)}get _props(){return this._wikiMarkdownRendererBridge.getProps()}get _wikiPagePath(){return this._props.pagePath||""}};class n{constructor(e,t,n,l,u,m,g){this._pageContext=e,this._projectId=t,this._wikiIdentifier=n,this._wikiVersion=l,this._templateDefRE=u,this._markdownRenderer=m,this._onAllTemplatesDownloaded=g,this._templateContentMap={},this._templatesRequested={},this._templateSourceMap={},this.constructContent=(e,t,n="")=>{let i=function(e,t,n){let i,o,s=e;const p=function(e){const t=/^\s*([0-9a-zA-Z_]+)[\s]*\:[\s]*\"([\s\S]*)\"\s*$/,n=/^\s*\"([\s\S]*)\"\s*$/,i=[];let r="",o=0;e=" "+e;for(let s=1;s<e.length;s++)if('"'===e[s]&&"\\"!==e[s-1]){if(!(o<2))return[];o+=1,r+=e[s]}else if(","===e[s]&&2===o){const e=t.exec(r)||n.exec(r);if(!e)return[];i.push(e),r="",o=0}else r+=e[s];const s=t.exec(r)||n.exec(r);if(s)return i.push(s),i;return[]}(t);for(let e=0;e<p.length;e++)p[e].length>2?(i=p[e][1],o=p[e][2]):(i=(e+1).toString(),o=p[e][1]),s=s.replace(new RegExp("\\{\\{\\{\\s*"+i+"\\s*\\}\\}\\}","g"),o),s=s.replace(new RegExp("\\{\\{\\{\\s*"+i+'\\s*\\|\\s*\\"(?:[^"\\\\]|\\\\.)*\\"\\s*\\}\\}\\}',"g"),o);if(s=function(e){const t=/\{\{\{\s*[0-9a-zA-Z_]+\s*\|([\s\S]*?)\}\}\}/g,n=e;let i;for(;i=t.exec(n);){const t=i[1].trim();a(t)&&(e=e.replace(i[0],t.substr(1,t.length-2)))}return e}(s),function(e,t){if(e.length!==t.length)return!1;for(let n=0,i=e.length;n<i;++n)if(e[n].type!==t[n].type)return!1;return!0}(r(n,e),r(n,s)))return s;return e}(e,n,this._markdownRenderer()).split("\n");if(t in this._templateSourceMap){const e=this._templateSourceMap[t].length;for(let n=0;n<e;n++){let e="";const r=this._templateSourceMap[t][n],o=i[r[0]];if(o){for(let t=r[0]+1;t<r[1];t++)e+=i[t]+"\n",i[t]=void 0;const t=p(this._templateDefRE,o);i[r[0]]=this.constructContent(this._templateContentMap[t]||"",t,e),i[r[1]]=void 0}}i=i.filter((e=>void 0!==e))}return i.join("\n")},this.downloadTemplate=e=>{this._templatesRequested[e]||(this._setTemplateContent(e,void 0),this._templatesRequested[e]=!0,(0,s.isInclude)(e)?(0,h.getWikiClient)(this._pageContext).getPageText(this._projectId,this._wikiIdentifier,(0,s.removeMdExtensionFromPagePath)((0,s.decodeHyphenAndSpacesInPath)(e)),0,this._wikiVersion,!0).then((t=>{if(t){this._templateContentMap[e]||this._setTemplateContent(e,t);const n=r(this._markdownRenderer(),t);n.length&&(this._cycleDetectionHelper.addEdges(n,e,(e=>{this._setTemplateContent(e,d((0,c.format)(w.TemplatesCycleDetectedMessage,e))),this._templateSourceMap[e]=[]})),this._downloadNestedTemplates(n),e in this._templateSourceMap||this._addTemplatesEntriesToSourceMap(e,n)),this._notifyIfAllTemplatesDownloaded()}}),(()=>{this._setTemplateContent(e,d((0,c.format)(w.TemplateNotFoundMessage,e))),this._notifyIfAllTemplatesDownloaded()})):(this._setTemplateContent(e,d((0,c.format)(w.TemplateNotFoundMessage,e))),this._notifyIfAllTemplatesDownloaded()))},this.areAllTemplatesDownloaded=()=>{for(const e in this._templateContentMap)if(!this._templateContentMap[e])return!1;return!0},this.downloadPendingTemplates=()=>{for(const e in this._templateContentMap)this.downloadTemplate(e)},this.isSourceMapForTemplateEmpty=e=>{const t=this._templateSourceMap[e];return t&&0===t.length},this.updateTemplateContentAndSourceMap=(e,t)=>{const n=o(e);this._addTemplatesEntriesToSourceMap(t,n),n.forEach((e=>{const t=p(this._templateDefRE,e.info);t in this._templateContentMap||(this._templateContentMap[t]=void 0)}))},this._notifyIfAllTemplatesDownloaded=()=>{this.areAllTemplatesDownloaded()&&this._onAllTemplatesDownloaded()},this._addTemplatesEntriesToSourceMap=(e,t)=>{this._templateSourceMap[e]=t.map((e=>e.map))},this._downloadNestedTemplates=e=>{e.forEach((e=>{const t=p(this._templateDefRE,e.info);this._templateContentMap[t]||this.downloadTemplate(t)}))},this._cycleDetectionHelper=new i(this._templateDefRE)}_setTemplateContent(e,t){this._templateContentMap[e]=t}}class i{constructor(e){this._templateDefRE=e,this._edges={},this.addEdges=(e,t,n)=>{e.forEach((e=>{const i=p(this._templateDefRE,e.info);void 0===this._edges[i]?this._edges[i]=[t]:-1===this._edges[i].indexOf(t)&&this._edges[i].push(t),this._detectCycle(i)&&n(i)}))},this._detectCycle=e=>{const t=[e],n={};for(n[e]=!0;0!==t.length;){const i=t.pop();if(i&&this._edges[i])for(let r=0;r<this._edges[i].length;r++){const o=this._edges[i][r];if(n[o]){if(e===o)return!0}else t.push(o),n[o]=!0}}return!1}}}function r(e,t){const n=e.parse(t),i=[];return o(n).forEach((e=>{i.push(e)})),i}function o(e){return e.filter((e=>"container_template_open"===e.type))}function a(e){if(e.length>1&&'"'===e[0]&&'"'===e[e.length-1]){for(let t=1;t<e.length-1;t++)if('"'===e[t]&&"\\"!==e[t-1])return!1;return!0}return!1}function p(e,t){const n=t.match(e);return n&&n.length>=3?function(e){""===(e=e.trim())||(0,c.endsWith)(e,".md",!0)||(e+=".md");return e}(n[2]):""}function d(e){const t=document.createElement("span");return t.className="secondary-text",t.innerText=e,t.outerHTML}}("TemplateProcessor"),function(e){b=t[e]={};t[e].WikiPagesSource=class{constructor(e){this._pageContext=e}getPageInfo(e,t,n){return(0,h.getWikiClient)(this._pageContext).getPage(e.projectId,e.id,t,0,n,!0).then((e=>Object.assign(Object.assign({},e.page),{version:e.eTag[0]})))}savePage(e,t,n,i,r){return this._pageContext.getService("ILegacyPlatformService").requireModules(["Mention/Scripts/TFS.Mention"]).then((([o])=>(0,h.getWikiClient)(this._pageContext).createOrUpdatePage({content:o.MentionProcessor.getDefault().translateDisplayNamesToStorageKeysOfPersonMentions(n)},e.projectId,e.id,t,i,r)))}getPageAndSubPages(e,t,n,i=4){return(0,h.getWikiClient)(this._pageContext).getPage(e.projectId,e.id,t,i,n).then((e=>(0,d.flattenWikiPage)(e.page)))}}}("SourcesWikiPageSource"),function(e){var n;t[e]={},function(e){e.Off=1,e.On=2}(n=t[e].PreviewMode||(t[e].PreviewMode={}));class i extends k.VssComponent{constructor(e,t){super(e,t),this._markdownRendererComponentRef=u.createRef(),this._sourceReplacedWithTemplateContent=void 0,this._getSubPages=()=>{if(!(0,p.isFeatureFlagEnabled)(this.context.pageContext,"Wiki.TableOfSubPages",!1)||!this.props.wikiPages)return;const e=this.props.wikiPages.find((e=>e.path==this.props.pagePath));if(e){if(this.props.content.includes(l.MarkdownConstants.TOSPDefaultMarker)){const t=this.props.pagePath,n=this._loadedSubPages.has(t)&&this._loadedSubPages.get(t);if(0==e.subPages.length&&!n){const n=this.props.wiki,i=this.props.wikiVersion;this._wikiPagesSource.getPageAndSubPages(n,t,i,120).then((t=>{t.length>0&&(e.subPages=t[0].subPages,this.forceUpdate())})),this._loadedSubPages.set(t,!0)}}return this._toISubPages(e.subPages)}return[]},this._toISubPages=e=>e.sort(((e,t)=>e.order-t.order)).map((e=>({name:this._getPageNameFromPath(e.path),remoteUrl:e.remoteUrl,subPages:this._toISubPages(e.subPages)}))),this._getPageNameFromPath=e=>{const t=e.match(/\/([^\/]*)$/);let n=e;return null!=t&&(n=t.pop()||n),n},this._onMarkdownLinesMappingComplete=e=>{this._markdownLineMapping=e,this.props.onMarkdownLinesMappingChanged&&this.props.isSyncScrollEnabled&&this.props.onMarkdownLinesMappingChanged(e)},this._onUpdateContent=e=>{this._sourceReplacedWithTemplateContent=e,this.forceUpdate()},this._scrollToAnchorHandler=e=>{let{anchor:t}=this.props;if(!t){const e=window.location.href,n=e.indexOf("#");n>-1&&(t=e.substring(n+1,e.length))}if(t)(0,C.scrollToAnchor)(t),(0,C.focusAnchor)(t);else if(!e&&this.props.scrollToElementClassName){const e=document.getElementsByClassName(this.props.scrollToElementClassName);e.length>0&&(e[0].scrollTop=0)}},this._getViewMode=()=>this.props.viewMode&&this.props.viewMode!==n.Off?y.PreviewMode.On:y.PreviewMode.Off,this._injectExtensionMarkup=()=>{this._markdownSyntaxExtensionProvider.createContributionsHosts(),this._getMentionsModulesPromise().then((([e,t])=>{const n={SourcePageArea:"Wiki",wikiType:(0,a.getWikiTypeString)(this.props.wiki?this.props.wiki.type:0),newWiki:!0};e.PeopleMentionsRenderingProvider.registerMentionClickHandler(this._markdownContainerRef.current,n),t.WorkItemMentionsRenderingProvider.registerMentionClickHandler(this._markdownContainerRef.current,n,((e,t)=>(0,f.onClickFPS)(this.context.pageContext,e,!0,t)))})),this._getViewMode()==y.PreviewMode.Off&&this._scrollToAnchorHandler(!0)},this._getMentionsModulesPromise=()=>{if(!this._mentionsModulesPromise){const e=this.context.pageContext.getService("ILegacyPlatformService");this._mentionsModulesPromise=this.trackPromise(e.requireModules(["Mention/Scripts/TFS.Mention.People","Mention/Scripts/TFS.Mention.WorkItems"])).promise}return this._mentionsModulesPromise},this._linkClickHandler=e=>{const t=e.currentTarget,n=t&&t.attributes&&t.attributes.getNamedItem("href"),i=n?n.value:void 0;if(i&&(0,C.isInternalAnchorLink)(i,this.context.pageContext,this.props.wiki,this.props.pagePath,this.props.pageId))try{const e=0===i.indexOf("#"),n=new r.Uri(i),s=e?decodeURIComponent(i.substring(1)).toLowerCase():n.getQueryParam(o.UrlConstants.AnchorParam)||void 0;if(this.props.skipInternalLinkTransformation&&(t.href="#"+s),s)return s===this.props.anchor?this._scrollToAnchorHandler():this.props.onAnchorClick&&this.props.onAnchorClick(s),!1}catch(e){}return s(this.context.pageContext,e)},this._transformImageUrl=e=>this._imageTransformer.transformImage(e,this.props.unsavedAttachmentsMap,this.props.pagePath),this._transformLinkUrl=e=>this._linkTransformer.transformLink(e,this.props.pagePath,this.props.getWikiPage),this._transformLinkStyle=(e,t)=>{if(this.props.getWikiPage){const n=h(this.context.pageContext);return c(e,this.props.getWikiPage,n,t)}return[]},this._createMarkdownRendererForTemplates=()=>{const e={containerOptions:this._containerOptions};return new m.MarkdownRenderer(this.context.pageContext,e)},this._loadedSubPages=new Map;let i="/";this._shouldHonorLineBreak=!0;const d=e.wiki;d&&(i=d.mappedPath,this._shouldHonorLineBreak=0===d.type),this._imageTransformer=new S.ImageTransformer(this.context.pageContext,this.props.projectId,this.props.repositoryId,this.props.wikiVersion,i),this._linkTransformer=new x.LinkTransformer(this.context.pageContext,this.props.projectId,this.props.repositoryId,i,this.props.isHostedOutsideWikiHub,this.props.wikiIdentifier||this.props.wiki&&this.props.wiki.name,this.props.wikiVersion),this._mentionSyntaxProcessor=new v.MentionSyntaxProcessor(this.context.pageContext),this._containerOptions=[],(0,p.isFeatureFlagEnabled)(this.context.pageContext,"WebAccess.Wiki.TemplateSupport",!1)&&(this._templateProcessor=new T.TemplateProcessor(this.context.pageContext,{_updateContent:this._onUpdateContent,createMarkdownRenderer:this._createMarkdownRendererForTemplates,getProps:()=>this.props}),this._containerOptions.push(this._templateProcessor)),this._markdownSyntaxExtensionProvider=new y.MarkdownSyntaxExtensionProvider(this.context.pageContext,{getViewMode:this._getViewMode},".wiki-md-container"),this._markdownSyntaxExtensionProvider.fetchMarkdownSyntaxContributors("ms.vss-wiki-web.wiki-markdown-extension-syntax"),this._containerOptions.push(this._markdownSyntaxExtensionProvider),this._isCreateWitAllowed=void 0!==this.props.handleEmbedWorkItem&&(0,p.isFeatureFlagEnabled)(this.context.pageContext,"Wiki.SelectAndCreateWorkItems",!1),this._markdownContainerRef=e.markdownContainerRef?e.markdownContainerRef:u.createRef(),this._wikiPagesSource=new b.WikiPagesSource(t.pageContext)}componentDidMount(){super.componentDidMount(),this._scrollToAnchorHandler(!0)}UNSAFE_componentWillReceiveProps(e){this._templateProcessor&&this.props.content!==e.content&&(this._sourceReplacedWithTemplateContent=this._templateProcessor.fetchUpdatedMarkdown(e.content,e.pagePath))}componentDidUpdate(e,t){super.componentDidUpdate(e,t),this.props.anchor!==e.anchor&&this._scrollToAnchorHandler()}render(){const{className:e,content:t,onInitialRender:n,wiki:i,getWikiPage:r}=this.props;return u.createElement(u.Fragment,null,u.createElement("div",{className:(0,k.css)("wiki-md-container",e),ref:this._markdownContainerRef},u.createElement(g.MarkdownRendererComponent,{ref:this._markdownRendererComponentRef,className:"markdown-render-area body-m",customSyntaxProcessor:this._mentionSyntaxProcessor,rawContent:this._sourceReplacedWithTemplateContent||t,linkClickHandler:this._linkClickHandler,previewMode:this.props.viewMode,options:{breaks:this._shouldHonorLineBreak,containerOptions:this._containerOptions,html:!0,enableHeaderAnchorSharing:!0,enableYaml:!0,imageUrlTransformer:this._transformImageUrl,linkTransformer:this._transformLinkUrl,linkCustomStyleAppender:r?this._transformLinkStyle:void 0,enableMarkdownLinesMapping:this._isCreateWitAllowed||this.props.isSyncScrollEnabled,onMarkdownLinesMappingComplete:this._isCreateWitAllowed||this.props.isSyncScrollEnabled?this._onMarkdownLinesMappingComplete:void 0,subPages:this._getSubPages()},onInitialRender:n,injectExtensionMarkup:this._injectExtensionMarkup})),this._isCreateWitAllowed&&u.createElement(k.WrappedComponent,{wrappedType:"Wiki.CreateWitMenu",dependencies:["ms.vss-wiki-web.wiki-create-wit-content","ms.vss-work-web.new-workitem-data-provider"],markdownContent:this.props.content,getMarkdownLinesMapping:()=>this._markdownLineMapping,handleEmbedWorkItem:this.props.handleEmbedWorkItem,handleEmbedWorkItemFailure:this.props.handleEmbedWorkItemFailure,hasTemplates:()=>this._sourceReplacedWithTemplateContent&&this._sourceReplacedWithTemplateContent!==this.props.content}))}getRenderedContent(){return this._markdownRendererComponentRef.current?this._markdownRendererComponentRef.current.getRenderedContent():void 0}}function s(e,t){const n=t.currentTarget.href,i=h(e);return!(!n||!(0,C.isUrlExternalToWiki)(n,i))||(0,C.wikiLinkOnClickEventHelper)(t,(()=>(0,f.onClickFPS)(e,n,!0,t)))}function c(e,t,n,i){return i&&i.split(" ").indexOf(_.AnchoredHeaders.shareHeaderAnchorClassName)>=0?[]:(0,C.isBrokenLink)(e,t,n)?["wiki-broken-link"]:[]}function h(e){const t=e.getService("IVssHistoryService");return t.generateUrl(t.getCurrentRouteValues(),2)}t[e].WikiMarkdownRenderer=i,t[e]._handleWikiLinkClick=s,t[e]._transformLinkStyle=c,t[e]._getCurrentUrl=h,k.VssComponent.register("TFS.WikiMarkdownRenderer",i)}("WikiMarkdownRenderer")}),["Resources","Helpers","VCPathHelper","VCUrlHelper","ImageTransformer","LinkTransformer","MarkdownSyntaxExtensionProvider","MentionSyntaxProcessor","TemplateProcessor","Sources/WikiPageSource","WikiMarkdownRenderer"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-wiki-web.wiki-renderer-content"}}));