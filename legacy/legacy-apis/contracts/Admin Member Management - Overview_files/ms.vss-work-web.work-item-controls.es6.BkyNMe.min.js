"use strict";define("Wit/Common/WorkItemControls",["require","exports","VSS/Core/Observable","react","VSSUI/Components/Dropdown/Dropdown","VSSUI/Dropdown","VSSUI/EditableDropdown","VSSUI/ListBox","VSSUI/Spinner","VSSUI/Table","VSSUI/TooltipEx","VSSUI/TreeEx","VSSUI/Util","VSSUI/Utilities/DropdownSelection","Tfs/Platform/Page","VSS/Platform/Layout","VSSUI/DatePicker","VSSUI/Dialog","Wit/Common/DateUtils","VSS/Core/Util/String","VSS/Platform/Util/Storage","VSSUI/Button","VSSUI/Callout","VSSUI/SplitButton","VSSUI/TextField","Wit/UI/WorkItemTypeIcon","VSS/Features/Identities/IdentityPickerProvider","VSSUI/IdentityPicker","Wit/Common/Generated/Constants","Wit/Common/Utilities/FormatUtils","Wit/Common/Utilities/Identity","Wit/Common/WITMeMacroPeoplePickerProvider","Wit/Common/WorkItemFieldService/IWorkItemFieldService2","Wit/Identity/Utilities/WorkItemIdentityHelper"],(function(e,t,n,o,a,l,r,i,s,c,d,u,m,p,v,f,b,g,I,y,w,S,C,h,N,x,T,D,k,E,P,O,A,V){var W,L,F,U,j,B,R,M;W=t[M="Resources"]={},t[M].AddAtSelection="Add at selection",t[M].AddToBottom="Add to bottom",t[M].AddToTop="Add to top",t[M].Cancel="Cancel",t[M].ChangeDestination="Change destination",t[M].Loading="Loading...",t[M].NewWorkItemDropdownAriaLabel="Select new work item type.",t[M].Ok="OK",t[M].SelectDate="Select Date",t[M].SuggestionsHeader="Suggestions",t[M].EnterNewItemNameAriaLabel="{0} name",function(e){L=t[e]={},t[e].FutureDate=new Date(2533707648e5)}("Constants"),function(e){F=t[e]={};t[e].NodeTreeItemProvider=class{constructor(e,t){this.itemCollection=new n.ObservableCollection,this.itemCollection.push(e),this.itemCollection.push(t)}get length(){return this.itemCollection.length}get value(){return this.itemCollection.value}subscribe(e,t){return this.itemCollection.subscribe(e,t)}unsubscribe(e,t){return this.itemCollection.unsubscribe(e,t)}}}("NodeTreeItemProvider"),function(e){U=t[e]={},t[e].convertNodesToListBoxItems=function a(l,r){const i={id:l.identifier,data:l,parent:r,text:o(l.path)},s=[i];if(l.hasChildren){const o=0===l.structureType?n:t[e].compareIterations,r=[...l.children].sort(o);for(const e of r)s.push(...a(e,i))}return s};const n=(e,t)=>e.name.localeCompare(t.name,navigator.language);function o(e,t="\\"){if(!e)return"";e.startsWith(t)&&(e=e.substring(1));const n=e.split("\\");return n.splice(1,1),n.join(t)}t[e].compareIterations=(e,t)=>{const n=e.attributes&&e.attributes.startDate||L.FutureDate,o=t.attributes&&t.attributes.startDate||L.FutureDate;return n!==o?n.getTime()-o.getTime():e.name.localeCompare(t.name,navigator.language)},t[e].normalizePath=o,t[e].isEmpty=function(e){return!e||Object.getPrototypeOf(e)===Object.prototype&&0===Object.keys(e).length}}("NodeUtils"),function(e){j=t[e]={},t[e].NodeTreeDropdown=o.forwardRef(((e,t)=>{const{additionalColumns:s,items:c,mruNodes:d,onSetPath:u,onValueChange:m,selectedText:f}=e,b=__rest(e,["additionalColumns","items","mruNodes","onSetPath","onValueChange","selectedText"]),g=e.additionalColumns?[...v,...e.additionalColumns]:v,[w]=(0,n.useObservableArray)(I(c.value,null==d?void 0:d.value)),S=o.useRef(new F.NodeTreeItemProvider(w,c)),C=o.useRef(new Map),h=o.useRef(new p.DropdownSelection),N=e=>{const t=S.current.value.filter((e=>(0,i.isListBoxItemVisible)(e))).findIndex((t=>!y(t)&&t.text===e));t>-1&&h.current.select(t)},x=()=>{if(!f)return;const e=n.ObservableLike.getValue(f),t=c.value.find((t=>t.text===e));let o=null==t?void 0:t.parent;for(;o;)o.expanded=!0,C.current.set(o.id,!0),o=o.parent;N(e)},T=()=>{w.value=I(c.value,null==d?void 0:d.value);for(const e of c.value){const t=C.current.get(e.id);void 0!==t&&(e.expanded=t)}x()};return o.useEffect((()=>{const e=c.subscribe(T),t=null==d?void 0:d.subscribe(T),o=n.ObservableLike.isObservable(f)&&f.subscribe(x);return()=>{c.unsubscribe(e),d&&t&&d.unsubscribe(t),o&&n.ObservableLike.isObservable(f)&&f.unsubscribe(o)}}),[c,d,f]),o.useEffect(x,[f]),o.createElement(r.EditableDropdown,Object.assign({allowClear:!1,allowTextSelection:!0,className:"node-tree-dropdown",columns:g,filterMatchedItem:e=>(0,a.filterMatchedItemByListboxType)(e)&&!y(e),items:S.current,onToggle:(e,t)=>{if(t.expanded=!t.expanded,C.current.set(t.id,t.expanded),!f)return;const o=n.ObservableLike.getValue(f);N(o)},onValueChange:e=>{if(u)if((0,U.isEmpty)(null==e?void 0:e.data))(null==e?void 0:e.text)?u(null==e?void 0:e.text):u("");else{const t=e.data.path;u((0,U.normalizePath)(t))}m&&m(e)},ref:t,renderCallout:e=>o.createElement(l.DropdownCallout,Object.assign({},e,{containerClassName:"node-tree-dropdown-callout"})),renderExpandable:e=>{const t=Object.assign({autoSelect:!0},e);return o.createElement(l.DropdownExpandableTextField,Object.assign({},t))},selectedText:f,selection:h.current,showTree:!0,minCalloutWidth:400},b))}));const v=[{id:"title",width:new n.ObservableValue(-100),renderCell:function(e,t,n,a){if(3===a.underlyingItem.data.type)return o.createElement(c.SimpleTableCell,{className:(0,m.css)(a.className,n.className),contentClassName:"divider-cell",columnIndex:t,colspan:2,key:a.underlyingItem.id,tableColumn:n},o.createElement("div",{className:"bolt-list-box-divider flex-grow"}));if(4===a.underlyingItem.data.type)return o.createElement(c.SimpleTableCell,{contentClassName:"loader-cell",columnIndex:t,colspan:2,key:t,tableColumn:n},o.createElement("div",{className:"bolt-list-box-loading"},o.createElement(s.Spinner,{size:"medium",label:W.Loading})));const l=a.underlyingItem,r=(0,U.isEmpty)(l.data.data)||y(l.data)?l.text:l.data.data.name;return o.createElement(u.ExpandableTreeCell,{className:(0,m.css)(a.className,n.className),columnIndex:t,key:`title-cell-${e}-${t}`,treeColumn:n,treeItem:a},o.createElement(d.Tooltip,{overflowOnly:!0},o.createElement("span",{className:"text-ellipsis"},r)))}}];const f={id:"suggestions-header",text:W.SuggestionsHeader,type:2},b={id:"suggestions-divider",type:3},g="mru-items";function I(e,t){if(!(null==t?void 0:t.length)||!e.length)return[];const n=[];for(const o of t){const t=e.find((e=>!(0,U.isEmpty)(null==e?void 0:e.data)&&e.data.id===o)),a=null==t?void 0:t.data;a&&n.push({id:`mru-${o}`,data:a,text:(0,U.normalizePath)(a.path),groupId:g})}return[f,...n,b]}function y(e){return e.groupId===g}}("NodeTreeDropdown"),function(e){B=t[e]={},t[e].AreaPathDropdown=o.forwardRef(((e,t)=>{var a;const{items:l,macros:r,onSetPath:s,onValueChange:c,projectId:d,selectDefaultValue:u}=e,m=__rest(e,["items","macros","onSetPath","onValueChange","projectId","selectDefaultValue"]),{pageContext:p}=(0,f.useComponentContext)(),b=(0,v.getTFSPageData)(p),g=o.useRef([]),I=r&&((0,i.wrapListBoxItems)(r)||r),y=n.ObservableLike.isObservable(l)?l:new n.ObservableArray(null!==(a=l)&&void 0!==a?a:I),[w]=(0,n.useObservableArray)([]),S=o.useRef(new n.ObservableArray(y.value.concat(g.current)));return o.useEffect((()=>{S.current.value=y.value.concat(g.current)}),[y.length]),o.useEffect((()=>{l?u&&y.length&&y.value[0].text&&(null==s||s(y.value[0].text)):(async()=>{var e;const t=null!=d?d:null===(e=null==b?void 0:b.project)||void 0===e?void 0:e.id;if(!l&&t){const e=p.getService("IWorkItemNodeService"),n=await e.getAreaPathNodes(t);n&&(g.current=(0,U.convertNodesToListBoxItems)(n),S.current.value=y.value.concat(g.current),u&&(null==s||s((0,U.normalizePath)(n.path))))}})(),(async()=>{var e;const t=null!=d?d:null===(e=null==b?void 0:b.project)||void 0===e?void 0:e.id;if(t){const e=p.getService("IWorkItemNodeService");w.value=await e.getMruAreaPaths(t)}})()}),[d]),o.createElement(j.NodeTreeDropdown,Object.assign({allowFreeform:!!r,items:l?y:S.current,mruNodes:w,onValueChange:async e=>{var t;c&&c(e),null==s||s((null==e?void 0:e.text)||"");const n=null!=d?d:null===(t=null==b?void 0:b.project)||void 0===t?void 0:t.id;if(!n||(0,U.isEmpty)(null==e?void 0:e.data))return;const o=e.data,a=p.getService("IWorkItemNodeService");w.value=await a.updateMruAreaPaths(n,[o.id])},ref:t},m))}))}("AreaPathDropdown"),function(e){t[e]={},t[e].DatePickerDialog=function(e){const[t,n]=(0,o.useState)();return o.createElement(g.Dialog,{titleProps:{text:W.SelectDate},onDismiss:()=>e.onDismiss,footerButtonProps:[{text:W.Cancel,onClick:()=>e.onDismiss()},{text:W.Ok,onClick:()=>e.onDismiss(t),primary:!0}]},o.createElement("div",{className:"scroll-auto flex-grow flex-row"},o.createElement(b.DatePicker,{containerClassName:"full-width",onChange:e=>{n(e)},value:t})))}}("DatePickerDialog"),function(e){R=t[e]={},t[e].IterationDropdown=o.forwardRef(((e,t)=>{var l;const{items:r,macros:s,onValueChange:c,projectId:d}=e,u=__rest(e,["items","macros","onValueChange","projectId"]),{pageContext:m}=(0,f.useComponentContext)(),p=(0,v.getTFSPageData)(m),b=o.useRef([]),g=s&&((0,i.wrapListBoxItems)(s)||s),I=n.ObservableLike.isObservable(r)?r:new n.ObservableArray(null!==(l=r)&&void 0!==l?l:g),[y]=(0,n.useObservableArray)([]),w=o.useRef(new n.ObservableArray(I.value.concat(b.current)));return o.useEffect((()=>{w.current.value=I.value.concat(b.current)}),[I.length]),o.useEffect((()=>{r||(async()=>{var e;const t=null!=d?d:null===(e=null==p?void 0:p.project)||void 0===e?void 0:e.id;if(!r&&t){const e=m.getService("IWorkItemNodeService"),n=await e.getIterationNodes(t);n&&(b.current=(0,U.convertNodesToListBoxItems)(n),w.current.value=I.value.concat(b.current))}})(),(async()=>{var e;const t=null!=d?d:null===(e=null==p?void 0:p.project)||void 0===e?void 0:e.id;if(t){const e=m.getService("IWorkItemNodeService");y.value=await e.getMruIterations(t)}})()}),[d]),o.createElement(j.NodeTreeDropdown,Object.assign({allowFreeform:!!s,additionalColumns:a,items:r?I:w.current,mruNodes:y,onValueChange:async e=>{var t;c&&c(e);const n=null!=d?d:null===(t=null==p?void 0:p.project)||void 0===t?void 0:t.id;if(!n||(0,U.isEmpty)(null==e?void 0:e.data))return;const o=e.data,a=m.getService("IWorkItemNodeService");y.value=await a.updateMruIterations(n,[o.id])},ref:t},u))}));const a=[{id:"iteration-dates",width:new n.ObservableValue(-50),renderCell:function(e,t,n,a){var r;const i=null===(r=a.underlyingItem.data.data)||void 0===r?void 0:r.attributes,s=`iteration-dates-cell-${e}-${t}`;let u=null;if(i){const e=i.startDate,t=i.finishDate;if(e&&t){const n=`${l.format((0,I.getDateInUTC)(e))} - ${l.format((0,I.getDateInUTC)(t))}`;u=o.createElement(d.Tooltip,{overflowOnly:!0},o.createElement("span",{className:"text-ellipsis"},n))}}return o.createElement(c.SimpleTableCell,{className:(0,m.css)(n.className,a.className),columnIndex:t,contentClassName:"justify-end",key:s,tableColumn:n},u)}}],l=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"numeric",day:"numeric"})}("IterationDropdown"),function(e){t[e]={};const a="backlogStackRankDirection";function r(e){const{colorAndIcons:t,selectedType:n}=e,a=__rest(e,["colorAndIcons","selectedType"]),r=t.map((e=>({iconProps:{render:()=>o.createElement(x.WorkItemTypeIcon,{className:"margin-horizontal-8",data:e,suppressTooltip:!0})},id:e.workItemTypeName,text:e.workItemTypeName}))),i=new p.DropdownSelection,s=r.findIndex((e=>e.text===n));return s>-1&&i.select(s),o.createElement(l.Dropdown,Object.assign({containerClassName:"work-item-dropdown-container",ariaLabel:W.NewWorkItemDropdownAriaLabel,items:r,selection:i},a))}t[e].NewItemCallout=function({allowedPositions:e,anchor:t,colorAndIcons:l,getLocalStorageKeyForWorkItemType:i,getBacklogDefaultWorkItemTypeNameFetcher:c,onAddItem:d,onDismiss:u,keepOpenAfterAddingItem:m,workItemDropdownWidth:p}){if(0===l.length)return null;const[v]=(0,n.useObservable)("");(0,f.usePageContext)();let b=(0,w.tryGetLocalStorageValue)(a);(null==e?void 0:e.length)&&!e.some((e=>e===b))&&(b=e[0]);const g=e=>{D(e.id),(0,w.trySetLocalStorageValue)(a,e.id)},I=o.useMemo((()=>{const t=[];return e&&!e.some((e=>"top"===e))||t.push({id:"top",text:W.AddToTop,onActivate:g}),e&&!e.some((e=>"bottom"===e))||t.push({id:"bottom",text:W.AddToBottom,onActivate:g}),e&&!e.some((e=>"selection"===e))||t.push({id:"selection",text:W.AddAtSelection,onActivate:g}),t}),[e]),[T,D]=o.useState((()=>b||"top")),k=i?i():"new-item-callout-witType",E=(0,w.tryGetLocalStorageValue)(k),P=l.find((e=>e.workItemTypeName===E)),[O,A]=o.useState();o.useEffect((()=>{var e;if(P)A(P.workItemTypeName);else if(c){const{teamId:t,backlog:n}=null!==(e=c.context)&&void 0!==e?e:{};c.service.getBacklogDefaultWorkItemTypeName(t,n).then((e=>{A(l.find((t=>t.workItemTypeName===e))&&e||l[0].workItemTypeName)})).catch((()=>{A(l[0].workItemTypeName)}))}else A(l[0].workItemTypeName)}),[]);const V=e=>o.createElement(C.Callout,{anchorElement:t,anchorOrigin:{horizontal:"start",vertical:"end"},className:"new-item-callout",contentClassName:"flex-row flex-center padding-8 subtle-border depth-8",escDismiss:!0,focuszoneProps:{circularNavigation:!0,defaultActiveElement:".new-item-name-textbox",direction:1,focusOnMount:!0,handleTabKey:!0},lightDismiss:!0,onDismiss:u},e);if(!O)return V(o.createElement(s.Spinner,{size:"small"}));const L=()=>{null==d||d(v.value,O,T),m||u(),v.value=""},F={text:"top"===T?W.AddToTop:"bottom"===T?W.AddToBottom:W.AddAtSelection,onClick:L};return V(o.createElement(o.Fragment,null,1===l.length?o.createElement(x.WorkItemTypeIcon,{className:"margin-right-8",data:l[0],size:1}):o.createElement(r,{className:"margin-right-8",colorAndIcons:l,onSelect:(e,t)=>{A(t.text),(0,w.trySetLocalStorageValue)(k,t.text)},selectedType:O,width:p||150}),o.createElement(N.TextField,{autoFocus:!0,className:"new-item-name-textbox margin-right-8",ariaLabel:(0,y.format)(W.EnterNewItemNameAriaLabel,O),value:v,onChange:(e,t)=>v.value=t,onKeyPress:e=>"Enter"===e.key&&L()}),I.length>1?o.createElement(h.SplitButton,{primary:!0,buttonProps:F,menuButtonProps:{ariaLabel:W.ChangeDestination,contextualMenuProps:{menuProps:{id:"directionMenu",items:I}}}}):o.createElement(S.Button,Object.assign({primary:!0},F))))},t[e].WorkItemDropdown=r}("NewItemCallout"),function(e){t[e]={};t[e].WorkItemFieldControl=e=>{const{ariaLabel:t,className:n,disabled:r,fieldName:i,iterationMacros:d,initialValue:u,onChange:m}=e,p=(0,f.usePageContext)(),v=(0,A.getWorkItemFieldService)(p),[b,g]=o.useState(!1),[I,y]=o.useState((()=>{var t,n;let o=null!==(t=e.fieldEntry)&&void 0!==t?t:null===(n=e.field)||void 0===n?void 0:n.fieldDefinition;return!o&&i&&(o=v.getFieldByReferenceName(i)),o}));if(o.useEffect((()=>{if(!I&&i){(async()=>{g(!0),await v.loadFields();const e=v.getFieldByReferenceName(i);y(e),g(!1)})()}})),o.useEffect((()=>{e.fieldEntry&&y(e.fieldEntry)}),[e.fieldEntry]),b)return o.createElement(s.Spinner,null);const w=Object.assign(Object.assign({},e),{fieldEntry:I});return(null==I?void 0:I.isIdentity)?o.createElement(a,Object.assign({},w)):(null==I?void 0:I.type)===k.FieldType.DateTime?o.createElement(l,Object.assign({},w)):(null==I?void 0:I.referenceName)===k.CoreFieldRefNames.AreaPath?o.createElement(B.AreaPathDropdown,{ariaLabel:t,className:n,disabled:r,onSetPath:e=>{m&&m(e,e!==u)},selectedText:null==u?void 0:u.toString()}):(null==I?void 0:I.referenceName)===k.CoreFieldRefNames.IterationPath?o.createElement(R.IterationDropdown,{ariaLabel:t,className:n,disabled:r,macros:d,onSetPath:e=>{m&&m(e,e!==u)},selectedText:null==u?void 0:u.toString()}):o.createElement(c,Object.assign({},w))};const a=({ariaLabel:e,className:t,disabled:a,field:l,initialValue:r,onChange:i,useMacroMePickerProvider:s,excludeServicePrincipals:c,fieldEntry:d})=>{var u;const m=null===(u=null==l?void 0:l.filterByScope)||void 0===u?void 0:u.excludeGroups,{pageContext:p}=(0,f.useComponentContext)(),v=function(e,t){if(!t)return;"string"==typeof t&&(t=(0,V.convertWorkItemIdentityRefFromFieldValue)(e,t));return(0,V.isWorkItemIdentityRef)(t)?(0,V.convertWorkItemIdentityRefToIIdentity)(e,t):(0,V.isIdentityRef)(t)?(0,V.convertIdentityRefToIIdentity)(e,t):void 0}(p,r),[b]=(0,n.useObservable)(v),[g,I]=o.useState(void 0);o.useEffect((()=>{(async()=>{const e=(0,A.getWorkItemFieldService)(p);let t;l?t=await e.getAllowedValues(l.fieldDefinition.referenceName,l.workItem.project.guid,l.fieldDefinition.workItemType.name):d&&(t=await e.getAllowedValues(d.referenceName)),I(t)})()}),[I]);const y=o.useMemo((()=>{const e=new(s?O.WITMeMacroPeoplePickerProvider:T.PeoplePickerProvider)(p,{identityTypes:(0,P.getAllowedIdentityTypes)(p,{excludeServicePrincipals:c,excludeGroups:m})});return e.setAdditionalEntries&&g&&e.setAdditionalEntries(g),e}),[p,c,m,s,g]);return o.createElement(D.IdentityPickerDropdown,{ariaLabel:e,className:t,disabled:a,onChange:e=>{if(b.value=e,i){const t=e&&(0,V.convertIIdentityToWorkItemIdentityRef)(p,e),n=v&&(0,V.convertIIdentityToWorkItemIdentityRef)(p,v);i(t,(null==t?void 0:t.distinctDisplayName)!==(null==n?void 0:n.distinctDisplayName))}},pickerProvider:y,value:b})};const l=({ariaLabel:e,className:t,datePickerExpandOnMount:a,datePickerOnCollapse:l,disabled:r,initialValue:i,onChange:s})=>{const c=i instanceof Date?(0,I.getDateInUserTimeZone)(i):void 0,[d]=(0,n.useObservable)(c);return o.createElement(b.DatePicker,{ariaLabel:e,className:t,disabled:r,expandOnMount:a,showClear:!0,value:d,onChange:e=>{const t=e?(0,I.getDateInClientTimeZone)(e):void 0;d.value=t,s&&s(t,(null==t?void 0:t.getTime())!==(null==c?void 0:c.getTime()))},onCollapse:l})},c=({allowFreeform:e,allowedValues:t,ariaLabel:a,autoSelect:l,className:s,disabled:c,fieldEntry:d,inputType:u,initialValue:m,onChange:v})=>{var f,b;const[g]=(0,n.useObservableArray)(null!==(f=(0,i.wrapListBoxItems)(null!=t?t:[]))&&void 0!==f?f:[]),I=null==m?void 0:m.toString(),y=(null==d?void 0:d.type)===k.FieldType.Double?null===(b=(0,E.getNumberInUserFormat)(m))||void 0===b?void 0:b.toString():I,[w]=(0,n.useObservable)(y),S=new p.DropdownSelection;if(o.useEffect((()=>{var e;if(g.value=null!==(e=(0,i.wrapListBoxItems)(null!=t?t:[]))&&void 0!==e?e:[],t){const e=t.findIndex((e=>e===I));e>=0&&S.selectable(e)&&S.select(e)}})),t&&t.length>0)return o.createElement(r.EditableDropdown,{allowFreeform:null==e||e,allowTextSelection:!0,ariaLabel:a,autoSelect:null!=l&&l,className:s,disabled:c,items:g,onValueChange:e=>{e||S.clear();const t=null==e?void 0:e.text;w.value=t,v&&v(t,t!==I)},selectedText:I,selection:S,minCalloutWidth:180});{const e=(null==d?void 0:d.type)===k.FieldType.Integer||(null==d?void 0:d.type)===k.FieldType.Double,t=t=>{switch(t){case"text":case"number":case"password":case"button":return t;default:return e?"number":"text"}},n=t(u);return o.createElement(N.TextField,{ariaLabel:a,autoSelect:null!=l&&l,containerClassName:s,className:s,disabled:c,inputType:n,value:w,onChange:(e,t)=>{w.value=t,v&&v(t,t!==I)}})}}}("WorkItemFieldControl")}),["Resources","Constants","NodeTreeItemProvider","NodeUtils","NodeTreeDropdown","AreaPathDropdown","DatePickerDialog","IterationDropdown","NewItemCallout","WorkItemFieldControl"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-controls"}}));