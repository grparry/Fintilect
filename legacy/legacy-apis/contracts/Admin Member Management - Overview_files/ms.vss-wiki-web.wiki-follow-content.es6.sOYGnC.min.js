"use strict";define("Wiki/Follow",["require","exports","react","VSS/Core/Util/String","VSS/Platform/Layout","VSSUI/Button","VSSUI/Pill","VSSUI/Util"],(function(o,t,e,l,s,i,a,n){var r,w;r=t[w="Resources"]={},t[w].Follow="Follow",t[w].Unfollow="Unfollow",t[w].FollowerPillText="Page has {0} followers",function(o){t[o]={};const w="Follow",p="WikiPageId";class c extends s.VssComponent{constructor(o,t){super(o,t),this._onButtonClick=()=>{const{wikiPageFollowStatus:o}=this.state;1===o?this._unFollowPage():this._followPage()},this._followPage=()=>{this.setState(((o,t)=>({followersCount:o.followersCount+1,wikiPageFollowStatus:1}))),this._followService.follow(p,this._getFollowArtifactId()),this._publishTelemetry(w,{followAction:"Follow"})},this._unFollowPage=(o,t)=>{this.setState(((o,t)=>{let e=o.followersCount-1;return e<0&&(e=0,this._publishTelemetry("NegativeFollow")),{followersCount:e,wikiPageFollowStatus:0}})),this._followService.unfollow(p,this._getFollowArtifactId()).then((()=>{t&&t()})),this._publishTelemetry(w,{followAction:"Unfollow",unfollowUsingUrl:o})},this._publishTelemetry=(o,t)=>{this.context.pageContext.getService("IVssTelemetryService").publishEvent("Wiki",o,Object.assign({pageId:this.props.pageId,projectId:this.props.projectId,wikiId:this.props.wikiId},t))},this.state={},this._followService=t.pageContext.getService("IFollowsService")}componentDidUpdate(o,t){super.componentDidUpdate(o,t),this.props.pageId!==o.pageId&&this._performFollowDataLoad()}componentDidMount(){super.componentDidMount(),this._performFollowDataLoad()}render(){const{wikiPageFollowStatus:o,followersCount:t}=this.state;return void 0!==o&&null!=t?e.createElement("div",{className:"flex-row flex-center flex-noshrink"},e.createElement(i.Button,{className:(0,s.css)("page-follow-button",this.props.className),iconProps:{className:this.props.buttonIconClassName,iconName:1===o?"Hide2":"View"},onClick:this._onButtonClick,ariaLabel:r.Follow,ariaDescribedBy:"page-follow-button-description",ariaPressed:1===o},e.createElement("span",{className:"body-m"},1===o?r.Unfollow:r.Follow)),e.createElement("span",{id:(0,n.getSafeId)("page-follow-button-description"),"aria-label":(0,l.format)(r.FollowerPillText,t)}),e.createElement(a.Pill,{ariaHidden:!0,className:"page-follower-count",size:1,excludeTabStop:!0},t)):null}_performFollowDataLoad(){this.props.refreshFollowStatus?this._followService.refresh(p).then((()=>{this._loadFollowData(),this.props.onFollowStatusRefreshed&&this.props.onFollowStatusRefreshed()})):this._loadFollowData()}_loadFollowData(){const o=this._followService.isFollowing(p,this._getFollowArtifactId()),t=this._getFollowersCount();this.trackPromise(Promise.all([o,t])).promise.then((([o,t])=>{const e=o?1:0;this.setState({wikiPageFollowStatus:e,followersCount:t}),this.props.unfollowPage&&(o&&this._unFollowPage(!0),this.props.unsetUnfollowPageOption())}))}_getFollowersCount(){const o={conditions:[{filter:{artifactId:this._getFollowArtifactId(),artifactType:p,type:"Artifact"}}],queryFlags:16};return this.context.pageContext.getRestClient("INotificationRestClient").querySubscriptions(o).then((o=>o.length))}_getFollowArtifactId(){return(0,l.format)("{0}/{1}/{2}",this.props.projectId,this.props.wikiId,this.props.pageId.toString())}}t[o].FollowComponent=c,s.VssComponent.register("Wiki.FollowComponent",c)}("FollowComponent")}),["Resources","FollowComponent"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-wiki-web.wiki-follow-content"}}));