"use strict";define("Wiki/PageComments",["require","exports","Wiki/Clients/Wiki/RestClient/Wiki","react","VSS/Core/Util/String","VSS/Platform/Feature","VSS/Platform/FPS","VSS/Platform/Layout","VSSUI/Dialog","Comments/Thread/CommentThread","Wiki/ViewCommon/Constants"],(function(t,e,i,n,o,a,s,r,m,c,d){var l,C,p,g;l=e[g="Resources"]={},e[g].Discard="Discard",e[g].Cancel="Cancel",e[g].UnsavedChangesDialogTitle="Unsaved changes",e[g].ConfirmDiscardCommentDraft="Are you sure you want to discard this draft?",function(t){function i(t){return!t||""==t.trim()}C=e[t]={},e[t].WikiPageArtifactKind="C38A95A3-8516-40C1-BC31-247A5008586B",e[t].ForwardSlash="/",e[t].convertArtifactInfoToWikiCommentArtifact=function(n){const o=n.artifactId.split(e[t].ForwardSlash);if(o.length<3||i(o[0])||i(o[1])||i(o[2]))throw new Error("Invalid Artifact Id: "+n.artifactId);return{projectId:o[0],wikiId:o[1],pageId:Number(o[2])}},e[t].buildCommentArtifactInfo=function(i){return{artifactId:i.projectId+e[t].ForwardSlash+i.wikiId+e[t].ForwardSlash+i.pageId,artifactKind:e[t].WikiPageArtifactKind,projectId:i.projectId}}}("WikiPageCommentsHelper"),function(t){p=e[t]={};e[t].WikiPageCommentsClient=class{constructor(t){this._wikiRestClient=(0,i.getWikiClient)(t)}addComment(t,e,i){const n={text:e,parentId:i},o=(0,C.convertArtifactInfoToWikiCommentArtifact)(t);return this._wikiRestClient.addComment(n,o.projectId,o.wikiId,o.pageId)}updateComment(t,e,i){const n=(0,C.convertArtifactInfoToWikiCommentArtifact)(t),o={text:i};return this._wikiRestClient.updateComment(o,n.projectId,n.wikiId,n.pageId,e)}getComment(t,e,i){const n=(0,C.convertArtifactInfoToWikiCommentArtifact)(t);return this._wikiRestClient.getComment(n.projectId,n.wikiId,n.pageId,e,i)}getComments(t,e,i,n,o,a){const s=(0,C.convertArtifactInfoToWikiCommentArtifact)(t);return this._wikiRestClient.listComments(s.projectId,s.wikiId,s.pageId,e,o,!i,a,void 0,n).then((t=>({comments:t.comments,continuationToken:t.continuationToken,totalCount:t.totalCount})))}deleteComment(t,e){const i=(0,C.convertArtifactInfoToWikiCommentArtifact)(t);return this._wikiRestClient.deleteComment(i.projectId,i.wikiId,i.pageId,e)}addCommentReaction(t,e,i){const n=(0,C.convertArtifactInfoToWikiCommentArtifact)(t);return this._wikiRestClient.addCommentReaction(n.projectId,n.wikiId,n.pageId,e,i)}deleteCommentReaction(t,e,i){const n=(0,C.convertArtifactInfoToWikiCommentArtifact)(t);return this._wikiRestClient.deleteCommentReaction(n.projectId,n.wikiId,n.pageId,e,i)}getReactionRecentUsers(t,e,i){const n=(0,C.convertArtifactInfoToWikiCommentArtifact)(t);return this._wikiRestClient.getEngagedUsers(n.projectId,n.wikiId,n.pageId,e,i)}addCommentAttachment(t,e){const i=(0,C.convertArtifactInfoToWikiCommentArtifact)(t);return this._wikiRestClient.createCommentAttachment(e,i.projectId,i.wikiId,i.pageId)}}}("WikiPageCommentsClient"),function(t){e[t]={};class i extends r.VssComponent{constructor(t,e){super(t,e),this._supportsReactions=!1,this._supportsCommentLabel=!1,this._onDirtyChange=t=>{this.setState({isDirty:t})},this._onFpsStarting=t=>{this.state.isDirty&&(t.preventDefault(),t.detail.cancellationReason=l.UnsavedChangesDialogTitle,function(t,e){const i="cancel-discard-draft";t.getService("IVssLayoutManager").renderCallout((t=>n.createElement(m.Dialog,{titleProps:{text:l.UnsavedChangesDialogTitle},onDismiss:t,lightDismiss:!1,defaultActiveElement:`.${i}`,footerButtonProps:[{text:l.Cancel,onClick:t,className:i},{text:l.Discard,danger:!0,onClick:e}]},l.ConfirmDiscardCommentDraft)))}(this.context.pageContext,(()=>{document.body.removeEventListener("fpsStarting",this._onFpsStarting),(0,s.FastPageSwitch)(t.detail.pageContext,t.detail.href,t.detail.recordHistoryEntry,t.detail.data)})))},this._onBeforeUnload=t=>{if(this.state.isDirty)return t.returnValue=l.UnsavedChangesDialogTitle,t.returnValue},this.state={},this._wikiPageCommentsClient=new p.WikiPageCommentsClient(e.pageContext),this._supportsImageUpload=(0,a.isFeatureFlagEnabled)(e.pageContext,"Wiki.WikiPageComments.ImageUpload"),this._supportsReactions=(0,a.isFeatureFlagEnabled)(e.pageContext,"Wiki.WikiPageCommentReactions"),this._supportsCommentLabel=(0,a.isFeatureFlagEnabled)(e.pageContext,"Wiki.WikiPageCommentLabels")}componentDidMount(){super.componentDidMount(),document.body.addEventListener("fpsStarting",this._onFpsStarting),window.addEventListener("beforeunload",this._onBeforeUnload);const t=this.context.pageContext.getService("IVssHistoryService"),e=t.getState(),i=e[d.UrlConstants.ShouldScrollToCommentsParam];if(i){if((0,o.equals)(i,"true",!0)){const t=document.getElementsByClassName("wiki-comments-container");t&&t.length>0&&t[0].scrollIntoView()}delete e[d.UrlConstants.ShouldScrollToCommentsParam],t.replaceState(e)}}componentWillUnmount(){super.componentWillUnmount(),window.removeEventListener("beforeunload",this._onBeforeUnload),document.body.removeEventListener("fpsStarting",this._onFpsStarting)}render(){return this._supportsCommentLabel?n.createElement("div",{className:"comments-container"},n.createElement("h2",{className:"comments-title"},"Comments"),n.createElement(c.CommentThread,{artifactInfo:(0,C.buildCommentArtifactInfo)(this.props.wikiArtifact),commentsClient:this._wikiPageCommentsClient,readonly:this.props.isReadOnly,formatDisabled:!0,supportsThreads:!1,supportsReactions:this._supportsReactions,supportsImageUpload:this._supportsImageUpload,className:"wiki-comments-container",onDirtyChange:this._onDirtyChange})):n.createElement(c.CommentThread,{artifactInfo:(0,C.buildCommentArtifactInfo)(this.props.wikiArtifact),commentsClient:this._wikiPageCommentsClient,readonly:this.props.isReadOnly,formatDisabled:!0,supportsThreads:!1,supportsReactions:this._supportsReactions,supportsImageUpload:this._supportsImageUpload,className:"wiki-comments-container",onDirtyChange:this._onDirtyChange})}}e[t].WikiPageComments=i,r.VssComponent.register("wiki-pagecomments",i)}("ComponentsWikiPageComments")}),["Resources","WikiPageCommentsHelper","WikiPageCommentsClient","Components/WikiPageComments"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-wiki-web.wiki-page-comments"}}));