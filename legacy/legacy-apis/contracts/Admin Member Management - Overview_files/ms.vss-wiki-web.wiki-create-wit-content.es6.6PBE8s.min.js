"use strict";define("Wiki/CreateWit",["require","exports","VSS/Features/Markdown/MarkdownConstants","react","VSS/Core/Util/String","VSS/Platform/Layout","VSSUI/Callout","VSSUI/Components/Button/ExpandableButton","VSSUI/Icon","VSSUI/Menu","Wit/Common/Generated/Constants","Wit/Common/WorkItemTypeColorAndIcons"],(function(e,t,n,i,s,o,r,a,c,l,d,h){var u,m,p,g;u=t[g="Resources"]={},t[g].NewWorkItem="New work item",t[g].EmbedWitFailed="{0} with id {1} created but failed to embed. You can manually embed it in the page.",t[g].NoEmbedReason="{0} with id {1} created but not embedded as unsupported content type was detected in the selected text. You can manually embed it in the page.",t[g].WikiShortcutGroupHeading="Wiki",t[g].CreateWitShortcutDescription="Create work item from selected text",function(e){m=t[e]={};t[e].SelectionElements=class{constructor(){this.witTables=0,this.prMentions=0,this.witMentions=0,this.peopleMentions=0,this.htmlTags={},this.exploredTextCharCount=0}shouldEmbedWorkItem(){return!(this.witTables||this.prMentions||this.witMentions||this.peopleMentions||!this._hasOnlyWhiteListedHTMLTags())}reset(){this.witTables=0,this.prMentions=0,this.witMentions=0,this.peopleMentions=0,this.htmlTags={},this.exploredTextCharCount=0}merge(e){this.witTables+=e.witTables,this.prMentions+=e.prMentions,this.witMentions+=e.witMentions,this.peopleMentions+=e.peopleMentions;for(const t of Object.keys(e.htmlTags)){let n=e.htmlTags[t];this.htmlTags[t]&&(n+=this.htmlTags[t]),this.htmlTags[t]=n}}_hasOnlyWhiteListedHTMLTags(){let e=0;return["BR","STRONG","B","EM","I","DIV","SPAN","P"].forEach((t=>{this.htmlTags[t]&&e++})),Object.keys(this.htmlTags).length===e}}}("SelectionElements"),function(e){p=t[e]={};const i="[[{()*+?.\\^$|]";function s(e,t){for(;e&&(!e.classList||!e.classList.contains(t));)e=d(e);return!!e}function o(e,t){let i="";const s=d(e);if(s){const e=s.getAttribute(n.MarkdownConstants.MarkDownLinesMappingAttrName);e&&!t[e].isBlock&&(i=t[e].markup)}return i}function r(e,t,n){let i,s=0,o=-1;const r=new RegExp(l(e),"g");for(;i=r.exec(t);)if(s++,s===n){o=i.index;break}return o}function a(e){let t=0;for(let n=0;n<e.length;n++){const i=e.charAt(n);" "!==i&&"\t"!==i&&"\n"!==i&&t++}return t}function c(e,t,n,i,s,o){if(e){let t=!1;if(e.classList&&(t=!0,e.classList.contains("mention-preview-person")?s.peopleMentions++:u(e)?s.witTables++:e.classList.contains("mention-widget-workitem")?s.witMentions++:e.classList.contains("mention-widget-item")?s.prMentions++:t=!1),!t&&!f(e)){const t=s.htmlTags[e.nodeName];s.htmlTags[e.nodeName]=t?t+1:1}if(f(e)&&"\n"!==e.nodeValue&&(i.merge(s),s.reset(),e.nodeValue&&(i.exploredTextCharCount+=a(e.nodeValue),i.lastTextNode=e)),e.isSameNode(n)||i.exploredTextCharCount>=o)return!0}if(t&&e&&e.hasChildNodes&&e.hasChildNodes())for(let t=0;t<e.childNodes.length;t++){if(c(e.childNodes[t],!0,n,i,s,o))return!0}return!1}function l(e){const t=new RegExp(i,"g");return e.replace(t,"\\$&")}function d(e){let t=null;return e&&e.parentNode instanceof Element&&(t=e.parentNode),t}function h(e,t){if(!e||""===t)return 0;const n=new RegExp(l(t),"g");let i,s=0;for(;i=n.exec(e);)s++;return s}function u(e){return!(!e||!e.classList)&&e.classList.contains("wiki-wit-table-container")}function g(e,t){let n=0;if(e&&!function(e){return!!(e&&e.classList&&(e.classList.contains("mention-preview-person")||e.classList.contains("mention-widget-workitem")||e.classList.contains("mention-widget-item")))}(e)&&!u(e)){if(f(e))return h(e.textContent,t);if(e.hasChildNodes())for(let i=0;i<e.childNodes.length;i++)f(e.childNodes[i])?n+=h(e.childNodes[i].textContent,t):n+=g(e.childNodes[i],t)}return n}function f(e){return 3===e.nodeType}function C(e,t,i,s){let o=0;if(e.endContainer===e.startContainer){o=h((t.textContent||"").substr(0,e.endOffset),i)}else o=1;let r=t;do{r=t,o+=g(t=t.previousSibling,i),t||(t=r.parentNode)}while(f(t)||"string"==typeof t.className&&-1===t.className.search("wiki-md-container")&&!w(t,s));let a=null;const c=t.getAttribute(n.MarkdownConstants.MarkDownLinesMappingAttrName);return c&&(a=s[c]),[o,a]}function w(e,t){const i=e.getAttribute(n.MarkdownConstants.MarkDownLinesMappingAttrName);return!!i&&(t[i]&&t[i].isBlock)}function T(e,t){const n=1===t?e.startContainer.textContent:e.endContainer.textContent;if(!n)return"";let i=0,s=0;e.endContainer===e.startContainer?(i=e.startOffset,s=e.endOffset):s=n.length;let o=1===t?n.substring(e.startOffset,s):n.substring(i,e.endOffset);return"\n"===o.charAt(0)&&(o=o.substring(1)),o}t[e].isSelectionAllowed=function(e){let t=f(e.endContainer)?d(e.endContainer):d(e.startContainer);for(;null!==t&&!t.classList.contains("wiki-md-container");){if("A"===t.nodeName||"CODE"===t.nodeName||t.classList.contains("metadata-yaml-table")||t.classList.contains("toc-container")||t.classList.contains("wiki-mermaid-container"))return!1;t=d(t)}return!0},t[e].hasParentNode=s,t[e].shouldShowCreateWitMenu=function(e){const t=s(e.startContainer,"wiki-md-container");let n=!0;return f(e.endContainer)&&(n=s(e.endContainer,"wiki-md-container")),t&&n},t[e].embedWorkItemToTheSelectedPlace=function(e,t,n,i,s){const a=T(e,1);let c,l=!1;const d=f(e.endContainer);if(e.startContainer===e.endContainer?(l=!0,c=a):c=d?T(e,2):function(e){if(null===e)return"";if("\n"===e.charAt(0))return e.substring(1);return e}(t.lastTextNode.nodeValue),!a||!c)return;const h=i.split("\n"),u=C(e,e.startContainer,a,s),m=u[1]||{startLine:0,endLine:h.length},p=h.slice(m.startLine,m.endLine).join("\n"),g=r(a,p,u[0]);let w,S,b,k;if(l?(k=u,w=m,b=p,S=g):(k=C(e,t.lastTextNode,c,s),w=k[1]||{startLine:0,endLine:h.length},b=h.slice(w.startLine,w.endLine).join("\n"),S=r(c,b,k[0])),-1!==g&&-1!==S){const i=S+c.length;let r=p.substr(0,g),a=b.substr(i);const l=o(e.startContainer,s);if(""!==l){r.endsWith(l)?r=r.substr(0,r.length-l.length):r+=l}const u=o(d?e.endContainer:t.lastTextNode,s);if(""!==u){const e=a.startsWith(u);a=e?a.substr(u.length):u+a}return h.slice(0,m.startLine).join("\n")+(m.startLine>0?"\n":"")+r+" #"+n+" "+a+(w.endLine<h.length?"\n":"")+h.slice(w.endLine).join("\n")}},t[e].getSelectionElements=function(e,t){const n=new m.SelectionElements,i=new m.SelectionElements;let s=e.startContainer,o=s;const r=e.endContainer;let l=e.endContainer===e.startContainer;const h=a(t);for(n.exploredTextCharCount=a(T(e,1)),n.lastTextNode=s;s&&!l;)if(o=s,s=s.nextSibling,s)l=c(s,!0,r,n,i,h);else{if(s=d(o),s&&s.classList&&s.classList.contains("wiki-md-container"))break;l=c(s,!1,r,n,i,h)}return n},t[e].escapeHTMLChars=function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}}("CreateWitUtils"),function(e){t[e]={};const n="mod+shift+b";class m extends o.VssComponent{constructor(e,t){super(e,t),this._witMenuContainerRef=i.createRef(),this._witMenuRefContainerRef=i.createRef(),this._expandableButtonRef=i.createRef(),this._handleKeyDown=e=>{27===e.keyCode&&this._hideCreateWitMenu()},this._registerShortcuts=()=>{this.context.pageContext.getService("IVssKeyboardShortcutService").registerShortcut(u.WikiShortcutGroupHeading,{combos:[n],description:u.CreateWitShortcutDescription,action:()=>this._onTextSelected(void 0,!0)})},this._unregisterShortcuts=()=>{this.context.pageContext.getService("IVssKeyboardShortcutService").unRegisterShortcut(u.WikiShortcutGroupHeading,n)},this._onTextSelected=(e,t)=>{setTimeout((()=>{const n=window.getSelection();let i=!1;if(e&&(i=(0,p.hasParentNode)(e.target,"wit-menu-items")),n&&""!==n.toString().trim()&&(0,p.shouldShowCreateWitMenu)(n.getRangeAt(0))&&!i){if(this._selectedRange=n.getRangeAt(0).cloneRange(),this._selectedText=n.toString(),!n.isCollapsed&&this._witMenuContainerRef.current&&this._witMenuRefContainerRef.current){const e=this._witMenuContainerRef.current,n=this._witMenuRefContainerRef.current,i=this._selectedRange.getBoundingClientRect(),s=n.getBoundingClientRect();e.style.top=i.top-s.top-52+"px",e.style.left=i.left-s.left+"px",e.classList.remove("hidden"),t&&this._expandableButtonRef.current&&this._expandableButtonRef.current.focus()}}else this._hideCreateWitMenu(e)}),50)},this._hideCreateWitMenu=e=>{if(e){const t=e.target;if((0,p.hasParentNode)(t,"wit-menu-container"))return}this._witMenuContainerRef.current&&this._witMenuContainerRef.current.classList.add("hidden")},this._onRenderWorkItemTypesDropdown=(e,t,n,s,o,a,c)=>i.createElement(r.Callout,{anchorElement:n,anchorOffset:s,anchorOrigin:o,anchorPoint:a,calloutOrigin:c,blurDismiss:!0,onDismiss:e.collapse,contentShadow:!0},i.createElement(l.ContextualMenu,{anchorElement:n,anchorOrigin:{horizontal:"end",vertical:"end"},menuProps:{id:"create-new-wit",items:this._getMenuItems()},menuOrigin:{horizontal:"start",vertical:"end"},onDismiss:e.collapse,className:"wit-menu-items"})),this._getMenuItems=()=>{const{workItemTypes:e,colorAndIcons:t}=this._workItemTypesData,n=[];return e&&e.forEach((e=>{const i={id:e,text:e,onActivate:this._onMenuItemClicked};if(t){const n=this._getWorkItemTypeColorAndIcon(e,t);i.iconProps={className:(0,o.css)("bowtie-icon",n.icon),style:{color:n.color}}}n.push(i)})),n},this._onMenuItemClicked=(e,t)=>{this._hideCreateWitMenu();const n=e.text;if(n){const e=this.context.pageContext.getService("IVssTelemetryService");e.publishEvent("Wiki","CreateWitMenuClicked",{witType:n,numberOfCharsSelected:this._selectedText.length});const t={close:t=>{if(0!==t.id){let i;const o=this.props.hasTemplates();let r=!1;const a=this.context.pageContext.getService("IVssPerformanceService");let c=(0,s.format)(u.EmbedWitFailed,t.workItemType.name,t.id);a.startScenario("Wiki.Wit.Embed",!1);const l=(0,p.isSelectionAllowed)(this._selectedRange);let d={witType:n,witId:t.id,pageHasTemplates:o,numberOfCharsSelected:this._selectedText.length,isSelectionAllowed:l};if(l){"\n"===this._selectedText.charAt(this._selectedText.length-1)&&(this._selectedText=this._selectedText.substr(0,this._selectedText.length-1)),this._addSplitTiming(a,"GetSelectionElementsStarted");const e=(0,p.getSelectionElements)(this._selectedRange,this._selectedText);this._addSplitTiming(a,"GetSelectionElementsCompleted");const n=e.shouldEmbedWorkItem();d=Object.assign(Object.assign(Object.assign({},d),{shouldEmbedWit:n,peopleMentions:e.peopleMentions,prMentions:e.prMentions,witTables:e.witTables,witMentions:e.witMentions}),e.htmlTags),!o&&n?(this._addSplitTiming(a,"EmbedWorkItemStarted"),i=(0,p.embedWorkItemToTheSelectedPlace)(this._selectedRange,e,t.id,this.props.markdownContent,this.props.getMarkdownLinesMapping()),this._addSplitTiming(a,"EmbedWorkItemCompleted"),i||(r=!0)):c=(0,s.format)(u.NoEmbedReason,t.workItemType.name,t.id)}i?this.props.handleEmbedWorkItem(i,t.id,t.workItemType.name,c):this.props.handleEmbedWorkItemFailure(c),d.failedToEmbedWit=r,a.endScenario("Wiki","Wiki.Wit.Embed",!1),e.publishEvent("Wiki","WitCreated",d)}}},i={[d.CoreFieldRefNames.Title]:this._selectedText.substr(0,255),[d.CoreFieldRefNames.Description]:(0,p.escapeHTMLChars)(this._selectedText)};this.context.pageContext.getService("work-item-service").createWorkItem(n,void 0,t,i)}};const a=this.context.pageContext.getService("IVssContributionService").getData("ms.vss-work-web.new-workitem-data-provider");this._workItemTypesData=a||{}}componentDidMount(){super.componentDidMount(),this.addEventListener(document.body,"mouseup",this._onTextSelected),this._registerShortcuts()}componentWillUnmount(){super.componentWillUnmount(),this._unregisterShortcuts()}render(){return this._workItemTypesData.workItemTypes?i.createElement(i.Fragment,null,i.createElement("div",{className:"wit-menu-ref-element",ref:this._witMenuRefContainerRef}),i.createElement("div",{className:(0,o.css)("wit-menu-container","hidden"),ref:this._witMenuContainerRef,onKeyDown:this._handleKeyDown},i.createElement(a.ExpandableButton,{iconProps:{iconName:"Add"},hideDropdownIcon:!0,renderCallout:this._onRenderWorkItemTypesDropdown,text:u.NewWorkItem,anchorOrigin:{horizontal:"end",vertical:"start"},expandKey:39,subtle:!0,ref:this._expandableButtonRef},(0,c.Icon)({key:"dropdown-icon",className:"icon-right",iconName:"ChevronRightMed"})))):null}_getWorkItemTypeColorAndIcon(e,t){const n=t[e=e.trim().toLowerCase()];return n&&n.icon?h.WorkItemTypeColorAndIcons.createColorAndIcon(n.color,n.icon):h.WorkItemTypeColorAndIcons.getDefault()}_addSplitTiming(e,t){e.addSplitTiming(t,"Wiki.Wit.Embed")}}t[e].CreateWitMenu=m,o.VssComponent.register("Wiki.CreateWitMenu",m)}("CreateWitMenu")}),["Resources","SelectionElements","CreateWitUtils","CreateWitMenu"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-wiki-web.wiki-create-wit-content"}}));