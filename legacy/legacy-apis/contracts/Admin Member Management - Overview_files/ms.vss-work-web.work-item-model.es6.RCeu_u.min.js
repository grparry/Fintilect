"use strict";define("Wit/WorkItemModel",["require","exports","Wit/Common/WorkItemControls/Constants","xss","xss/PresetOptions","Wit/Common/Generated/Constants","VSS/Core/Observable","VSS/Core/Util/String","Wit/Common/DateUtils","Wit/Identity/Utilities/WorkItemIdentityHelper","VSS/Platform/Context","Wit/Clients/Wit/RestClient/WorkItemTracking","VSS/Platform/Feature","Wit/Common/Constants/FeatureFlags","Wit/WorkItemDataManager/Sources/WorkItemStoreLevelWITDataSource","Mention/Common/DisplayNameStorageKeyTranslationService","VSS/Platform/Telemetry","VSS/Platform/Util/Array","Wit/Common/NodeHelpers","react","VSS/Platform/FPS","VSSUI/Dialog","VSSUI/Observer"],(function(e,t,i,a,s,r,n,o,l,d,u,h,c,I,m,g,f,p,k,v,E,y,F){var C,D,T,S,_,R,W,w,L,N,O,P,V,A,b,M,B,U,x,j,H,G,Q,K,q,Y;C=t[Y="Resources"]={},t[Y].BrowserRefreshRequired="VS402831: Changes have been made to the process that require you to refresh your browser.",t[Y].FailedToRetrieveProjectDataForId="Failed to retrieve project data for project id {0}.",t[Y].FailedToRetrieveFieldLookupData="Failed to retrieve field lookup data for current project.",t[Y].FailedToRetrieveWorkItemDataForIds="Failed to retrieve work item data for the following ids: {0}.",t[Y].FieldStatusInvalidCharactersError="The value for field '{0}' has unsupported characters.",t[Y].FieldStatusInvalidComputedFieldError="The value for field '{0}' is computed and cannot be changed.",t[Y].FieldStatusInvalidDateErrorError="FieldStatusInvalidDateErrorError",t[Y].FieldStatusInvalidEmptyError="Field '{0}' cannot be empty.",t[Y].FieldStatusInvalidEmptyOrOldValueError="Field '{0}' cannot be empty, and must be different from the original value.",t[Y].FieldStatusInvalidFormatError="The value for field '{0}' is not in a recognized format.",t[Y].FieldStatusInvalidListValueError="The field '{0}' contains the value '{1}' that is not in the list of supported values.",t[Y].FieldStatusInvalidNotEmptyError="The value for field '{0}' must be empty.",t[Y].FieldStatusInvalidNotEmptyOrOldValueError="The value for field '{0}' must be empty or the same as the original value.",t[Y].FieldStatusInvalidNotOldValueError="The value for field '{0}' must be the same as the original value.",t[Y].FieldStatusInvalidOldValueError="The value for field '{0}' must be updated, the current value is no longer supported.",t[Y].FieldStatusInvalidPathError="The area or iteration provided for field '{0}' could not be found.",t[Y].FieldStatusInvalidTooLongError="The value for field '{0}' is too long.",t[Y].FieldStatusInvalidTypeError="The value for field '{0}' is not of the right type.",t[Y].FieldStatusInvalidUnknownError="There is an unknown problem with field '{0}'.",t[Y].FieldStatusInvalidValueInOtherFieldError="The field '{0}' is unsupported because of a value in another field.",t[Y].FieldStatusInvalidValueNotInOtherFieldError="The field '{0}' is unsupported because a value is missing in another field.",t[Y].InvalidWorkItemId="Unable to retrieve work item info for work item id {0}.",t[Y].WorkItemBulkSaveFailed="One or more work items could not be saved. You might have lost the connection to your server. Refresh your browser, and then try again. If the problem persists, you might not have the area path permissions required to edit work items.",t[Y].WorkItemIsReadOnlyError="This action does not apply because the work is read-only.",t[Y].WorkItemLinkTypeEndDoesNotExist="Work item link type end '{0}' does not exist.",t[Y].UnknownError="Unknown error.",t[Y].CreateCopyCopiedFrom="Copied from {0}",t[Y].CreateCopyCopiedFromNewWorkItem="Copied from new work item",t[Y].CreateCopyCopiedWithAllAttachmentsFrom="Copied with all attachments from {0}",t[Y].CreateCopyCopiedWithAllLinksAndAttachmentsFrom="Copied with all attachments and links from {0}",t[Y].CreateCopyCopiedWithAllLinksFrom="Copied with all links from {0}",t[Y].CreateCopyErrorCopyingChild="Error copying child item {0}: {1}",t[Y].CreateCopyTooManyChildren="Cannot copy a work item with more than {0} children.",t[Y].LinkedFromMentionCommentFormat="{0} mentioned work item #{1} in #{2}",t[Y].WorkItemChangedReproDescriptionMessage="Copied from {0} when changed from {1} to {2}",t[Y].DeletedAreaPath="(removed area path)",t[Y].DeletedIterationPath="(removed iteration path)",t[Y].WorkItemCaptionNew="New {0} {1}",t[Y].Cancel="Cancel",t[Y].DirtyNavDialogOptions="You can save your changes, discard your changes, or cancel to continue editing.",t[Y].DirtyNavDialogSavingFailure="Error! Failed to save work item(s):",t[Y].DirtyNavDialogTitle="Are you sure you want to leave the page?",t[Y].DirtyNavDialogUnsavedChanges="You have unsaved changes:",t[Y].DiscardChanges="Discard Changes",t[Y].SaveChanges="Save Changes",t[Y].SavingWorkItems="Saving Work Items",t[Y].InvalidNodeId="Invalid node id.",function(e){D=t[e]={},function(e){e.LayoutUserSettingsProvider="ms.vss-work-web.work-item-layout-user-settings-data-provider",e.UnfollowsDataProvider="ms.vss-work-web.work-item-unfollows-data-provider"}(t[e].ExtensionConstants||(t[e].ExtensionConstants={})),function(e){e[e.None=0]="None",e[e.ServerDateTime=1]="ServerDateTime",e[e.CallerIdentity=2]="CallerIdentity",e[e.RandomGuid=3]="RandomGuid"}(t[e].ServerDefaultValueType||(t[e].ServerDefaultValueType={})),t[e].RegisteredLinkTypeNames={Related:"Related Workitem",Hyperlink:"Workitem Hyperlink",Changeset:"Fixed in Changeset",VersionedItem:"Source Code File",Commit:"Fixed in Commit",Branch:"Branch",Tag:"Tag",PullRequest:"Pull Request",ResultAttachment:"Result Attachment",TestResult:"Test Result",Test:"Test",Storyboard:"Storyboard",Build:"Build",FoundInBuild:"Found in build",IntegratedInBuild:"Integrated in build",WikiPage:"Wiki Page",WorkItemLink:"WorkItemLink",RemoteWorkItemLink:"RemoteWorkItemLink",GitHubPullRequestLinkType:"GitHub Pull Request",GitHubCommitLinkType:"GitHub Commit",GitHubIssueLinkType:"GitHub Issue",GitHubBranchLinkType:"GitHub Branch",ReleaseEnvironment:"Integrated in release environment"},t[e].RegisteredWorkItemLinkTypeNames={Parent:"Parent"},function(e){e.OperationCanceledException="VSS.WorkItemTracking.OperationCanceledException",e.WorkItemBulkSaveException="VSS.WorkItemTracking.WorkItemBulkSaveException",e.ProjectDoesNotExistException="VSS.WorkItemTracking.ProjectDoesNotExistException",e.FieldDoesNotExistException="VSS.WorkItemTracking.FieldDoesNotExistException",e.LinkTypeEndDoesNotExistException="VSS.WorkItemTracking.LinkTypeEndDoesNotExistException",e.LinkTypeDoesNotExistException="VSS.WorkItemTracking.LinkTypeDoesNotExistException",e.WorkItemSaveFailedDueToInvalidStatusException="VSS.WorkItemTracking.WorkItemSaveFailedDueToInvalidStatusException",e.InvalidQuerySyntaxException="VSS.WorkItemTracking.InvalidQuerySyntaxException",e.InvalidQueryFilterRowException="VSS.WorkItemTracking.InvalidQueryFilterRowException",e.QueryItemAlreadyExistException="VSS.WorkItemTracking.QueryItemAlreadyExistException",e.QueryFolderDoesNotExistException="VSS.WorkItemTracking.QueryFolderDoesNotExistException",e.InvalidOperationException="System.InvalidOperationException"}(t[e].Exceptions||(t[e].Exceptions={})),function(e){e[e.Valid=0]="Valid",e[e.InvalidEmpty=1]="InvalidEmpty",e[e.InvalidNotEmpty=2]="InvalidNotEmpty",e[e.InvalidFormat=3]="InvalidFormat",e[e.InvalidListValue=4]="InvalidListValue",e[e.InvalidOldValue=5]="InvalidOldValue",e[e.InvalidNotOldValue=6]="InvalidNotOldValue",e[e.InvalidEmptyOrOldValue=7]="InvalidEmptyOrOldValue",e[e.InvalidNotEmptyOrOldValue=8]="InvalidNotEmptyOrOldValue",e[e.InvalidValueInOtherField=9]="InvalidValueInOtherField",e[e.InvalidValueNotInOtherField=10]="InvalidValueNotInOtherField",e[e.InvalidDate=11]="InvalidDate",e[e.InvalidTooLong=12]="InvalidTooLong",e[e.InvalidType=13]="InvalidType",e[e.InvalidComputedField=14]="InvalidComputedField",e[e.InvalidPath=15]="InvalidPath",e[e.InvalidCharacters=16]="InvalidCharacters",e[e.InvalidIdentity=17]="InvalidIdentity",e[e.InvalidUnknown=18]="InvalidUnknown"}(t[e].FieldStatus||(t[e].FieldStatus={})),function(e){e[e.DefaultRules=1]="DefaultRules",e[e.CopyRules=2]="CopyRules",e[e.OtherRules=3]="OtherRules"}(t[e].RuleEvaluatorExecutionPhase||(t[e].RuleEvaluatorExecutionPhase={})),function(e){e.HIDDEN="Microsoft.HiddenCategory",e.TEST_CASE="Microsoft.TestCaseCategory",e.TEST_PLAN="Microsoft.TestPlanCategory",e.TEST_SUITE="Microsoft.TestSuiteCategory",e.TEST_SHAREDSTEP="Microsoft.SharedStepCategory",e.TEST_SHAREDPARAMETER="Microsoft.SharedParameterCategory"}(t[e].WorkItemCategoryConstants||(t[e].WorkItemCategoryConstants={})),function(e){e.NEW_PROJECT_DATA="new-project-data",e.DISCUSSION_ADDED="discussion-added",e.DISCUSSION_DELETED="discussion-deleted",e.DISCUSSION_UPDATED="discussion-updated",e.RESET_DISCUSSION="reset-discussion",e.RESET_HISTORY="reset-history",e.DISCUSSION_EDIT_DIRTY_CHANGED="discussion-dirty-changed",e.DISCUSSION_COMMENT_UPDATED="discussion-comment-updated",e.WORKITEM_DELETED="workitem-deleted",e.WORKITEM_RESTORED="workitem-restored",e.WORKITEM_DESTROYED="workitem-destroyed",e.WORKITEM_DISCARDED="workitem-discarded",e.WORKITEM_ID_UPDATED="workitem-id-updated",e.WORKITEM_COPIED="workitem-copied"}(t[e].Actions||(t[e].Actions={})),t[e].WorkItemWatermarkAllAction="all-fields",function(e){e.HISTORY_OUTDATED="history-outdated",e.WORKITEM_MANAGER_KEY="workitem-manager"}(t[e].RelatedDataKeys||(t[e].RelatedDataKeys={})),function(e){e.NoResult="NoResult",e.Error="Error",e.Success="Success"}(t[e].WorkItemUpdateResultState||(t[e].WorkItemUpdateResultState={})),function(e){e.ReproSteps="Microsoft.VSTS.TCM.ReproSteps"}(t[e].BugWITFieldReferenceNames||(t[e].BugWITFieldReferenceNames={})),function(e){e.QUERY=200,e.SAVE=200}(t[e].PageSizes||(t[e].PageSizes={})),function(e){e.Off="off",e.Right="right",e.Bottom="bottom"}(t[e].WorkItemPaneMode||(t[e].WorkItemPaneMode={})),function(e){e.Child_Link_Name="System.LinkTypes.Hierarchy-Forward",e.Parent_Link_Name="System.LinkTypes.Hierarchy-Reverse",e.Predecessor_Link_Name="System.LinkTypes.Dependency-Reverse",e.Successor_Link_Name="System.LinkTypes.Dependency-Forward",e.Duplicate_Link_Name="System.LinkTypes.Duplicate-Forward",e.DuplicateOf_Link_Name="System.LinkTypes.Duplicate-Reverse",e.Related_Link_Name="System.LinkTypes.Related-Forward"}(t[e].LinkTypeName||(t[e].LinkTypeName={})),function(e){e.DisableWorkItemStoreDataProviders="WorkItemTracking.Server.DisableWorkItemStoreDataProviders",e.DisableSendMailDataProvider="WorkItemTracking.Server.DisableSendMailDataProvider",e.DisableWorkItemColorDataProvider="WorkItemTracking.Server.DisableWorkItemColorDataProvider"}(t[e].WitFeatureAvailabilityFlags||(t[e].WitFeatureAvailabilityFlags={})),function(e){e[e.Related=1]="Related",e[e.Parent=-2]="Parent",e[e.Child=2]="Child",e[e.Predecessor=-3]="Predecessor",e[e.Successor=3]="Successor"}(t[e].CoreLinkTypes||(t[e].CoreLinkTypes={})),function(e){e[e.WorkItemMissingOrUpdated=600122]="WorkItemMissingOrUpdated",e[e.ResourceLinkNotFoundException=600180]="ResourceLinkNotFoundException",e[e.WorkItemFieldInvalidException=600171]="WorkItemFieldInvalidException"}(t[e].ErrorCodes||(t[e].ErrorCodes={})),function(e){e.WorkItemFormArea="NewWorkItemFormArea",e.EditWorkItemView="EditWorkItemView",e.CreateWorkItemView="CreateWorkItemView",e.TakeUpdateResult="WorkItemTracking.TakeUpdateResult",e.EvaluateLinkUpdates="WorkItemTracking.EvaluateLinkUpdates",e.ResetAfterSave="WorkItemTracking.ResetAfterSave"}(t[e].WorkItemFormPerfConstants||(t[e].WorkItemFormPerfConstants={}));class i{}t[e].WITCustomerIntelligenceArea=i,i.WORK_ITEM_TRACKING="WIT",i.WORK_ITEM_TRACKING_MOBILE="WIT_MOBILE",i.NEW_QUERIES_EXPERIENCE="NEW_QUERIES",i.WORK_ITEM_TRACKING_NEWNAV="WIT_NEWNAV";class a{}t[e].WITCustomerIntelligenceFeature=a,a.CLIENTSIDEOPERATION_SEND_EMAIL="SendEmail",a.CLIENTSIDEOPERATION_OPEN_WORK_ITEM_IN_NEW_TAB="OpenWorkItemInNewTab",a.CLIENTSIDEOPERATION_PREFETCH_NEXT_WORKITEM="PrefetchNextWorkitemInTriageView",a.CLIENTSIDEOPERATION_BACK_TO_QUERY_RESULTS="BackToQueryResults",a.CLIENTSIDEOPERATION_MAXIMIZE_RICH_EDITOR="MaximizeRichEditor",a.CLIENTSIDEOPERATION_QUERY_SOFTCAP_LINK="QuerySoftCapLink",a.CLIENTSIDEOPERATION_COPY_SELECTION_AS_HTML="CopySelectionAsHtml",a.CLIENTSIDEOPERATION_WORK_ITEM_FINDER="WorkItemFinder",a.CLIENTSIDEOPERATION_QUERYACROSSPROJECTS="QueryAcrossProjects",a.CLIENTSIDEOPERATION_QUERY_WORK_ITEM="QueryWorkItem",a.CLIENTSIDEOPERATION_CREATE_QUERY="CreateQuery",a.CLIENTSIDEOPERATION_CHANGE_QUERY_COLUMNS="ChangeQueryColumns",a.CLIENTSIDEOPERATION_WIT_CLONE="CloneWorkItem",a.CLIENTSIDEOPERATION_QUERY_RESULTS_PROVIDER="QueryResultsProvider",a.CLIENTSIDEOPERATION_COPY_WORKITEM_LINK="WorkItem.CopyWorkItemLink",a.CLIENTSIDEOPERATION_INCLUDE_WORKITEM_LINKS_ATTACHMENTS="WorkItem.IncludeWorkItemLinksAndAttachments",a.CLIENTSIDEOPERATION_COPY_WITH_CHILDREN="WorkItem.CopyWithChildren",a.CLIENTSIDEOPERATION_TOOLBAR_CLICK="WorkItem.ToolbarButtonClicks",a.CLIENTSIDEOPERATION_WIT_TABSELECTION="WorkItem.TabSelection",a.CLIENTSIDEOPERATION_WIT_GROUPCOLLAPSED="WorkItem.GroupCollapsed",a.CLIENTSIDEOPERATION_WIT_SAVING="WorkItem.Saving",a.CLIENTSIDEOPERATION_WIT_CSSNODECACHEINVALIDATED="CSSNodes.CacheInvalidated",a.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONOPENED="WorkItem.DiscussionOpened",a.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONMESSAGESLOADED="WorkItem.DiscussionMessagesLoaded",a.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONCOMMENTSUBMITTED="WorkItem.DiscussionCommentSubmitted",a.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONUNSAVEDPREVIEW="WorkItem.DiscussionUnsavedPreview",a.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONRETURNTOUNSAVEDCOMMENT="WorkItem.DiscussionReturnToUnsavedComment",a.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONPREVIEWCLICKED="WorkItem.DiscussionPreviewClicked",a.RESULT_FILTER="ResultFilter",a.CLIENTSIDEOPERATION_VS_WORKITEM_NOT_IN_QUERY_RESULTS="VSOpenInWeb.WorkItemNotInQueryResult",a.WORKITEMPANECHANGED="WorkItemPaneChanged",a.WI_FORM_CONTRIBUTION="FormContribution",a.IMPORTCSV_IMPORT="ImportCsv.Import",a.IMPORTCSV_IMPORT_ERROR="ImportCsv.Import.Error",a.ADD_LINK="AddLink",a.GITHUB_ADD_LINK="GitHubAddLink",a.GITHUB_ADD_LINK_ERROR="GitHubAddLink.Error",a.GITHUB_CREATE_BRANCH="GitHubCreateBranch",a.CLIENTSIDEOPERATION_WIT_MOVE_CANCEL="WorkItemMove.CancelMove",a.CLIENTSIDEOPERATION_WIT_MOVE_CANCEL_AFTER_HIDDEN_TYPE_FAILED="WorkItemMove.CancelAfterHiddenTypeFailed",a.CLIENTSIDEOPERATION_WIT_MOVE_CANCEL_AFTER_TYPE_FAILED="WorkItemMove.CancelAfterTypeFailed",a.CLIENTSIDEOPERATION_WIT_MOVE_SUCCEED_AFTER_TYPE_FAILED="WorkItemMove.PassAfterTypeFailed",a.CLIENTSIDEOPERATION_WIT_MOVE_PERMISSIONS_ERROR="WorkItemMove.PermissionsError",a.CLIENTSIDEOPERATION_WIT_MOVE_REVERT="WorkItemMove.Revert",a.CLIENTSIDEOPERATION_WIT_MOVE_SUCCESS="WorkItemMove.Success",a.CLIENTSIDEOPERATION_WIT_TYPE_CHANGE_REVERT="WorkItemChangeType.Revert",a.CLIENTSIDEOPERATION_WIT_TYPE_CHANGE_CANCEL_AFTER_FAIL="WorkItemChangeType.CancelAfterFailed",a.CLIENTSIDEOPERATION_WIT_TYPE_CHANGE_CANCEL_AFTER_OPEN="WorkItemChangeType.CancelAfterOpen",a.CLIENTSIDEOPERATION_WIT_TYPE_CHANGE_SUCCESS="WorkItemChangeType.Success",a.BULK_EDIT_TAGS="BulkEditTags",a.TELEMETRY_ASSIGNTO_POPULATEMENU="AssignTo.PopulateMenu",a.TELEMETRY_OPENWORKITEM_CONTEXTMENU="OpenWorkItemConextMenu",a.WORKITEM_DISCUSSIONCONTROL="WorkItemDiscussion",a.WORKITEM_VIEWFOLLOWS="ViewWorkItemFollows",a.WORKITEM_BULKUNFOLLOWS="BulkUnfollows",a.CLIENTSIDEOPERATION_RELATEDWORKITEMS_CONTROL_OPENWORKITEM="RelatedWorkItemsControlOpenWorkItem",a.NEWQUERYEXPERIENCE_NAVIGATE_PIVOT="NewQueries.NavigatePivot",a.NEWQUERYEXPERIENCE_WORKITEMNAVIGATOR="NewQueries.WorkItemNavigator",a.NEWQUERYEXPERIENCE_TRIAGEVIEWHUB_PIVOTCOMMAND="NewQueries.TriageViewHub.PivotCommand",a.NEWQUERYEXPERIENCE_QUERY_ACTION="NewQueries.QueryAction",a.NEWQUERYEXPERIENCE_MOVE_QUERY="NewQueries.MoveQuery",a.NEWQUERYEXPERIENCE_LEAVE_DIRTY="NewQueries.LeaveDirty",a.NEWQUERYEXPERIENCE_ADHOCQUERY_REDIRECTION="NewQueries.AdhocQuery.Redirection",a.NEWQUERYEXPERIENCE_LASTVISITED_REDIRECTION="NewQueries.LastVisited.Redirection",a.NEWQUERYEXPERIENCE_NAVIGATE_QUERIESPIVOT="NewQueries.Navigate.QueriesPivot",a.NEWQUERYEXPERIENCE_BREADCRUMB_CLICKED="NewQueries.Breadcrumb.Clicked",a.CUSTOMIZE_WORKITEM="WorkItemToolbar.Customize",a.QUERYCHARTS_NAVIGATE="QueryCharts.Navigate",a.QUERY_SEARCH="Query.Search",a.CLIENTSIDEOPERATION_WIT_FIELDKEYBOARDSHORTCUT="WorkItemForm.FieldKeyboardShortcut",a.CLASSIFICATION_MRU_VALUE_CHANGED="ClassificationFieldsMruValueChanged",a.WIT_CACHE_PROVIDER_INIT="WorkItemTracking.CacheProvider.Initialize",a.WIT_CACHE_PROVIDER_OPEN="WorkItemTracking.CacheProvider.OpenCache",a.WIT_WATCHDOG_OPEN_FORM="WorkItemTracking.WatchDog.OpenForm",a.LINKSCONTROL_SAMECATEGORY_WARNING="LinksControl.SameCategory.Warning",a.FILTER_METHOD_USAGE="WorkItemTracking.ExtensionFilterMethodUsage";class s{}t[e].WITPerformanceScenario=s,s.WORKITEM_OPEN_NEWFORMDIALOG="WorkItem.Open.NewFormDialog",s.WORKITEM_RELATED_LINKING="WorkItem.Related.Linking",s.WORKITEMFORM_FOLLOWS_ACTION_FOLLOW="WorkItemForm.Follows.Action.Follow",s.WORKITEMFORM_FOLLOWS_ACTION_UNFOLLOW="WorkItemForm.Follows.Action.Unfollow",s.WORKITEM_OPENFORM="WorkItem.OpenForm",s.WORKITEM_OPENFORM_NEWLAYOUT="WorkItem.OpenForm.NewLayout",s.WORKITEM_OPENFORM_CREATE_NEWLAYOUT="WorkItem.OpenForm.Create.NewLayout",s.WORKITEM_OPENDIALOG_NEWLAYOUT="WorkItem.OpenDialog.NewLayout",s.WORKITEM_OPENIDE_NEWLAYOUT="WorkItem.IDE.OpenForm.NewLayout",s.WORKITEM_SAVE="WorkItem.Save",s.WORKITEM_BULKSAVE="WorkItem.BulkSave",s.WORKITEM_CLOSED="WorkItem.Closed",s.WORKITEM_FIELDCHANGED="WorkItem.FieldChanged",s.QUERY_OPENRESULTS="Query.OpenResults",s.QUERY_SAVE="Query.Save",s.QUERY_SAVEAS="Query.SaveAs",s.QUERYHIERARCHY_LOAD="QueryHierarchy.Load",s.HISTORYVIEW_EXTENSION_LOAD="HistoryView.Extension.Load",s.WORKITEM_SIGNALR_REFRESHCOMPLETE="WorkItem.SignalR.RefreshComplete",s.WORKITEM_SIGNALR_REFRESHERROR="WorkItem.SignalR.RefreshError",s.WORKITEM_SIGNALR_ERROR="WorkItem.SignalR.Error",s.QUERIESHUB_TRIAGEVIEW_OPENQUERYRESULTS="QueriesHub.TriageView.OpenQueryResults",s.QUERIESHUB_TRIAGEVIEW_OPENBREADCRUMBQUERYRESULTS="QueriesHub.TriageView.OpenBreadcrumbQueryResults",s.QUERIESHUB_TRIAGEVIEW_OPENWORKITEM="QueriesHub.TriageView.OpenWorkItem",s.QUERIESHUB_TRIAGEVIEW_SAVEEXISTINGQUERY="QueriesHub.TriageView.SaveExistingQuery",s.QUERIESHUB_QUERIESVIEW_OPENFAVORITESPIVOT="QueriesHub.QueriesView.OpenFavoritesPivot",s.QUERIESHUB_QUERIESVIEW_OPENALLQUERIESPIVOT="QueriesHub.QueriesView.OpenAllQueriesPivot"}("OMWorkItemConstants"),function(e){T=t[e]={},__exportStar(D,t[e])}("OMindex"),function(e){S=t[e]={};class i{constructor(e,t){this.filterByAncestorEntityIds=e||[],this.filterByEntityIds=t||[]}static GetHashCode(e){let t=a._hashSeed;if(null==e)return t;const s=e.filterByAncestorEntityIds.sort().concat([i._hashSeparator],e.filterByEntityIds.sort());for(const e of s)t=t*a._stringListHashPrime+a.GetStringHashCode(e),t&=t;return t}static isFilterByScopeEmpty(e){return e&&0==e.filterByAncestorEntityIds.length&&0==e.filterByEntityIds.length}}t[e].FilterByScope=i,i._hashSeparator="@";class a{static GetStringHashCode(e){let t=a._hashSeed;if(e){e=e.trim().toLowerCase();for(let i=0;i<e.length;i++)t=t*a._stringHashPrime+e.charCodeAt(i),t&=t}return t}static GetStringListHashCode(e){let t=a._hashSeed;if(e)for(let i in e)t=t*a._stringListHashPrime+a.GetStringHashCode(i),t&=t;return t}}t[e].CommonHelpers=a,a._hashSeed=0,a._stringListHashPrime=31,a._stringHashPrime=37}("RuleEngineFilterByScope"),function(e){_=t[e]={};t[e].FieldValidationKey=class{constructor(e,t,i){this.fieldId=e,this.fieldValue=t,this.scope=i}toString(){return JSON.stringify({fieldId:this.fieldId,fieldValue:this.fieldValue,scope:{filterByScope:S.FilterByScope.GetHashCode(this.scope),nonIdentities:this.scope&&this.scope.nonIdentities,excludeGroups:this.scope&&this.scope.excludeGroups}})}equals(e){return e.toString()===this.toString()}}}("RuleEngineFieldValidationKey"),function(e){R=t[e]={};t[e].ServerDefaultValue=class{constructor(e,t){this.type=T.ServerDefaultValueType.None,this.type=e,this.value=t}toString(){return""+this.value}valueOf(){return this.value}}}("RuleEngineServerDefaultValue"),function(e){W=t[e]={};const r=/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F-\u009F]/,n=/(^[\uD800-\uDFFF]$)|[^\uD800-\uDBFF](?=[\uDC00-\uDFFF])|[\uD800-\uDBFF](?![\uDC00-\uDFFF])/;t[e].workItemLinkBeginningSign="#",t[e].getErrorMessage=function e(t){return t?"string"==typeof t?t:"function"==typeof t?e(t()):t.message?t.message:t.description?t.description:t.toString():C.UnknownError},t[e].parseNumber=function(e){return(e=e.trim()).match(/^((0x[a-f0-9]+)|([0-9]+))$/i)?parseInt(e):e.match(/^(([+-]?\d*(\.\d*)?(e[+-]?\d+)?)|([+-]?infinity))$/i)?parseFloat(e):Number.NaN},t[e].isRemoved=function(e){return!!e&&e<i.FutureDate},t[e].parseBool=function(e){if(e){if("true"===e.trim().toLowerCase())return!0}return!1},t[e].containsControlChars=function(e){return r.test(e)},t[e].containsMismatchedSurrogateChars=function(e){return n.test(e)},t[e].isHtmlVisuallyBlank=function(e){var t;const i=Range.prototype.createContextualFragment.bind(document.createRange())(e),a=["EMBED","IMG","INPUT","PICTURE","VIDEO"],s=i.children;if(s.length>0)for(let e=0;e<s.length;e++)if(a.includes(s[e].tagName))return!1;return""===(null!==(t=i.textContent)&&void 0!==t?t:"").trim()},t[e].getWorkItemUrl=async function(e,t,i){const a=e.getService("IVssLocationService");return`${await a.getServiceLocationAsync(void 0,4)}${t}/_apis/wit/workItems/${i}`},t[e].htmlSanitizerPreserveClassAndMentionOptions=Object.assign(Object.assign({},s.superAllowList),{onTag:function(e,t,i){if(e.match(/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/g))return t},onIgnoreTagAttr:function(e,t,i){if("class"===t.substring(0,5)||"data-vss-mention"===t.substring(0,15))return`name="${(0,a.escapeAttrValue)(i)}"`}}),t[e].htmlSanitizerPreserveClassAndMentionOptionsV2=Object.assign(Object.assign({},s.superAllowList),{onTag:t[e].htmlSanitizerPreserveClassAndMentionOptions.onTag,onIgnoreTag:function(e,t,i){return t},onIgnoreTagAttr:function(e,t,i){return t+'="'+(0,a.escapeAttrValue)(i)+'"'}}),t[e].getEndingNumberFromUrl=function(e){if(e){const t=(e=e.trim()).match(/\/(\d+)\/$/);if(t){const e=null==t?void 0:t[1],i=parseInt(e);if(!isNaN(i))return i}}}}("Utils"),function(e){function i(e,t){const i=e;i.sorted=!0,i.comparer=t}function a(e,t){const i=e;return i.sorted&&i.comparer===t}w=t[e]={},t[e].copySortFlag=function(e,t){const i=e,a=t;i.sorted=a.sorted,i.comparer=a.comparer},t[e].flagSorted=i,t[e].sortIfNotSorted=function(e,t){return!a(e,t)&&(e.sort(t),i(e,t),!0)},t[e].isSorted=a}("WorkItemSorting"),function(e){function i(e){return a(e,r.FieldFlags.Computed)}function a(e,t){return(e.flags&+t)!==r.FieldFlags.None}L=t[e]={},t[e].isEditable=function(e){switch(e.id){case r.CoreField.AreaPath:case r.CoreField.IterationPath:return!0;case r.CoreField.Id:case r.CoreField.Rev:case r.CoreField.WorkItemType:case r.CoreField.CreatedBy:case r.CoreField.IsDeleted:return!1}return!i(e)},t[e].isCloneable=function(e){return a(e,r.FieldFlags.Cloneable)},t[e].isComputed=i,t[e].checkFlag=a}("WorkItemFieldDefinitionUtils"),function(e){N=t[e]={};const i=[0,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,8192,65536,4096,536870912,32768,131072,1073741824],a=2147483648,s=256,u=/^\{?([\dA-F]{8})-?([\dA-F]{4})-?([\dA-F]{4})-?([\dA-F]{4})-?([\dA-F]{12})\}?$/i;function h(e,t,i){let n,d,h,I=0;if(null==e)n=null;else if("string"==typeof e&&0===e.length)n=null;else if(e instanceof R.ServerDefaultValue)n=e;else try{switch(t){case r.FieldType.Boolean:if("boolean"==typeof e)n=e?1:0;else if("number"==typeof e)n=0!==e?1:0;else{if("string"!=typeof e)throw new Error("Invalid Boolean field value.");n=/^\d+$/.test(e)?0!==(0,W.parseNumber)(e)?1:0:(0,W.parseBool)(e)?1:0}break;case r.FieldType.Integer:if("number"==typeof e?n=Math.round(e):"boolean"==typeof e?n=e?0:1:"string"==typeof e&&/^[\-+]?\d+$/.test(e.trim())&&(n=Number.parseInt(e)),void 0===n||isNaN(n)||!isFinite(n)||n>a-1||n<-a)throw new Error(`Invalid Integer field value,  ${e}`);break;case r.FieldType.Double:if("number"==typeof e?n=e:"boolean"==typeof e?n=e?0:1:"string"==typeof e&&(n=(0,W.parseNumber)(e.replace(",","."))),void 0===n||isNaN(n)||!isFinite(n))throw new Error(`Invalid Double field value,  ${e}`);break;case r.FieldType.DateTime:if(n=e instanceof Date?e:"string"==typeof e&&(0,l.isIsoDate)(e)?new Date(e):null,null===n||isNaN(n))throw new Error("Invalid DateTime field value.");d=n.getFullYear(),(d<1753||d>9999)&&(I=8192);break;case r.FieldType.Guid:if("string"!=typeof e)throw new Error("Invalid GUID field value.");if(h=u.exec(e),!h)throw new Error("Invalid GUID field value.");n=h[1]+"-"+h[2]+"-"+h[3]+"-"+h[4]+"-"+h[5];break;default:if("string"==typeof e)n=e;else if("number"==typeof e)n=e.toLocaleString();else if("boolean"==typeof e)n=e?"True":"False";else if(e instanceof Date)n=(0,o.dateToString)(e,!0);else{if(t!==r.FieldType.History||!e.text)throw new Error("Invalid String field type.");n=e.text}void 0===n&&(n=null),null!==n&&(t!==r.FieldType.PlainText&&t!==r.FieldType.Html||i||(n=n.trim()),0===n.length&&(n=null)),null!==n&&(t===r.FieldType.String&&n.length>s&&(I=65536),c(n,p(t))||(I=131072))}}catch(t){return{value:e,error:t,status:4096}}return{value:n,status:I}}function c(e,t){return!(!t&&(0,W.containsControlChars)(e))&&!(0,W.containsMismatchedSurrogateChars)(e)}function I(e){switch(e){case r.FieldType.PlainText:case r.FieldType.Html:case r.FieldType.History:case r.FieldType.String:return!0;default:return!1}}function m(e,t){if(t){return g(e,!0)[t.toLocaleUpperCase()]||t}return t}function g(e,t){const i=e,a={};if(t){if(i.__hashSetCaseInsensitive)return i.__hashSetCaseInsensitive;for(const t of e)a[t.toLocaleUpperCase()]=t;i.__hashSetCaseInsensitive=a}else{if(i.__hashSet)return i.__hashSet;for(const t of e)a[t]=t;i.__hashSet=a}return a}function f(e){if(0!=(2147479552&e)){for(let t=1,a=i.length;t<a;t++)if(0!=(e&i[t]))return t;return T.FieldStatus.InvalidUnknown}return T.FieldStatus.Valid}function p(e){switch(e){case r.FieldType.PlainText:case r.FieldType.Html:case r.FieldType.History:return!0;default:return!1}}function k(e){return 0!=(4&e.status)}function v(e){return e===r.FieldType.Integer||e===r.FieldType.Double}function E(e){return null==e||"string"==typeof e&&0===e.trim().length}function y(e,t,i){let a,s;if(!t)return e;if(0===t.length)return[];if(e.length<t.length?a=g(e,i):(a=g(t,i),t=e),s=[],i)for(const e of t)a.hasOwnProperty(e.toLocaleUpperCase())&&(s[s.length]=e);else for(const e of t)a.hasOwnProperty(e)&&(s[s.length]=e);return s}function F(e,t,i){let a,s;if(i){t?(a=t.slice(0),(0,w.copySortFlag)(a,t)):(a=[],(0,w.flagSorted)(a,o.localeIgnoreCaseComparer));for(const t of i){if(s=e.getConstantSet(t),!s)throw new Error((0,o.format)("Constant set {0} is not ready. Operation cannot continue.",t));a=_(a,s,!0)}return a}return t}function D(e,t,i){if(i){return g(e,!0).hasOwnProperty(t.toLocaleUpperCase())}return e.includes(t)}function S(e,t,i){let a,s;if(!t||0===t.length)return e;if(s=[],a=g(t,i),i)for(const t of e)a.hasOwnProperty(t.toLocaleUpperCase())||(s[s.length]=t);else for(const t of e)a.hasOwnProperty(t)||(s[s.length]=t);return s}function _(e,t,i){const a=i?o.localeIgnoreCaseComparer:o.localeComparer;if(!t||0===t.length)return e;if(!e||0===e.length)return t;(0,w.sortIfNotSorted)(e,a),(0,w.sortIfNotSorted)(t,a);const s=[];(0,w.flagSorted)(s,a);let r=0;const n=e.length;let l=0;const d=t.length;let u,h,c;for(;r<n&&l<d;)u=e[r],h=t[l],c=a(u,h),0===c?(s[s.length]=u,r++,l++):c>0?(s[s.length]=h,l++):(s[s.length]=u,r++);for(;r<n;)s[s.length]=e[r],r++;for(;l<d;)s[s.length]=t[l],l++;return s}function O(e){return e.workItem.isReadOnly()}function P(e){if(e.workItem.isReadOnly()||O(e)||!L.isEditable(e.fieldDefinition))return!1;let t=e.fieldDefinition.id;switch(t){case r.CoreField.Rev:case r.CoreField.WorkItemType:case r.CoreField.CreatedBy:case r.CoreField.IsDeleted:return!1;case r.CoreField.AreaPath:t=r.CoreField.AreaId;break;case r.CoreField.IterationPath:t=r.CoreField.IterationId;break;default:return 0==(2&e.status)}const i=e.workItem.getFieldById(t);return!!i&&P(i)}function V(e){return h(e,r.FieldType.String).value}function A(e,t){if(!e.allowedValues){const i=b(e,t);e.allowedValues=new n.ObservableArray(i)}return e.allowedValues}function b(e,t){let i=[];const a=t.store;if(k(e)){const s=e.lists;if(s.allowedValues&&s.allowedValues.length>0){i=F(a,s.allowedValues[0].items,s.allowedValues[0].globals);for(const e of s.allowedValues)i=y(i,F(a,e.items,e.globals),!0)}if(s.suggestedValues&&s.suggestedValues.length>0){let e=[];for(const t of s.suggestedValues)e=_(e,F(a,t.items,t.globals),!0);i=i.length?y(i,e):e}if(s.allowExistingValue){const a=t.getFieldValueById(e.fieldDefinition.id,!0);E(a)||(i=i.length?_(i,[V(a)],!0):[V(a)])}if(i.length&&s.prohibitedValues&&s.prohibitedValues.length>0)for(const e of s.prohibitedValues)i=S(i,F(a,e.items,e.globals),!0)}return v(e.fieldDefinition.type)?(0,w.sortIfNotSorted)(i,((e,t)=>e-t)):e.fieldDefinition.id===r.CoreField.State&&e.fieldDefinition.workItemType&&e.fieldDefinition.workItemType.orderedStates&&e.fieldDefinition.workItemType.orderedStates.length>0?i=e.fieldDefinition.workItemType.orderedStates.filter((e=>-1!==i.indexOf(e))):(0,w.sortIfNotSorted)(i,o.localeComparer),i}function M(e){return e&&e.fieldDefinition&&e.fieldDefinition.isIdentity}t[e].resetField=function(e){e.status=0,e.allowedValues=void 0,e.lists=void 0},t[e].compareFieldValues=function e(t,i,a,s){if(t instanceof R.ServerDefaultValue)return i instanceof R.ServerDefaultValue&&t.type===i.type&&e(t.value,i.value,a);if(i instanceof R.ServerDefaultValue)return!1;null==(t=(0,d.convertPotentialIdentityRefFromFieldValueNotAsIdentityRef)(t))&&(t=""),null==(i=(0,d.convertPotentialIdentityRefFromFieldValueNotAsIdentityRef)(i))&&(i="");const r=""+t,n=""+i;let l=!1;if(l=a?0===(0,o.localeIgnoreCaseComparer)(r,n):0===(0,o.localeComparer)(r,n),!l&&s){const e=(0,d.parseUniquefiedIdentityName)(r),t=(0,d.parseUniquefiedIdentityName)(n);e&&t&&e.uniqueName&&t.uniqueName&&(l=0===(0,o.localeIgnoreCaseComparer)(e.uniqueName,t.uniqueName))}return l},t[e].convertFieldValueToExternal=function(e,t){return void 0===e&&(e=null),null===e&&I(t)?e="":t===r.FieldType.Boolean&&(e=!!e),e},t[e].convertFieldValueToInternal=h,t[e].tryNormalizeFieldValue=function(e,t){if(e&&"string"==typeof e&&k(t)){e=m(A(t,t.workItem).value,e)}return e},t[e].isValidStringFieldValue=c,t[e].isStringField=I,t[e].normalizeFieldValue=m,t[e].fieldHashset=g,t[e].getFieldErrorText=function(e,t){const i=f(e.status),a=e.error;switch(i){case T.FieldStatus.InvalidEmpty:return(0,o.format)(C.FieldStatusInvalidEmptyError,e.fieldDefinition.name);case T.FieldStatus.InvalidNotEmpty:return(0,o.format)(C.FieldStatusInvalidNotEmptyError,e.fieldDefinition.name);case T.FieldStatus.InvalidFormat:return(0,o.format)(C.FieldStatusInvalidFormatError,e.fieldDefinition.name);case T.FieldStatus.InvalidListValue:return(0,o.format)(C.FieldStatusInvalidListValueError,e.fieldDefinition.name,t);case T.FieldStatus.InvalidOldValue:return(0,o.format)(C.FieldStatusInvalidOldValueError,e.fieldDefinition.name);case T.FieldStatus.InvalidNotOldValue:return(0,o.format)(C.FieldStatusInvalidNotOldValueError,e.fieldDefinition.name);case T.FieldStatus.InvalidEmptyOrOldValue:return(0,o.format)(C.FieldStatusInvalidEmptyOrOldValueError,e.fieldDefinition.name);case T.FieldStatus.InvalidNotEmptyOrOldValue:return(0,o.format)(C.FieldStatusInvalidNotEmptyOrOldValueError,e.fieldDefinition.name);case T.FieldStatus.InvalidValueInOtherField:return(0,o.format)(C.FieldStatusInvalidValueInOtherFieldError,e.fieldDefinition.name);case T.FieldStatus.InvalidValueNotInOtherField:return(0,o.format)(C.FieldStatusInvalidValueNotInOtherFieldError,e.fieldDefinition.name);case T.FieldStatus.InvalidDate:return(0,o.format)(C.FieldStatusInvalidDateErrorError,e.fieldDefinition.name);case T.FieldStatus.InvalidTooLong:return(0,o.format)(C.FieldStatusInvalidTooLongError,e.fieldDefinition.name);case T.FieldStatus.InvalidType:return(0,o.format)(C.FieldStatusInvalidTypeError,e.fieldDefinition.name);case T.FieldStatus.InvalidComputedField:return(0,o.format)(C.FieldStatusInvalidComputedFieldError,e.fieldDefinition.name);case T.FieldStatus.InvalidPath:return(0,o.format)(C.FieldStatusInvalidPathError,e.fieldDefinition.name);case T.FieldStatus.InvalidCharacters:return(0,o.format)(C.FieldStatusInvalidCharactersError,e.fieldDefinition.name);case T.FieldStatus.InvalidIdentity:return a||(0,o.format)(C.FieldStatusInvalidListValueError,e.fieldDefinition.name,t);default:return(0,o.format)(C.FieldStatusInvalidUnknownError,e.fieldDefinition.name)}},t[e].getFieldStatus=f,t[e].isLongTextField=p,t[e].isUserChange=function(e,t){return!!t&&(!t.setByRule||0!=(512&e.status))},t[e].fieldHasList=k,t[e].isNumericField=v,t[e].isEmpty=E,t[e].inList=function(e,t,i,a,s){let r;if(i&&D(i,t,s))return!0;if(a)for(const i of a){if(r=e.getConstantSet(i),!r)throw new Error((0,o.format)("Constant set {0} is not ready. Operation cannot continue.",i));if(D(r,t,s))return!0}return!1},t[e].intersect=y,t[e].unionLists=F,t[e].contains=D,t[e].subtract=S,t[e].union=_,t[e].isMatch=function(e,t){return!e||(e="^"+(e=(e=e.replace(/[.*+?|()\[\]\^\${}\\]/g,"\\$&")).replace(/n/gi,"\\d").replace(/a/gi,"[a-zA-Z]").replace(/x/gi,"[a-zA-Z0-9]"))+"$",new RegExp(e,"i").test(t))},t[e].isHistoricalRevision=O,t[e].isEditable=P,t[e].isReadOnly=function(e){return!P(e)},t[e].isRequired=function e(t){let i=t.fieldDefinition.id;switch(i){case r.CoreField.IterationPath:i=r.CoreField.IterationId;break;case r.CoreField.AreaPath:i=r.CoreField.AreaId;break;default:return 0!=(1&t.status)}return e(t.workItem.getFieldById(i))},t[e].canSortBy=function(e){return 0!=(e.status&r.FieldFlags.Sortable)},t[e].isQueryable=function(e){return 0!=(e.status&r.FieldFlags.Queryable)},t[e].convertFieldValueToDisplayString=V,t[e].getAllowedFieldValues=A,t[e].computeAllowedFieldValues=b,t[e].setAllowedFieldValues=function(e,t){k(e)&&!M(e)&&(e.allowedValues?e.allowedValues.value=t:e.allowedValues=new n.ObservableArray(t))},t[e].isIdentityPickerSupportedForField=M,t[e].isFieldValid=function(e){return 0==(2147479552&e.status)},t[e].htmlDecode=function(e){var t;return null!==(t=(new DOMParser).parseFromString(e,"text/html").documentElement.innerText)&&void 0!==t?t:e}}("WorkItemFieldUtils"),function(e){O=t[e]={},function(e){e[e.Value=1]="Value",e[e.CurrentValue=2]="CurrentValue",e[e.OriginalValue=4]="OriginalValue",e[e.OtherFieldCurrentValue=8]="OtherFieldCurrentValue",e[e.OtherFieldOriginalValue=16]="OtherFieldOriginalValue",e[e.CurrentUser=32]="CurrentUser",e[e.Clock=64]="Clock"}(t[e].RuleValueFrom||(t[e].RuleValueFrom={}))}("RuleEngineRuleValueFrom"),function(e){P=t[e]={};class i extends S.FilterByScope{constructor(e,t,i,a,s){super(e,t),this.nonIdentities=i||[],this.displayNames=a||[],this.excludeGroups=s||!1}static equals(e,t){if(null==e&&null==t)return!0;if(S.FilterByScope.GetHashCode(e)!==S.FilterByScope.GetHashCode(t))return!1;if((null==e.nonIdentities?0:e.nonIdentities.length)!=(null==t.nonIdentities?0:t.nonIdentities.length))return!1;const i=null==e.nonIdentities?"":e.nonIdentities.sort().join(","),a=null==t.nonIdentities?"":t.nonIdentities.sort().join(",");return 0===(0,o.localeIgnoreCaseComparer)(i,a)}}t[e].WorkItemIdentityScope=i}("RuleEngineWorkItemIdentityScope"),function(e){V=t[e]={},t[e].stateFieldID=2;class i{constructor(e,t,i,a,s,r,n){this.executionPhase=T.RuleEvaluatorExecutionPhase.DefaultRules,this.userChange=!1,this.valueLocked=!1,this.setByRule=!1,this.valueChanged=!1,this.setByDefaultRule=!1,this.setByComputedRule=!1,this.readOnly=!1,this.empty=!1,this.required=!1,this.frozen=!1,this.cannotLoseValue=!1,this.otherFields={},this.allowExistingValue=!1,this.validUser=!1,this.serverDefault=!1,this.isIdentityField=!1,this.whenCount=0,this.fieldId=e,this.workItem=t,this.field=i,this.value=a,this.originalValue=s,this.valueLocked=r,this.userChange=r,this.evalState=n,this.isIdentityField=i.fieldDefinition.isIdentity}static compareLists(e,t){let i,a;if(e!==t){if(!e||!t)return!1;if(i=e.length,i!==t.length)return!1;for(a=0;a<i;a++){if(e[a].items!==t[a].items)return!1;if(e[a].globals!==t[a].globals)return!1}}return!0}static compareFieldLists(e,t){if(e!==t){if(!e||!t)return!1;if(e.allowExistingValue!==t.allowExistingValue)return!1;if(!i.compareLists(e.allowedValues,t.allowedValues))return!1;if(!i.compareLists(e.suggestedValues,t.suggestedValues))return!1;if(!i.compareLists(e.prohibitedValues,t.prohibitedValues))return!1}return!0}static getRelatedFieldIds(e){let t=0;const i=new Set;for(;t<e.length;){const a=e[t++],s=e[t++]||[];switch(a){case"When":case"WhenWas":s[1]&&i.add(s[1]),s[4]&&this.getRelatedFieldIds(s[4]).forEach((e=>i.add(e)));break;case"WhenChanged":s[1]&&i.add(s[1]),s[2]&&this.getRelatedFieldIds(s[2]).forEach((e=>i.add(e)))}}return Array.from(i)}evaluate(e){try{e&&(this.setExecutionPhase(T.RuleEvaluatorExecutionPhase.CopyRules),this.Block(e),this.setExecutionPhase(T.RuleEvaluatorExecutionPhase.DefaultRules),this.Block(e),this.setExecutionPhase(T.RuleEvaluatorExecutionPhase.OtherRules),this.Block(e)),this.validate()}catch(t){const i=`Error occured in Rule Engine Evaluate. Name: ${t.Name} Message: ${t.message} Rules.length: ${null==e?void 0:e.length} Rules.Information: ${null==e?void 0:e.toString()} Stack: ${t.stack}`,a=new Error(i);console.error(a)}}setExecutionPhase(e){this.executionPhase=e}Block(e){var t;let i=0;const a=e.length;for(;i<a;){const a=e[i++],s=e[i++]||[];null===(t=this[a])||void 0===t||t.apply(this,s)}}ScopedIdentity(e,t,i,a,s){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.whenCount>0||!this.filterByScope)&&(this.filterByScope=new P.WorkItemIdentityScope(i,t,e,a,s))}BlockWhenChangedProhibitedValuesOnly(e,t){let i=0;const a=t.length;for(;i<a;){const a=t[i++],s=t[i++]||[];if("ProhibitedValues"===a&&s[0]&&s[0]instanceof Array){const t=s[0].filter((t=>t!==e));this.ProhibitedValues(t,s[1])}}}When(e,t,i,a,s){i=this._getValueFrom(a,i);const r=this._isIdentityField(t),n=a==O.RuleValueFrom.Value&&r;(this._areValuesEqual(t,this._getFieldValue(t,!1),i,!0,n)?!e:e)&&(this.whenCount++,this.Block(s),this.whenCount--)}WhenWas(e,t,i,a,s){i=this._getValueFrom(a,i);const r=this._isIdentityField(t),n=a==O.RuleValueFrom.Value&&r;(this._areValuesEqual(t,this._getFieldValue(t,!0),i,!0,n)?!e:e)&&(this.whenCount++,this.Block(s),this.whenCount--)}WhenChanged(i,a,s){const r=this._areValuesEqual(a,this._getFieldValue(a,!1),this._getFieldValue(a,!0),!0);(r?i:!i)?(this.whenCount++,this.Block(s),this.whenCount--):a==t[e].stateFieldID&&r&&!i&&(this.whenCount++,this.BlockWhenChangedProhibitedValuesOnly(this._getFieldValue(a,!0),s),this.whenCount--)}WhenBecameNonEmpty(e,t,i){(this._areValuesEqual(t,this._getFieldValue(t,!0),null,!0)&&!this._areValuesEqual(t,this._getFieldValue(t,!1),null,!0)?!e:e)&&(this.whenCount++,this.Block(i),this.whenCount--)}WhenRemainedNonEmpty(e,t,i){(this._areValuesEqual(t,this._getFieldValue(t,!0),null,!0)||this._areValuesEqual(t,this._getFieldValue(t,!1),null,!0)?e:!e)&&(this.whenCount++,this.Block(i),this.whenCount--)}OtherField(e,t,i){if(this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules){const a=this._getFieldValue(e,i);this.otherFields[e]=a,this.otherFieldCheck=t,"same-as"===t&&!this.userChange&&i&&(this.value=a,this.setByRule=!0,this.valueChanged=!0)}}Map(e,t,i,a){if(this.executionPhase===T.RuleEvaluatorExecutionPhase.CopyRules){const s=this._getFieldValue(e,!1);let r;if(t){const t=this.evalState[e+""],a=t&&void 0!==t.prevValue?t.prevValue:this._getFieldValue(e,!1);if(!this._areValuesEqual(e,this._getFieldValue(e,!1),a,!0)&&!this.userChange){let t;if(null!=i)for(const a of i){if(a.values)for(const i of a.values)if(this._areValuesEqual(e,s,i,!0)){t=a.case;break}if(t)break}void 0===t||this._areValuesEqual(e,t,this.value,!0)||(this.value=t,this.valueLocked=!0,this.setByRule=!0,this.valueChanged=!0)}}else{if(!this.userChange){if(null!=i)for(const t of i)if(this._areValuesEqual(e,s,t.case,!0)){r=t;break}if(r||(r=a),r){let t=!1;if(r.values)for(const i of r.values)if(this._areValuesEqual(e,i,this.value,!0)){t=!0;break}t||(r.default?r.values instanceof Array&&r.values.includes(this.originalValue)?(this.value=this.originalValue,this.valueLocked=!0,this.setByRule=!0,this.valueChanged=!0):this._areValuesEqual(e,r.default,this.value,!0)||(this.value=r.default,this.valueLocked=!0,this.setByRule=!0,this.valueChanged=!0):(this.value=r.values&&r.values[0],this.valueLocked=!0,this.setByRule=!0,this.valueChanged=!0))}}this.allowedValues||(this.allowedValues=[]);let t=[];if(null!=i)for(const a of this._getAllowedValues(e)){let s;for(const t of i)if(this._areValuesEqual(e,a,t.case,!0)){s=t;break}s&&(t=(0,N.union)(t,s.values,!0))}a&&(t=(0,N.union)(t,a.values,!0)),this.allowedValues.push({items:t})}}}AllowExistingValue(){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.allowExistingValue=!0)}ReadOnly(){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.readOnly=!0,this.userChange||(this.value=this.originalValue,this.setByRule=!0,this.valueChanged=!0))}Empty(){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.empty=!0,this.userChange||(this.value=void 0,this.setByRule=!0,this.valueChanged=!0))}Required(){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.required=!0)}Frozen(){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.frozen=!0,!this.userChange&&this.originalValue&&(this.value=this.originalValue,this.setByRule=!0,this.valueChanged=!0))}CannotLoseValue(){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.cannotLoseValue=!0)}ValidUser(){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.validUser=!0)}Copy(e,t){this.executionPhase===T.RuleEvaluatorExecutionPhase.CopyRules&&(this.valueLocked||(this.value=this._getValueFrom(e,t),this.valueLocked=!0,this.setByRule=!0,this.valueChanged=!0))}Default(e,t){this.executionPhase===T.RuleEvaluatorExecutionPhase.DefaultRules&&(this.valueLocked||(0,N.isEmpty)(this.value)&&(this.value=this._getValueFrom(e,t),this.valueLocked=!0,this.setByRule=!0,this.setByDefaultRule=!0,this.valueChanged=!0))}AllowedValues(e,t){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.allowedValues||(this.allowedValues=[]),e&&(0,w.flagSorted)(e,o.localeIgnoreCaseComparer),this.allowedValues.push({items:e,globals:t}))}SuggestedValues(e,t){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.suggestedValues||(this.suggestedValues=[]),e&&(0,w.flagSorted)(e,o.localeIgnoreCaseComparer),this.suggestedValues.push({items:e,globals:t}))}ProhibitedValues(e,t){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.prohibitedValues||(this.prohibitedValues=[]),e&&(0,w.flagSorted)(e,o.localeIgnoreCaseComparer),this.prohibitedValues.push({items:e,globals:t}))}Match(e,t){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&(this.patterns||(this.patterns=[]),e&&(0,w.flagSorted)(e,o.localeIgnoreCaseComparer),this.patterns.push({items:e,globals:t}))}ServerDefault(e){this.executionPhase===T.RuleEvaluatorExecutionPhase.CopyRules&&(this.value=new R.ServerDefaultValue(e,this.originalValue),this.serverDefault=!0,this.valueLocked=!0,this.setByRule=!0,this.setByDefaultRule=!0,this.valueChanged=!0)}Computed(e){if(this.executionPhase===T.RuleEvaluatorExecutionPhase.DefaultRules&&!this.valueLocked){const t=this.workItem.computeFieldValue(this.field.fieldDefinition.id,e);t&&t.success&&(this.value=t.value,this.valueLocked=!0,this.setByRule=!0,this.setByComputedRule=!0,this.valueChanged=!0)}}Trigger(e){this.executionPhase===T.RuleEvaluatorExecutionPhase.OtherRules&&e&&(this.triggerFields||(this.triggerFieldMap={},this.triggerFields=[]),e.forEach(((e,t)=>{const i=e+"";this.triggerFieldMap.hasOwnProperty(i)||(this.triggerFieldMap[i]=!0,this.triggerFields.push(e))})))}validate(){let e;const t=this.field;this.originalFieldStatus=t.status,t.status=0;const a=t.workItem.store;let s,n;if(s=(0,N.convertFieldValueToInternal)(this.originalValue,t.fieldDefinition.type,this.readOnly),n=(0,N.convertFieldValueToInternal)(this.value,t.fieldDefinition.type,this.readOnly),e=n.value,t.status|=n.status,this.setByRule){const i={setByRule:!0,readOnly:this.readOnly};this.workItem.setFieldValueById(t.fieldDefinition.id,e,i),t.status|=128}this.setByDefaultRule&&(t.status|=256),this.setByComputedRule&&(t.status|=512),(this.readOnly||this.serverDefault||this.empty)&&(t.status|=2),this.cannotLoseValue&&((0,N.isEmpty)(this.originalValue)||(this.required=!0)),this.required&&(t.status|=1);const o={};o.allowedValues=this.allowedValues,this.allowedValues&&this.allowedValues.length>0&&(t.status|=4,t.status|=8),o.suggestedValues=this.suggestedValues,this.suggestedValues&&this.suggestedValues.length>0&&(t.status|=4,t.status&=-9),o.prohibitedValues=this.prohibitedValues,o.allowExistingValue=this.allowExistingValue,i.compareFieldLists(t.lists,o)||(t.lists=o,t.allowedValues=void 0),this.allowExistingValue&&(t.status|=64);let l=[];if(this.patterns&&this.patterns.length>0){l=(0,N.unionLists)(a,this.patterns[0].items,this.patterns[0].globals);for(const e of this.patterns)l=(0,N.intersect)(l,(0,N.unionLists)(a,e.items,e.globals),!0)}if(t.fieldDefinition.isIdentity&&(t.filterByScope=this.filterByScope),t.patterns=l,l.length>0&&(t.status|=16),(0,N.isEmpty)(e)){if(!this.empty){if((0,N.isRequired)(t))return t.status|=1,void(t.status|=524288);if(void 0!==this.otherFieldCheck)for(const e in this.otherFields)if((0,N.isEmpty)(this.otherFields[e])){if("not-same-as"===this.otherFieldCheck)return t.status|=1,void(t.status|=268435456)}else if("same-as"===this.otherFieldCheck)return t.status|=1,void(t.status|=134217728)}}else{if(this.empty)return t.status&=-3,void(t.status|=1048576);if(!this.readOnly||this.serverDefault||this.setByDefaultRule||this._areValuesEqual(t.fieldDefinition.id,e,s.value)){if(void 0!==this.otherFieldCheck)for(const i in this.otherFields)if(this._areValuesEqual(t.fieldDefinition.id,e,this.otherFields[i])){if("not-same-as"===this.otherFieldCheck)return void(t.status|=134217728)}else if("same-as"===this.otherFieldCheck)return void(t.status|=268435456);if(!this.frozen||(0,N.isEmpty)(s.value)||this._areValuesEqual(t.fieldDefinition.id,e,s.value)){if(t.fieldDefinition.type===r.FieldType.TreePath&&!this.workItem.isChangeProjectInProgress()){if(!this.workItem.project.getNode(e,t.fieldDefinition.id===r.CoreField.AreaPath?0:1))throw new Error("Node not found:"+e)}if(!(this.serverDefault||e instanceof R.ServerDefaultValue)){const i=null==e?"":""+e;if(t.patterns.length>0){let e=!1;for(const a of t.patterns)if((0,N.isMatch)(a,i)){e=!0;break}if(!e)return void(t.status|=2097152)}if(o.prohibitedValues)for(const e of o.prohibitedValues)if((0,N.inList)(a,i,e.items,e.globals,!0))return void(t.status|=4194304);if(this.allowExistingValue&&!(0,N.isEmpty)(s.value)&&this._areValuesEqual(t.fieldDefinition.id,e,s.value))return;if(o.allowedValues)for(const e of o.allowedValues)if(!(0,N.inList)(a,i,e.items,e.globals,!0))return void(t.status|=4194304)}}else t.status|=67108864}else t.status|=16777216}}_isIdentityField(e){const t=this.workItem.getFieldById(e);return t&&t.fieldDefinition.isIdentity}_getFieldValue(e,t){return e===this.fieldId?t?this.originalValue:this.value:this.workItem.getFieldValueById(e,t)}_getValueFrom(e,t){switch(e){case O.RuleValueFrom.Clock:return new Date;case O.RuleValueFrom.CurrentUser:return this.workItem.store.getCurrentUserName();case O.RuleValueFrom.OtherFieldOriginalValue:return this._getFieldValue(t,!0);case O.RuleValueFrom.OtherFieldCurrentValue:return this._getFieldValue(t,!1);case O.RuleValueFrom.Value:return t;case O.RuleValueFrom.CurrentValue:return this.value;case O.RuleValueFrom.OriginalValue:return this.originalValue;default:return t}}_areValuesEqual(e,t,i,a,s){return this.workItem.fieldMapById[e]&&this.workItem.fieldMapById[e].fieldDefinition.type===r.FieldType.Boolean&&(t=this._translateToBoolData(t),i=this._translateToBoolData(i)),this.workItem.fieldMapById[e]&&this.workItem.fieldMapById[e].fieldDefinition.type===r.FieldType.Double&&(t=this._removeTrailingStringDecimalZeroes(t),i=this._removeTrailingStringDecimalZeroes(i)),(0,N.compareFieldValues)(t,i,a,s)}_removeTrailingStringDecimalZeroes(e){return"string"==typeof e?e.replace(/(\.[1-9]*)0+$/g,"$1"):e}_translateToBoolData(e){return!e||1!=e&&"true"!==String(e).toLowerCase()?0:1}_getAllowedValues(e){const t=this.workItem.getFieldById(e);return t?(0,N.getAllowedFieldValues)(t,this.workItem).value:[]}}t[e].RuleEvaluator=i}("RuleEngineRuleEvaluator"),function(e){A=t[e]={};t[e].RuleEngine=class{constructor(e,t){var i;if(this.workItem=e,this.fieldRules={},t)for(const e of t){this.fieldRules[e.fieldId]=null!==(i=this.fieldRules[e.fieldId])&&void 0!==i?i:[];const t=this.fieldRules[e.fieldId];t.push("Block"),t.push([e.rules])}}evaluateFields(e){const t={};for(const i of e)this._evaluateFieldRule(i,t,!1);return this._evalStateToChangedFields(t)}evaluateField(e,t,i){const a={};return this._evaluateFieldRule(e,a,t,i),this._evalStateToChangedFields(a)}_evalStateToChangedFields(e){const t=[];for(const[i,a]of Object.entries(e))a.requiresControlUpdate&&t.push(parseInt(i));return t}_evaluateFieldRule(e,t,i,a){const s=this.workItem.getFieldById(e);if(!s)return;const r=this.workItem.getFieldValueById(e),n=s.lists,o=s.status;let l=!1;t[e]&&t[e].requiresControlUpdate&&(l=!0),t[e]={state:!0,prevValue:void 0===a?r:a,requiresControlUpdate:l};const d=new V.RuleEvaluator(e,this.workItem,s,r,this.workItem.getFieldValueById(e,!0),i||!1,t);let u;d.evaluate(this.fieldRules[e]),u=!!i||(!(0,N.compareFieldValues)(r,this.workItem.getFieldValueById(e))||!V.RuleEvaluator.compareFieldLists(n,s.lists)||0!=(o^s.status)),u&&(t[e].requiresControlUpdate=!0),u&&d.triggerFields&&d.triggerFields.forEach(((e,i)=>{const a=t[e];a&&a.state||this._evaluateFieldRule(e,t,!1)})),t[e].state=!1}}}("RuleEngineRuleEngine"),function(e){b=t[e]={};t[e].WorkItemStore=class{constructor(e,t){this._pageContext=e,this.constantSets=t}getCurrentUserName(){return this.getCurrentUser().distinctDisplayName}getCurrentUser(){const e=this._pageContext.getService("IVssPageService").getData().user,t=e.displayName,i=e.uniqueName;return{distinctDisplayName:(0,d.getDistinctDisplayName)(t,i),identityRef:{id:e.id,displayName:t,uniqueName:i}}}getConstantSet(e){return e in this.constantSets?this.constantSets[e]:(console.error("Could not find set ID:"+e),[])}}}("RuleEngineWorkItemStore"),function(e){M=t[e]={},function(e){e.WorkItemErrorUpdated="WorkItemErrorUpdated",e.WorkItemReset="WorkItemReset",e.WorkItemSaved="WorkItemSaved",e.WorkItemUpdated="WorkItemUpdated",e.WorkItemCommentsUpdated="WorkItemCommentsUpdated",e.WorkItemTemplateApplied="WorkItemTemplateApplied"}(t[e].IWorkItemEventType||(t[e].IWorkItemEventType={}));class i extends u.VssObservableService{fireEvent(e,t){this._notify(e,t)}}u.Services.add("IWorkItemEventService",{serviceFactory:i})}("ServicesIWorkItemEventService"),function(e){B=t[e]={},function(e){e.WorkItemFieldsUpdated="WorkItemFieldsUpdated"}(t[e].IWorkItemFieldEventType||(t[e].IWorkItemFieldEventType={}));class i extends u.VssObservableService{fireEvent(e,t){this._notify(e,t)}}u.Services.add("IWorkItemFieldEventService",{serviceFactory:i})}("ServicesIWorkItemFieldEventService"),t.ServicesIWorkItemModelService={},function(e){U=t[e]={};t[e].WorkItemType=class{constructor(e,t,i,a){this.project=i,this.name=t.name,this.referenceName=t.referenceName,this.dependentFieldsMap={},this._httpClient=(0,h.getWorkItemTrackingClient)(e);const s=t.fields;this.triggerList=t.rules.triggerList,this.fieldMap={},this.fieldMapById={},this.fields=[];for(const e of s){const t=a[e];t&&(this.fieldMapById[t.id]=t,this.fieldMap[t.name.toUpperCase()]=t,this.fieldMap[t.referenceName.toUpperCase()]=t,this.fields.push(t))}}beginGetDependentFields(e,t,i,a){const s=this.fieldMapById[e];s?this.dependentFieldsMap.hasOwnProperty(e)?i(this.dependentFieldsMap[e]):this._httpClient.getWorkItemTypeFieldWithReferences(this.project.guid,this.name,s.referenceName,2).then((a=>{const s=(a.dependentFields||[]).map((e=>t.fieldMap[e.referenceName.toUpperCase()].fieldDefinition));this.dependentFieldsMap[e]=s,i(s)}),(e=>{a(""+e)})):a((0,o.format)("Field {0} doesn't exist in work item type {1}",e,this.name))}getTriggerList(){const e=[];return this.triggerList&&this.triggerList.forEach((t=>{e.push(t)})),e}},t[e].getTriggerList=function(e,t){const i=[];return e.rules&&e.rules.triggerList&&e.rules.triggerList.forEach((e=>{t(e)&&i.push(e)})),i}}("WorkItemWorkItemType"),function(e){x=t[e]={};t[e].Project=class{constructor(e){var t,i;this.projectData=e,this.nodesById={},this.areaNodesByPath={},this.iterationNodesByPath={},this.id=e.id,this.name=e.name,this.guid=e.guid,this.workItemTypeNames=e.workItemTypes,this.fieldIds=e.fieldIds,this.extras=e.extras||{},this.process=e.process,this.relatedData={};const a={children:[],promises:[],hasChildren:!0,id:e.id,name:e.name,attributes:{},path:e.name,url:"",structureType:0,identifier:e.guid,_links:{}};e.areaNodes&&a.children.push(e.areaNodes),e.iterationNodes&&a.children.push(e.iterationNodes),e.areaNodesPromise&&(null===(t=a.promises)||void 0===t||t.push(e.areaNodesPromise)),e.iterationNodesPromise&&(null===(i=a.promises)||void 0===i||i.push(e.iterationNodesPromise)),this.addNodeTreeToCache(a,0,""),Array.isArray(this.workItemTypeNames)&&this.workItemTypeNames.sort(o.localeIgnoreCaseComparer),this.workItemTypes={}}getNodeById(e){return e in this.nodesById?this.nodesById[e]:void 0}getNode(e,t){let i;return i=0===t?this.areaNodesByPath:this.iterationNodesByPath,e in i?i[e]:void 0}addNodeTreeToCache(e,t,i){let a;a=t>1?i+"\\"+e.name:1===t?i:e.name,this.addSingleNodeToCache(e,t,a),e.children&&e.children.forEach((e=>{this.addNodeTreeToCache(e,t+1,a)})),e.promises&&e.promises.forEach((e=>{e.then((e=>{e&&this.addNodeTreeToCache(e,t+1,a)}))}))}addSingleNodeToCache(e,t,i){const a=Object.assign({},e);a.path=i,this.nodesById[e.id]=a,1!==t&&(0!==e.structureType&&0!==t||(this.areaNodesByPath[i]=a),1!==e.structureType&&0!==t||(this.iterationNodesByPath[i]=a))}}}("WorkItemProject"),function(e){t[e]={};class i extends u.VssService{constructor(){super(...arguments),this.fieldProjectDataWithNodes=new Map,this.mapIsProjectLoadedObservableValue=new Map,this.projectDataMap=new Map,this.projectsMap=new Map,this.projectPromiseMap=new Map,this.projectFieldLookup=new Map}_serviceStart(e){super._serviceStart(e),this.nodeService=e.getService("IWorkItemNodeService"),this.workItemDataManager=e.getService("IWorkItemDataManager")}getProject(e){return this.projectsMap.get(e)}getObservableProjectLoadingStateValue(e){return this.mapIsProjectLoadedObservableValue.get(e)}async updateProjectNodes(e){await this.nodeService.updateNodes(e);const t=this._getProjectAsync(e);this.projectPromiseMap.has(e)&&this.projectPromiseMap.delete(e),this.projectPromiseMap.set(e,t);const i=await t;i&&(this.projectsMap.has(e)&&this.projectsMap.delete(e),this.projectsMap.set(e,i))}async getProjectAsync(e,t){if(this.projectsMap.has(e)&&!t)return this.projectsMap.get(e);if(this.projectPromiseMap.has(e))return this.projectPromiseMap.get(e);const i=this._getProjectAsync(e,t);this.projectPromiseMap.set(e,i);const a=await i;return this.projectPromiseMap.delete(e),a?(this.projectsMap.set(e,a),a):void 0}getFieldLookup(e){return this.projectFieldLookup.get(e)}async _getProjectAsync(e,t){const i=await this.getFieldProjectDataAsync(e);if(!i)return;const a=this.nodeService.getAreaPathNodes(e),s=this.nodeService.getIterationNodes(e);this.fieldProjectDataWithNodes.set(e,Object.assign(Object.assign({},i.projects[0]),{areaNodesPromise:a,iterationNodesPromise:s}));const r=new x.Project(this.fieldProjectDataWithNodes.get(e)),n={};return i.fields.forEach((e=>{n[e.id]=e,n[e.referenceName]=e})),this.projectFieldLookup.set(e,n),r}async getFieldProjectDataAsync(e,t){if(this.projectDataMap.has(e)&&!t)return this.projectDataMap.get(e);try{const t=await this.workItemDataManager.beginGetFieldProjectData(e);return this.projectDataMap.set(e,t||void 0),this.projectDataMap.get(e)}catch(e){return void console.error(e)}}getFieldProjectData(e){return this.projectDataMap.get(e)}getFieldProjectDataWithNodes(e){return this.fieldProjectDataWithNodes.get(e)}}t[e].ProjectService=i;u.Services.add("IProjectService",{serviceFactory:i})}("ServicesProjectService"),function(e){j=t[e]={};class a{constructor(e){this.linkData=e,this.pendingUpdate=!1,this.pendingDeletion=!1,this.baseLinkType="Link",this.remoteHostId=this.linkData.RemoteHostId}static createFromLinkData(e){(e=e||{}).FldID||(e.FldID=r.DalFields.RelatedLinks);switch(e.FldID){case r.DalFields.AttachedFiles:return new d(e);case r.DalFields.LinkedFiles:return new l(e);case r.DalFields.BISURI:return new n(e);case r.DalFields.RelatedLinks:return new s(e);default:return new a(e)}}static getCountFieldId(e){let t;switch(e){case r.DalFields.AttachedFiles:t=r.CoreField.AttachedFileCount;break;case r.DalFields.RelatedLinks:t=r.CoreField.RelatedLinkCount;break;case r.DalFields.LinkedFiles:t=r.CoreField.HyperLinkCount;break;case r.DalFields.BISURI:t=r.CoreField.ExternalLinkCount;break;default:t=0}return t}setState(e){e?(this.comment=this.getComment(),this.isLocked=this.getIsLocked(),this.pendingUpdate=!1,this.linkData.CommentChanged=!1,this.linkData.LockChanged=!1):this.pendingUpdate=this.linkData.CommentChanged||this.linkData.LockChanged||!1}equals(e){return!!e&&this.baseLinkType===e.baseLinkType}isDuplicate(e){return this.equals(e)}isNew(){const e=this.getAddedDate();return!e||e.getTime()===i.FutureDate.getTime()}isRemoved(){const e=this.getRemovedDate();return(0,W.isRemoved)(e)}isRemote(){return!1}getAddedDate(){return this.linkData.AddedDate}getRemovedDate(){return this.linkData.RemovedDate}getFieldId(){return this.linkData.FldID||-1}getComment(){return this.linkData.Comment}setComment(e,t){this.linkData.Comment=e,this.linkData.CommentChanged=!0,this.setState()}getIsLocked(){return this.linkData.Lock||!1}remove(e){e&&e.preventEvent;this.pendingDeletion=!0}async getRelationType(e){switch(this.linkData.FldID){case r.DalFields.BISURI:return r.WorkItemLinkConstants.ARTIFACTLINKTYPE;case r.DalFields.AttachedFiles:return r.WorkItemLinkConstants.ATTACHEDLINKTYPE;case r.DalFields.LinkedFiles:return r.WorkItemLinkConstants.HYPERLINKLINKTYPE;default:return this instanceof s?(await this.getWitLinkTypeEnd(e)).immutableName:T.RegisteredLinkTypeNames.Related}}getTargetId(){return this.linkData.ID||-1}getLinkType(){var e;return null!==(e=this.linkData.OriginalName)&&void 0!==e?e:T.RegisteredLinkTypeNames.Related}getWitLinkTypeEndId(){var e;return null!==(e=this.linkData.LinkType)&&void 0!==e?e:void 0}async clone(e,t){}getAttributes(){const e={isDeleted:this.pendingDeletion,isNew:this.isNew()};return this._isResourceLinkType(this.linkData.FldID||0)?(e[r.WorkItemLinkConstants.ATTRIBUTES_AUTHORIZEDDATE]=this.linkData.AddedDate,e[r.WorkItemLinkConstants.ATTRIBUTES_ID]=this.linkData.ExtID,e[r.WorkItemLinkConstants.ATTRIBUTES_RESOURCECREATEDDATE]=this.linkData.CreationDate,e[r.WorkItemLinkConstants.ATTRIBUTES_RESOURCEMODIFIEDDATE]=this.linkData.LastWriteDate,e[r.WorkItemLinkConstants.ATTRIBUTES_REVISEDDATE]=this.linkData.RemovedDate,this.linkData.Length&&this.linkData.Length>0&&(e[r.WorkItemLinkConstants.ATTRIBUTES_RESOURCESIZE]=this.linkData.Length),this.linkData.Comment&&(e[r.WorkItemLinkConstants.ATTRIBUTES_COMMENT]=this.linkData.Comment),this.linkData.OriginalName&&(e[r.WorkItemLinkConstants.ATTRIBUTES_NAME]=this.linkData.OriginalName),e):this.linkData.FldID===r.DalFields.RelatedLinks?(e[r.WorkItemLinkConstants.ATTRIBUTES_ISLOCKED]=this.linkData.Lock,this.linkData.Comment&&(e[r.WorkItemLinkConstants.ATTRIBUTES_COMMENT]=this.linkData.Comment),e):{}}async getLinkUrl(e,t){return this._isResourceLinkType(this.linkData.FldID||0)?this.linkData.FilePath||"":this.remoteHostId?this._getRemoteWorkItemRestUrl(this.remoteHostUrl||"",this.remoteProjectId||"",this.linkData.ID||0):await(0,W.getWorkItemUrl)(e,t,this.linkData.ID||0)}_isResourceLinkType(e){switch(e){case r.DalFields.BISURI:case r.DalFields.AttachedFiles:case r.DalFields.LinkedFiles:return!0;default:return!1}}_getRemoteWorkItemRestUrl(e,t,i){return`${e}/${t}/_apis/wit/workItems/${i}`}}t[e].Link=a;class s extends a{constructor(e){super(e),this.baseLinkType="WorkItemLink"}static async create(e,t,i,a,r,n){let o;if("object"==typeof t)o=t.id;else{o=(await s.findLinkTypeEnd(e,t)).id}return s.createSync(o,i,a,r,n)}static createSync(e,t,i,a,n){return new s({ID:t,LinkType:e,Comment:i||"",FldID:r.DalFields.RelatedLinks,isAddedBySystem:a,RemoteHostUrl:n&&n.remoteHostUrl,RemoteProjectId:n&&n.remoteProjectId,RemoteHostId:n&&n.remoteHostId,RemoteHostName:n&&n.remoteHostName})}static async findLinkTypeEnd(e,t){const i=(""+t).toUpperCase(),a=await this.getLinkTypeEnds(e);for(const e of a){if(e.id===t)return e;if(e.name.toUpperCase()===i)return e;if(e.immutableName.toUpperCase()===i)return e}throw Error((0,o.format)(C.WorkItemLinkTypeEndDoesNotExist,t))}static async getLinkTypes(e){const t=e.getService("IWorkItemDataManager"),i=await t.beginGetLinkTypes();if(!i)throw Error();return this._bindLinkTypeEnds(i.witLinkTypes),i.witLinkTypes}static async getLinkTypeEnds(e){let t=this.linkTypeEnds;if(t)return t;const i=await s.getLinkTypes(e);t=[];for(const e of i)t.push(e.forwardEnd),e.isDirectional&&t.push(e.reverseEnd);return this.linkTypeEnds=t,t}static _bindLinkTypeEnds(e){let t;for(const i of e)t=i.forwardEnd,t&&(t.linkType=i,t.oppositeEnd=i.reverseEnd),t=i.reverseEnd,t&&(t.linkType=i,t.oppositeEnd=i.forwardEnd)}equals(e){return super.equals(e)&&e instanceof s&&e.linkData.ID===this.linkData.ID&&e.linkData.LinkType===this.linkData.LinkType}isRemote(){return!!this.remoteHostId}getAddedDate(){return this.linkData["Changed Date"]}getRemovedDate(){return this.linkData["Revised Date"]}getLinkType(){return T.RegisteredLinkTypeNames.Related}async getWitLinkTypeEnd(e){return this._linkTypeEnd||(this._linkTypeEnd=await s.findLinkTypeEnd(e,this.linkData.LinkType)),this._linkTypeEnd}async clone(e,t){const i=await this.getWitLinkTypeEnd(e),a=i.linkType;if(a&&a.isActive&&"Unknown"!==a.topology&&(!a.isOneToMany||!i.isForwardLink)){const t={remoteHostId:this.remoteHostId,remoteHostName:this.remoteHostName,remoteHostUrl:this.remoteHostUrl,remoteProjectId:this.remoteProjectId};return s.create(e,i,this.getTargetId(),this.getComment(),!1,t)}}}t[e].WorkItemLink=s;class n extends a{static create(e,t,a){return new n({OriginalName:e,FilePath:t,Comment:a||"",FldID:r.DalFields.BISURI,AddedDate:i.FutureDate,RemovedDate:i.FutureDate})}constructor(e){super(e),this.baseLinkType="ExternalLink"}equals(e){return super.equals(e)&&e instanceof n&&e.linkData.OriginalName===this.linkData.OriginalName&&e.linkData.FilePath===this.linkData.FilePath}getArtifactLinkType(){return this.linkData.OriginalName}getLinkedArtifactUri(){return this.linkData.FilePath}async clone(e,t){return n.create(this.getArtifactLinkType(),this.getLinkedArtifactUri(),this.getComment())}}t[e].ExternalLink=n;class l extends a{static create(e,t){return new l({OriginalName:"",FilePath:e,Comment:t||"",FldID:r.DalFields.LinkedFiles,AddedDate:i.FutureDate,RemovedDate:i.FutureDate})}equals(e){return super.equals(e)&&e instanceof l&&e.linkData.FilePath===this.linkData.FilePath}async clone(e,t){const a=new Date;return new l(Object.assign(Object.assign({},this.linkData),{CreationDate:a,LastWriteDate:a,AddedDate:i.FutureDate,RemovedDate:i.FutureDate}))}getLinkType(){return this.linkData.OriginalName||T.RegisteredLinkTypeNames.Hyperlink}}t[e].Hyperlink=l;class d extends a{static create(e,t,a,s){const n=new Date;return new d({OriginalName:e,FilePath:t,Comment:s||"",ExtID:0,FldID:r.DalFields.AttachedFiles,Length:a,CreationDate:n,LastWriteDate:n,AddedDate:i.FutureDate,RemovedDate:i.FutureDate})}constructor(e){super(e),this.baseLinkType="Attachment"}equals(e){return super.equals(e)&&e instanceof d&&e.linkData.FilePath===this.linkData.FilePath}async clone(e,t){return d.create(this.linkData.OriginalName,this.linkData.FilePath,this.linkData.Length,this.linkData.Comment)}}t[e].Attachment=d}("WorkItemLinks"),function(e){t.ServicesWorkItemSavingService={};class i extends u.VssService{_serviceStart(e){this.witDataManager=e.getService("IWorkItemDataManager"),this.pageContext=e,this.setErrorOnWorkItemFieldInvalidExceptionFix=!(0,c.isFeatureFlagEnabled)(this.pageContext,I.FeatureFlags.SetErrorOnWorkItemFieldInvalidExceptionFixDisabled,!1)}saveWorkItemsBatchAsync(e,t){const{keepDeletedLinks:i,ignoreWorkItemUpdateTelemetry:a}=t||{};return new Promise(((t,s)=>{this.beginSaveWorkItemsBatch(e,(e=>t(e)),(e=>s(e)),i,a)}))}beginSaveWorkItemsBatch(e,t,i,a,s){const r=this,n=[],o=[],l={},d=[];let u=!1;const h={},c={};e.forEach((e=>{e.isValid()?n.push(e):(u=!0,d.push({workItem:e,error:{name:T.Exceptions.WorkItemSaveFailedDueToInvalidStatusException,message:e.infoText.value.text,workItem:e}}))})),n.length>0&&o.push(n);const I=()=>{if(o.length>0){let t=o.pop()||[];if(t.length>T.PageSizes.SAVE&&(o.push(t.slice(T.PageSizes.SAVE)),t=t.slice(0,T.PageSizes.SAVE)),t.length>T.PageSizes.SAVE)throw new Error("Too many work items for batch save.");r._beginSaveWorkItemsInternal(t,c,l,(()=>{t.forEach((e=>{d.push({workItem:e})})),window.setTimeout((()=>{I()}),0)}),(a=>{let s=0,n=!1,c=!1,m=!1;const g=e=>{if(0===s){if(1===t.length&&e)o.push(t);else if(t.length>1){const e=t.length/2;o.push(t.slice(e)),o.push(t.slice(0,e))}else a.results&&d.push(a.results[0]);window.setTimeout((()=>{I()}),0)}},f=(e,t)=>{s-=1,t=Object.assign(Object.assign({},t),l[e.id]),g(!0)},p=()=>{s-=1,u=!0,g(!1)};if(a&&a.name===T.Exceptions.WorkItemBulkSaveException){const e=a.results;if(e)for(const t of e){const e=t.workItem;!t.error||t.error.errorCode!==T.ErrorCodes.WorkItemMissingOrUpdated&&t.error.errorCode!==T.ErrorCodes.ResourceLinkNotFoundException||h.hasOwnProperty(e.id.toString())?t.error&&t.error.errorCode===T.ErrorCodes.WorkItemFieldInvalidException?(m=!0,this.setErrorOnWorkItemFieldInvalidExceptionFix&&t.workItem.setError(t.error)):c=!0:(n=!0,h[e.id]=!0,s+=1,r._beginTryMergeWorkItem(e,f,p))}!n&&c&&(u=!0),m?null==i||i.call(r,a):g(!1)}else e.forEach((e=>{e.setError(a)})),null==i||i.call(r,a)}),!1,a,s)}else if(u)d.forEach((e=>{e.error&&e.workItem.setError(e.error)})),null==i||i.call(this,this._createWorkItemBulkSaveFailedException(d));else if("function"==typeof t){const i={workItems:e};t.call(r,i)}};I()}beginGetWorkItemData(e,t,i,a,s,r){let n;if(0===e.length&&(n=new Error("Resources.BeginGetWorkItemArgumentNull")),e)for(let t=0,i=e.length;t<i;++t){if(e[t]=+e[t],void 0===e[t]){n=new Error("Resources.WorkItemIdUndefined");break}if(isNaN(e[t])){n=new Error("Resources.WorkItemIdNaN");break}if(e[t]<=0){n=new Error("Resources.WorkItemIdOutOfRange");break}}if(n)return void(n.name="ArgumentException");this.witDataManager.beginGetWorkItemData(e,a,!r,s).then((e=>{e&&1===e.length?t.call(this,e[0]):t.call(this,e)}),i)}async saveWorkItemLinksAsync(e,t,i){const a=[];let s;const r=[],n=[];let o=[];const l=[],d={},u={},h={addedLinks:[]};for(const i of t)a.push({command:"add",sourceId:e.id,targetId:i.getTargetId(),linkData:i.linkData}),h.addedLinks.push(i.linkData);const c=()=>{if(o&&o.length===l.length){for(const e of o)for(const t of e.getLinks())t.setState(!0);I()}},I=()=>{try{return s&&(s=this._createWorkItemBulkSaveFailedException(l),console.warn(this,s)),l}catch(e){throw e}},g=e.getEmptyUpdateData();g.payload&&(g.payload.links=h);const f={changedWorkItemLinks:a};if(g&&g.payload){n.push(g),r.push(g.payload);u[e.id>0?e.id:e.tempId]=f,o.push(e)}try{const e={controller:"wit",action:"updateWorkItems"},t={updatePackage:JSON.stringify(r)};try{const a=(await new m.WorkItemStoreLevelWITDataSource(this.pageContext).getDataWithoutCache(e,t)).data;if(a.length===o.length){let e=!1;for(const t of a)if(t.state!==T.WorkItemUpdateResultState.Success){e=!0;break}for(let t=0;t<o.length;t++){const s=o[t],r=a[t];r.state!==T.WorkItemUpdateResultState.Success||e?r.state!==T.WorkItemUpdateResultState.Success?r.error&&s.setError(r.error):l.push({workItem:s}):(await s.takeUpdateResult(this.pageContext,r,n[t],{ignoreFieldUpdates:!0,fieldsToClear:i}),l.push({workItem:s}),d[s.tempId]=s.id),c()}}else o.forEach((e=>{e.setError({name:"SyncError",message:"Server data does not match with what client sent."})})),I()}catch(s){o.forEach((e=>{e.setError(s)})),I()}}catch(e){throw e}return l}async _beginSaveWorkItemsInternal(e,t,i,a,s,n=!0,o,l){let d,u;const h=[],g={},f=!(0,c.isFeatureFlagEnabled)(this.pageContext,I.FeatureFlags.WorkItemSavingBatchErrorResultFixDisabled,!1),p=(e,t)=>{for(const a of e){const e=g[a.id]?g[a.id]:g[a.tempId];e&&i[a.id]&&Object.assign(e.changedFields,i[a.id]),a.saving.value=t}},k=()=>{try{if(u)u=this._createWorkItemBulkSaveFailedException(h),null==s||s.call(this,u);else{const t={workItems:e};a.call(this,t)}}finally{p(d,!1)}},v=(e,t)=>{let i;"string"==typeof t?i=t:t&&"object"==typeof t&&"message"in t&&"string"==typeof t.message&&(i=t.message),u=new Error(i),n&&e.setError(u),h.push({workItem:e,error:t})},E=()=>{if(d&&d.length===h.length){for(const e of d)for(const t of e.getLinks())t.setState(!0);k()}},y=(e,t)=>{const i={};for(const a in t)if(t.hasOwnProperty(a)){const t=Number(a),s=e.fieldMapById[t];s&&(i[s.fieldDefinition.referenceName]=s,t===r.CoreField.IterationId?i[r.CoreFieldRefNames.IterationPath]=e.fieldMapById[r.CoreField.IterationPath]:t===r.CoreField.AreaId&&(i[r.CoreFieldRefNames.AreaPath]=e.fieldMapById[r.CoreField.AreaPath]))}return i},F=(e,i)=>{var a,s;const n=[];if(i.deletedLinks)for(const t of i.deletedLinks)t instanceof j.WorkItemLink&&n.push({command:"remove",sourceId:e.id,targetId:t.getTargetId(),linkData:t.linkData});if(i.addedLinks)for(const a of i.addedLinks)a instanceof j.WorkItemLink&&(t.hasOwnProperty(a.getTargetId())&&(a.linkData.ID=t[a.getTargetId()]),n.push({command:"add",sourceId:e.id,targetId:a.getTargetId(),linkData:a.linkData}));let o=!1;(null===(a=i.payload)||void 0===a?void 0:a.fields)&&(o=!!i.payload.fields[r.DalFields.AreaPathId]);return{typeChanged:null!==(s=e.hasWorkItemTypeChanged())&&void 0!==s?s:o,projectChanged:e.hasTeamProjectChanged(),changedFields:i.payload&&i.payload.fields?y(e,i.payload.fields):{},changedWorkItemLinks:n,firstSave:0==e.id}};if(e&&e.length>0){const i=[],a=[];d=[];let s=!1;for(let t=0;t<e.length;t++){const r=e[t];try{await r.waitForPromisesResolving()}catch(e){v(r,e),s=!0}if(r.dirty.value){const e=r.getUpdateData();if(e&&e.payload){a.push(e),i.push(e.payload);const t=r.id>0?r.id:r.tempId;g[t]=F(r,e),d.push(r)}}}if(d.length>0&&!s){p(d,!0);try{const e={controller:"wit",action:"updateWorkItems"},s={updatePackage:JSON.stringify(i)};try{const i=(await new m.WorkItemStoreLevelWITDataSource(this.pageContext).getDataWithoutCache(e,s)).data;if(i.length===d.length){let e=!1;if(!f)for(const t of i)if(t.state!==T.WorkItemUpdateResultState.Success){e=!0;break}for(let s=0;s<d.length;s++){const r=d[s],n=i[s];(f?n.state!==T.WorkItemUpdateResultState.Success:n.state!==T.WorkItemUpdateResultState.Success||e)?n.state!==T.WorkItemUpdateResultState.Success?(n.error&&v(r,n.error),E()):(h.push({workItem:r}),E()):(await r.takeUpdateResult(this.pageContext,n,a[s],{keepDeletedLinks:o,ignoreTelemetry:l}),h.push({workItem:r}),t[r.tempId]=r.id,E())}}else d.forEach((e=>{v(e,{message:"Server data does not match with what client sent."})})),k()}catch(u){d.forEach((e=>{v(e,u)})),k()}}catch(e){throw p(d,!1),e}}else k()}else k()}_beginTryMergeWorkItem(e,t,i){const a={};this.beginGetWorkItemData([e.id],(s=>{if(this._hasConflicts(e,s,a)&&i)return void i(e);const r=this._getChangedFieldsForMerge(e,s);this._mergeWorkItem(e,s),e.evaluate();for(const t in a)a.hasOwnProperty(t)&&e.setFieldValueById(Number.parseInt(t),a[t]);e.isValid()?t(e,r):i&&i(e)}),(()=>{i&&i(e)}),!1,!0)}_mergeWorkItem(e,t){let i;i=e.getLinkUpdates(),e.load(t,!0),e.restoreLinkUpdates(i)}_getChangedFieldsForMerge(e,t){const i={},a=t.fields;for(const s in a)if(a.hasOwnProperty(s)){const a=e.getFieldById(Number.parseInt(s));if(a){const r=e.getFieldValueById(+s,!0),n=(0,N.convertFieldValueToExternal)(t.fields[s],a.fieldDefinition.type);(0,N.compareFieldValues)(r,n,!1)||(i[a.fieldDefinition.referenceName]=a)}}return i}_hasConflicts(e,t,i){let a,s,n,o;const l=e.getFieldUpdates();for(const d in l)if(l.hasOwnProperty(d)){const u=Number(d);if(n=e.getFieldById(u),n&&(a=e.getFieldValueById(u,!0),s=(0,N.convertFieldValueToExternal)(t.fields[u],n.fieldDefinition.type),(0,N.isUserChange)(n,l[d])))if(o=e.getFieldValueById(u,!1),u==r.CoreField.History||(0,N.compareFieldValues)(a,s,!1))i[u]=o,u===r.CoreField.IterationId?i[r.CoreField.IterationPath]=e.getFieldValueById(r.CoreField.IterationPath):u===r.CoreField.AreaId&&(i[r.CoreField.AreaPath]=e.getFieldValueById(r.CoreField.AreaPath));else if(!(0,N.compareFieldValues)(o,s,!1))return!0}return!1}_createWorkItemBulkSaveFailedException(e){const t=new Error(C.WorkItemBulkSaveFailed);return t.name=T.Exceptions.WorkItemBulkSaveException,t.results=e,t}}u.Services.add("IWorkItemSavingService",{serviceFactory:i})}(),function(e){H=t[e]={};class i{constructor(e,t,i,a,s,l,d){this.id=0,this.tempId=0,this.revision=new n.ObservableValue(0),this.manualDirty=new n.ObservableValue(!1),this.dirty=new n.ObservableValue(!1),this.saving=new n.ObservableValue(!1),this.infoText=new n.ObservableValue({invalid:!1,text:""}),this.promisesToWait=new Map,this.promiseToWaitId=0,this.manuallySetFields=new Map,this._hasTeamProjectChanged=!1,this._fieldWatermark=new n.ObservableValue(0),this._isChangeProjectInProgress=!1,this._identityFieldValidationFixEnabled=!1,this.validateAreaOrIterationNodeField=e=>{const t=this.getFieldById(e),i=this.getFieldValueById(e);if(!t||!i)return;if(!this.isFieldAreaOrIterationNode(e))return;let a;const[s,n]=this.getAreaAndIterationFieldIds(),o=s.includes(t.fieldDefinition.id)?0:1;a=[r.CoreField.AreaId,r.CoreField.IterationId].includes(t.fieldDefinition.id)?this.project.getNodeById(i):this.project.getNode(i,o),this.updateAreaAndIterationFieldsStatus(a,t)},this._workItemFormSavingService=e.getService("IWorkItemSavingService"),this._workItemEventService=e.getService("IWorkItemEventService"),this._workItemFieldEventService=e.getService("IWorkItemFieldEventService"),this._perfService=e.getService("IVssPerformanceService"),this._projectService=e.getService("IProjectService"),this.extensions=d||[],this._originalExtensions=this.extensions,this._contributionErrorMap={},this._typeData=t,this._originalTypeData=this._typeData,this._pageContext=e,this.project=i,this._eventsEnabled=!1,this._initializeFields(t),this._defineExtensionFields(),this._isMarkdownDiscussionEnabled=(0,c.isFeatureFlagEnabled)(this._pageContext,I.FeatureFlags.IsMarkdownDiscussionEnabled,!1),this._workItemFieldChangedEventOptimizationEnabled=(0,c.isFeatureFlagEnabled)(this._pageContext,I.FeatureFlags.WorkItemFieldChangedEventOptimizationEnabled,!1),this._iterationAndAreaNodesValidationEnabled=(0,c.isFeatureFlagEnabled)(this._pageContext,I.FeatureFlags.IterationAndAreaNodesValidationEnabled,!1),this._identityFieldValidationFixEnabled=(0,c.isFeatureFlagEnabled)(this._pageContext,I.FeatureFlags.IdentityFieldValidationFixEnabled,!1),this._movingToNewIterationFixEnabled=!(0,c.isFeatureFlagEnabled)(this._pageContext,I.FeatureFlags.MovingToNewIterationFixDisabled,!1),this._nodeService=this._movingToNewIterationFixEnabled?e.getService("IWorkItemNodeService"):void 0,this._eventsEnabled=!0,this.relatedData={},this.sessionId=(0,o.newGuid)(),this.saving=new n.ObservableValue(!1),this.store=new b.WorkItemStore(e,a);const u=this._projectService.getFieldLookup(i.guid);let h,m;this.workItemType=new U.WorkItemType(e,this._typeData,this.project,u),(null==l?void 0:l.areaPathMru)&&this.project.getNodeById(l.areaPathMru)&&(h=l.areaPathMru),(null==l?void 0:l.iterationPathMru)&&this.project.getNodeById(l.iterationPathMru)&&(m=l.iterationPathMru),this.load(s,!1,!1,h,m)}static getTempId(){return--i.tempIdSeed}static reserveTempId(e){i.tempIdSeed>e&&(i.tempIdSeed=e)}static create(e,t,a,s,r,n,o){return new i(e,a,t,s,r,n,o)}static async createAsync(e,t,i,a,s,r,n){var o;const l=e.getService("IWorkItemDataManager"),d=e.getService("IProjectService");let u={};i.rules.globals.length>0&&(u=null!==(o=await l.beginGetConstantSets(i.rules.globals))&&void 0!==o?o:{});const h=await d.getProjectAsync(t);if(n){const e=d.getFieldProjectDataWithNodes(t);await Promise.all([null==e?void 0:e.areaNodesPromise,null==e?void 0:e.iterationNodesPromise])}return this.create(e,h,i,u,a,s,r)}hasStateChanged(){return!(!this._previousStateName||this._previousStateName===this.getFieldValueById(r.CoreField.State))}fireWorkItemErrorChanged(){const e=[];if(this._error){const t=this.fieldMap[this._error.fieldReferenceName].fieldDefinition.id;e.push(t)}this._onWorkItemChanged(e,{workItemChangeType:"error-changed"}),this._workItemEventService.fireEvent({workItem:this},M.IWorkItemEventType.WorkItemErrorUpdated)}setContributionErrorStatus(e,t,i){if(t&&this._contributionErrorMap.hasOwnProperty(e))delete this._contributionErrorMap[e],this.fireWorkItemErrorChanged();else if(!t){const t=this._contributionErrorMap[e];this._contributionErrorMap[e]=i||"",t!==this._contributionErrorMap[e]&&this.fireWorkItemErrorChanged()}}beginValidate(e,t,i,a){if(this.dirty.value&&!this.isValidating(t)&&!this.saving.value){const s=this.getUpdateData();if(s&&s.payload){this._setValidatingStatus(!0,t);const s=this.getFieldById(e);this.workItemType.beginGetDependentFields(e,this,(async r=>{const n=r.concat(s.fieldDefinition),o={},l={};n.forEach((e=>{o[e.referenceName]=this.getFieldValueById(e.id,!0,void 0,void 0,!0),this.fieldUpdates.has(e.id)&&(l[e.referenceName]=this.getFieldValueById(e.id,!1,void 0,void 0,!0))}));const d=this._typeData.rules.fieldRules[e];if(this._identityFieldValidationFixEnabled&&(null==d?void 0:d.length)){const e=V.RuleEvaluator.getRelatedFieldIds(d);(null==e?void 0:e.length)&&e.forEach((e=>{const t=this.getFieldById(e);t&&!(t.fieldDefinition.referenceName in o)&&(o[t.fieldDefinition.referenceName]=this.getFieldValueById(e,!0,void 0,void 0,!0),this.fieldUpdates.has(e)&&(l[t.fieldDefinition.referenceName]=this.getFieldValueById(e,!1,void 0,void 0,!0)))}))}try{const e=await this._pageContext.getService("IVssContributionService").getDataAsync("ms.vss-work-web.work-item-rule-engine-data-provider",{fieldsToEvaluate:{projectId:this.project.guid,workItemType:this.workItemType.name,fields:[s.fieldDefinition.referenceName],fieldValues:o,fieldUpdates:l}});if(e&&e.exception){if(a){const t=e.exception.customProperties?e.exception.customProperties.FieldReferenceName||e.exception.customProperties.ReferenceName:void 0;a(e.exception,t)}}else this.isValidating(t)&&!this.saving.value&&i()}catch(e){a(e)}finally{this._setValidatingStatus(!1,t)}}),(e=>{console.error(e)}))}}}isValidating(e){if(e)return this._fieldValidationMap[e.toString()]||!1;for(const e in this._fieldValidationMap)if(this._fieldValidationMap[e])return!0;return!1}validateIdentityFieldValue(e){const t=this.getFieldValueById(e),i=this.fieldMapById[e],a=new _.FieldValidationKey(e,t,i.filterByScope);!(0,N.isIdentityPickerSupportedForField)(i)||!(0,N.isFieldValid)(i)||t instanceof R.ServerDefaultValue||this.beginValidate(e,a,(()=>{new _.FieldValidationKey(e,this.getFieldValueById(e),i.filterByScope).equals(a)&&(i.error="",this._onWorkItemChanged([e],{workItemChangeType:"validation-completed"}))}),((t,s)=>{let r=i;s&&(r=this.getFieldByName(s)),(0,N.isFieldValid)(r)&&new _.FieldValidationKey(e,this.getFieldValueById(e),i.filterByScope).equals(a)&&(r.error=t.message,r.status=1073741824,this._onWorkItemChanged([e],{workItemChangeType:"validating"}))}))}_setValidatingStatus(e,t){let i=!1;if(t)this._fieldValidationMap[t.toString()]!==e&&(this._fieldValidationMap[t.toString()]=e,i=!0);else for(const t in this._fieldValidationMap)this._fieldValidationMap[t]!==e&&(this._fieldValidationMap[t]=e,i=!0)}_initializeFields(e){this.fields=[],this.fieldMap={},this.fieldMapById={},this._fieldValidationMap={},e.fields.forEach((e=>{this._defineFieldById(e)}))}_getHtmlSanitizerOptions(e){let t=W.htmlSanitizerPreserveClassAndMentionOptions;return(0,c.isFeatureFlagEnabled)(e,I.FeatureFlags.MarkdownXSSFix,!1)&&(t=W.htmlSanitizerPreserveClassAndMentionOptionsV2),t}save(e,t){var i,s;if(this.isReadOnly())throw new Error(C.WorkItemIsReadOnlyError);const n=null===(i=this.fieldUpdates)||void 0===i?void 0:i.get(r.CoreField.Title),o=null==n?void 0:n.value.trim();let l;n&&o!==(null==n?void 0:n.value)&&(n.value=o,this._onWorkItemChanged([r.CoreField.Title],{workItemChangeType:"refresh"}));const d=this._splitTagNames(this.getFieldValueById(r.DalFields.Tags)),u=this._splitTagNames(this.getFieldValueById(r.DalFields.Tags,!0));if(u!==d){l=d.length-u.length;const e=(0,N.subtract)(d,u);this._pageContext.getService("IWorkItemModelService").addTagsMru(e)}const h=this._perfService.startScenario("WorkItem.Save",!1);if(null==e&&(e=window.location.pathname),h.addProperties({workItemType:"[NonEmail: "+this._typeData.referenceName+"]",numberOfTags:undefined,numberOfTagsDelta:l,PathName:e}),this.isNew()&&this.saveLastAreaAndIteration(),this._isMarkdownDiscussionEnabled&&this.fieldUpdates.has(r.CoreField.History)){const e=null===(s=this.fieldUpdates)||void 0===s?void 0:s.get(r.CoreField.History);if(e){const t=this._pageContext.getService("ISettingsService").getEntry("WorkItemDiscussionSettings/CommentFormatState",0),i=this._getHtmlSanitizerOptions(this._pageContext),s="Markdown"===t;s&&(e.value=(0,a.filterXSS)((0,g.translateDisplayNamesToStorageKeys)(this._pageContext,e.value),i)),this.addLinksForNewMentionsInComment(e.value,s);const r={format:t||"HTML",text:e.value};e.value=r}}return new Promise(((e,i)=>this._workItemFormSavingService.beginSaveWorkItemsBatch([this],(t=>{this._perfService.addSplitTiming("WorkItem.Save.Complete",h.scenarioName),e(t),this._perfService.endScenario(r.WITCommonConstants.WorkItemTrackingArea,h.scenarioName,!1)}),(e=>{this._perfService.endScenario(r.WITCommonConstants.WorkItemTrackingArea,h.scenarioName,!1),e&&e.name===T.Exceptions.WorkItemBulkSaveException&&(e=e.results[0].error),i(e)}),t)))}saveLastAreaAndIteration(){const e=this.getFieldValueByName(r.CoreFieldRefNames.AreaId),t=this.getFieldValueByName(r.CoreFieldRefNames.IterationId),i=this._pageContext.getService("IWorkItemNodeService");i.updateMruAreaPaths(this.project.guid,[e]),i.updateMruIterations(this.project.guid,[t])}saveLinks(e,t){return this._workItemFormSavingService.saveWorkItemLinksAsync(this,e,t)}isReadOnly(){return this._isReadOnly||this.isDeleted()}isCommentingAvailable(){return!this.isDeleted()&&this._isCommentingAvailable}isDeleted(){return this.getFieldValueByName(r.CoreFieldRefNames.IsDeleted)}isValid(){const e=this.getInvalidFields(!0);return(!e||0===e.length)&&0===Object.keys(this._contributionErrorMap).length}isNew(){return void 0===this.id||this.id<1}hasWorkItemTypeChanged(){return this._originalTypeData!==this._typeData}hasTeamProjectChanged(){return this._hasTeamProjectChanged}getError(){return this._error}setError(e){this._error=e,this.updateInfoText(),this._workItemEventService.fireEvent({workItem:this},M.IWorkItemEventType.WorkItemErrorUpdated)}clearError(){this._error&&(this._error=void 0)}getInvalidFields(e){const t=[],i=this.fields;for(const a of i)if(!(0,N.isFieldValid)(a)&&(t.push(a),e))break;return t}getDirtyFields(e){var t,i;const a=[];for(const s of this.fields){const r=s.fieldDefinition.id;(e&&(null===(t=this.manuallySetFields)||void 0===t?void 0:t.has(r))||!e&&(null===(i=this.fieldUpdates)||void 0===i?void 0:i.has(r)))&&a.push(s)}return a}isFieldDirty(e){let t;return"string"==typeof e?t=this.getFieldByName(e):"number"==typeof e&&(t=this.getFieldById(e)),!!t&&this.fieldUpdates.has(t.fieldDefinition.id)}updateInfoText(){const e={text:"",invalid:!1},t=this.getInvalidFields(!0);t&&t.length>0?(e.text=(0,N.getFieldErrorText)(t[0],this.getFieldValueById(t[0].fieldDefinition.id)),e.invalid=!0):this._error?(this._error.fieldReferenceName&&!this.getFieldByName(this._error.fieldReferenceName.toUpperCase())?e.text=C.BrowserRefreshRequired:e.text=(0,W.getErrorMessage)(this.getError()),e.invalid=!0):this._contributionErrorMap&&Object.keys(this._contributionErrorMap).length>0?(e.invalid=!0,e.text=this._contributionErrorMap[Object.keys(this._contributionErrorMap)[0]]||""):e.text="",this.infoText.value.text===e.text&&this.infoText.value.invalid===e.invalid||(this.infoText.value=e)}getTitle(){return this.getFieldValueById(r.CoreField.Title)||""}getCaption(e){let t;if(this.isNew()){const i=(null==e?void 0:e.excludeTempId)?"":-this.tempId;t=(0,o.format)(C.WorkItemCaptionNew,this._typeData.name,i)}else t=`${this._typeData.name} ${this.id}`;return(null==e?void 0:e.includeDirtyModifier)&&this.dirty.value&&(t=`${t}*`),t}getUniqueId(){return this.id||this.tempId}getTypeData(){return this._typeData}_getCommentCount(e){let t=this._fieldData[r.CoreField.CommentCount]||0;return!e&&this.fieldUpdates.has(r.CoreField.History)&&(t+=1),t}getFieldLookup(){return this._projectService.getFieldLookup(this.project.guid)}getFieldByName(e){return this.fieldMap[e.toUpperCase()]}getFieldById(e){return this.fieldMapById[e]}getFieldValueById(e,t,i,a,s){const r=this.getFieldById(e);if(r)return this._getFieldValue(r.fieldDefinition,t,i,a,s)}getFieldValueByName(e,t,i,a,s){const r=this.getFieldByName(e);if(r)return this._getFieldValue(r.fieldDefinition,t,i,a,s)}_getFieldValue(e,t,i,a,s){const n=this.fieldUpdates,o=e.id;switch(o){case r.CoreField.AttachedFileCount:return this._getLinkCount(j.Attachment,!!t);case r.CoreField.ExternalLinkCount:return this._getLinkCount(j.ExternalLink,!!t);case r.CoreField.HyperLinkCount:return this._getLinkCount(j.Hyperlink,!!t);case r.CoreField.RelatedLinkCount:return this._getLinkCount(j.WorkItemLink,!!t);case r.CoreField.Parent:return this._getParentLinkId(!!t);case r.CoreField.CommentCount:return this._getCommentCount(t);case r.CoreField.TeamProject:if(this.isNew())return this.project.name}if(!t&&n.has(o)){const t=n.get(o);if(!t.setByRule||!i)return this.convertFieldValue(t.value,e,a)}const l=this._fieldData[o],u=s?(0,N.convertFieldValueToExternal)(l,e.type):l;return(0,d.convertPotentialIdentityRefFromFieldValue)(this._pageContext,u,a)}convertFieldValue(e,t,i){return(0,d.convertPotentialIdentityRefFromFieldValue)(this._pageContext,(0,N.convertFieldValueToExternal)(e,t.type),i)}setFieldValueByName(e,t,i){const a=this.getFieldByName(e);return this.wrappedSetFieldValue(a,t,i)}setFieldValueById(e,t,i){const a=this.getFieldById(e);return this.wrappedSetFieldValue(a,t,i)}wrappedSetFieldValue(e,t,i){const a=()=>{if(this._workItemFieldChangedEventOptimizationEnabled){if(!e)return!1;(0,d.isWorkItemIdentityRef)(t)&&(t=t.distinctDisplayName);const a=(0,N.convertFieldValueToInternal)((0,N.tryNormalizeFieldValue)(t,e),e.fieldDefinition.type,!!(null==i?void 0:i.readOnly));return(null==i?void 0:i.setByRule)?this._setFieldValueForce(e,a.value,i):this.setFieldValue(e,a,i)}return this._setFieldValue(e,t,i)};if(!(null==i?void 0:i.handleExceptions))return a();try{return a()}catch(i){let a="An error occurred while bulk-editing a work item";return i instanceof Error&&(a+=`: ${i.message} Field Name: ${null==e?void 0:e.fieldDefinition.name}, Value: ${t}`),console.error(a),!1}}setFieldValue(e,t,i){var a;if(!e)return!1;i=Object.assign({preventFire:!1,fireIdentityEagerValidation:!1,setByRule:!1},i);const s=this.getFieldValueById(e.fieldDefinition.id);if(this._setFieldValueForce(e,t.value,i),null!==(a=i.evaluate)&&void 0!==a?a:!(0,N.compareFieldValues)(s,t.value)){const a=this.evaluateField(e.fieldDefinition.id,!0,s);e.status|=t.status,i.fireIdentityEagerValidation&&this.validateIdentityFieldValue(e.fieldDefinition.id),i.preventFire||this._onWorkItemChanged(a,{setByRules:i.setByRule,workItemChangeType:"field-change"})}return this._iterationAndAreaNodesValidationEnabled&&this.validateAreaOrIterationNodeField(e.fieldDefinition.id),!0}_setFieldValueForce(e,t,i){var a,s;let n=this.isReadOnly();if(null==i?void 0:i.checkIsCommentingAvailable){n=!((null===(a=null==e?void 0:e.fieldDefinition)||void 0===a?void 0:a.id)==r.CoreField.History&&this.isCommentingAvailable())&&this._isReadOnly}if(!e||n)return!1;i=Object.assign({preventFire:!1,fireIdentityEagerValidation:!1,setByRule:!1},i);const o=e.fieldDefinition.id,l=this.getFieldValueById(o),d=this._fieldData[o];switch(o){case r.CoreField.AttachedFileCount:case r.CoreField.ExternalLinkCount:case r.CoreField.HyperLinkCount:case r.CoreField.RelatedLinkCount:case r.CoreField.Parent:case r.CoreField.CommentCount:return!1;case r.CoreField.AreaId:case r.CoreField.IterationId:if(!(this._movingToNewIterationFixEnabled?null===(s=this._nodeService)||void 0===s?void 0:s.getNodeById(this.project.guid,t):this.project.getNodeById(t)))throw new Error(C.InvalidNodeId);break;case r.CoreField.Rev:this.revision.value=t;break;case r.CoreField.State:l!==t&&(this._previousStateName=l)}const u=e.fieldDefinition.isIdentity,h=o===r.CoreField.History,c=h&&!(0,N.compareFieldValues)("",t),I=!h&&!(0,N.compareFieldValues)(d,t,void 0,u);if(c||I){const e=this.fieldUpdates.get(o);if(e&&e.value===t?this.fieldUpdates.set(o,{value:t,setByRule:e.setByRule&&i.setByRule}):this.fieldUpdates.set(o,{value:t,setByRule:i.setByRule}),i.setByRule||this.manuallySetFields.set(o,t),c){const e=this.getFieldValueById(r.CoreField.CommentCount);this.evaluateField(r.CoreField.CommentCount,!0,e)}}else this.fieldUpdates.delete(o),this.manuallySetFields&&this.manuallySetFields.delete(o);return this.evaluateDirty(),!0}_setFieldValue(e,t,i){var a,s,n;let o=this.isReadOnly();if(null==i?void 0:i.checkIsCommentingAvailable){o=!((null===(a=null==e?void 0:e.fieldDefinition)||void 0===a?void 0:a.id)==r.CoreField.History&&this.isCommentingAvailable())&&this._isReadOnly}if(o)return!1;if(e){i=Object.assign({preventFire:!1,fireIdentityEagerValidation:!1,setByRule:!1},i),(0,d.isWorkItemIdentityRef)(t)&&(t=t.distinctDisplayName);const a=e.fieldDefinition.id,o=this.getFieldValueById(a),l=(0,N.convertFieldValueToInternal)((0,N.tryNormalizeFieldValue)(t,e),e.fieldDefinition.type,!!i.readOnly),u=this._fieldData[a];switch(a){case r.CoreField.AttachedFileCount:case r.CoreField.ExternalLinkCount:case r.CoreField.HyperLinkCount:case r.CoreField.RelatedLinkCount:case r.CoreField.Parent:case r.CoreField.CommentCount:return!1;case r.CoreField.AreaId:case r.CoreField.IterationId:if(!(this._movingToNewIterationFixEnabled?null===(s=this._nodeService)||void 0===s?void 0:s.getNodeById(this.project.guid,t):this.project.getNodeById(t)))throw new Error(C.InvalidNodeId);break;case r.CoreField.Rev:this.revision.value=l.value;break;case r.CoreField.State:o!==l.value&&(this._previousStateName=o)}const h=e.fieldDefinition.isIdentity,c=a===r.CoreField.History,I=c&&!(0,N.compareFieldValues)("",l.value),m=!c&&!(0,N.compareFieldValues)(u,l.value,void 0,h);if(I||m){const e=this.fieldUpdates.get(a);if(e&&e.value===l.value?this.fieldUpdates.set(a,{value:l.value,setByRule:e.setByRule&&i.setByRule}):this.fieldUpdates.set(a,{value:l.value,setByRule:i.setByRule}),i.setByRule||this.manuallySetFields.set(a,l.value),I){const e=this.getFieldValueById(r.CoreField.CommentCount);this.evaluateField(r.CoreField.CommentCount,!0,e)}}else this.fieldUpdates.delete(a),this.manuallySetFields&&this.manuallySetFields.delete(a);if(this.evaluateDirty(),null!==(n=i.evaluate)&&void 0!==n?n:!(0,N.compareFieldValues)(o,l.value)){const t=this.evaluateField(e.fieldDefinition.id,!0,o);e.status|=l.status,i.fireIdentityEagerValidation&&this.validateIdentityFieldValue(e.fieldDefinition.id),i.preventFire||this._onWorkItemChanged(t,{setByRules:i.setByRule,workItemChangeType:"field-change"})}return!0}return!1}updateAreaAndIterationFieldsStatus(e,t){const[i,a]=this.getAreaAndIterationFieldIds();if(e){const e=i.includes(t.fieldDefinition.id)?i:a;this.fields.filter((t=>32768===t.status&&e.includes(t.fieldDefinition.id))).map((e=>e.status=0))}else t.status|=32768;this.updateInfoText()}isFieldAreaOrIterationNode(e){const[t,i]=this.getAreaAndIterationFieldIds();return[...t,...i].includes(e)}getAreaAndIterationFieldIds(){return[[r.CoreField.AreaId,r.CoreField.AreaPath],[r.CoreField.IterationId,r.CoreField.IterationPath]]}evaluateField(e,t,i){return this._getRuleEngine().evaluateField(e,t,i)}_defineFieldById(e){const t=this.getFieldLookup();!this.fieldMapById.hasOwnProperty(e)&&t[e]&&this._defineField(t[e])}_defineField(e){var t;const i=Object.assign(Object.assign({},e),{rules:this._typeData.rules.fieldRules?this._typeData.rules.fieldRules[e.id]:[],workItemType:Object.assign(Object.assign({},this._typeData),{orderedStates:null!==(t=this._typeData.orderedStates)&&void 0!==t?t:[]})}),a={fieldDefinition:i,status:0,workItem:this,patterns:[]};this.fieldMap[i.referenceName.toUpperCase()]=a,this.fieldMapById[i.id]=a,this.fields.push(a)}getFieldUpdates(){const e={};return this.fieldUpdates.forEach(((t,i)=>{const a=this.getFieldById(i);if(a&&a.fieldDefinition&&a.fieldDefinition.flags&r.FieldFlags.Computed)return;let s=t.value;void 0===s&&(s=null),e[i]=s})),e}getFieldData(){return this._fieldData}evaluateDirty(){const e=this.isDirty();this.dirty.value!==e&&(this.dirty.value=e);const t=this.isDirty(!0);this.manualDirty.value!==t&&(this.manualDirty.value=t)}isDirty(e,t,i){let a=this.isReadOnly();return i&&(a=!this._isCommentingAvailable&&this.isReadOnly()),!a&&!this.isDeleted()&&(!!this._fieldsDirty(e,t)||!!this._linksDirty())}_linksDirty(){for(const e of this._allLinks)if(!(e.isRemoved()||e.isNew()&&e instanceof j.WorkItemLink&&e.linkData.isAddedBySystem)){if(e.pendingDeletion!==e.isNew())return!0;if(e.pendingUpdate)return!0}return!1}_fieldsDirty(e,t){var i;if(e){if(this.manuallySetFields){const e=new Map(this.manuallySetFields);if(t&&t.length>0)for(const i of t)e.delete(i);return e.size>0}}else{if(this.isNew())return!0;{const e=new Map(this.fieldUpdates);if(t&&t.length>0)for(const i of t)e.delete(i);for(const t of e.keys())if(!(null===(i=e.get(t))||void 0===i?void 0:i.setByRule))return!0}}return!1}_onWorkItemChanged(e,t){this.clearError(),this.updateInfoText();const a=new Map;if(this._eventsEnabled&&e){for(const t of e)if(!a.has(t)){const e=this.getFieldById(t);if(e){const t=e.fieldDefinition.id,s=i.FIELD_ID_TO_DEPENDENT_ID_MAP[t];a.set(t,e),s&&s.forEach((e=>{const t=this.getFieldById(e);t&&a.set(e,t)}))}else a.delete(t)}for(const[e,t]of a.entries())this.updateFieldWatermark(e.toString())}this._workItemFieldEventService.fireEvent({workItem:this,fieldDefinitionIds:Array.from(a.keys()),setByRules:null==t?void 0:t.setByRules,workItemChangeType:null==t?void 0:t.workItemChangeType},B.IWorkItemFieldEventType.WorkItemFieldsUpdated),this._workItemEventService.fireEvent({workItem:this},M.IWorkItemEventType.WorkItemUpdated)}getEmptyUpdateData(){const e=this.prepareWorkItemUpdateData();return e.payload=this.prepareWorkItemUpdatePackage(),e}getUpdateData(){let e=!1;const t=this.prepareWorkItemUpdateData(),i=this.prepareWorkItemUpdatePackage(),a=this.getFieldUpdates();a&&(this.addLinksForNewMentions(a),i.fields=a,this.hasTeamProjectChanged()&&i.fields&&(i.fields[r.CoreField.TeamProject]=this.project.name),e=!0);const s=this.getLinkUpdates(t);return s&&(i.links=s,e=!0),e&&(t.payload=i),t}prepareWorkItemUpdateData(){return{uniqueId:this.getUniqueId(),id:this.id,tempId:this.tempId,rev:this.revision.value,projectId:this.project.guid,addedLinks:[],deletedLinks:[],updatedLinks:[]}}prepareWorkItemUpdatePackage(){return{id:this.id,rev:this.revision.value,projectId:this.project.guid,isDirty:this.isDirty(),tempId:this.isNew()?this.tempId:void 0}}addLinksForNewMentions(e){var t,i,a;const s=null===(i=null===(t=this._pageContext.getService("IVssPageService").getData())||void 0===t?void 0:t.user)||void 0===i?void 0:i.displayName;if(!s)return;const n=new Set,o=this.getFieldLookup();for(const[t,i]of Object.entries(e)){const e=null===(a=o[t])||void 0===a?void 0:a.type;e!==r.FieldType.Html&&e!==r.FieldType.History||"string"==typeof i&&this.findMentionsInHTMLFieldValue(i,n)}this.prepareAndAddRelatedlinks(n,s)}prepareAndAddRelatedlinks(e,t){const i=[...e].map((e=>j.WorkItemLink.createSync(T.CoreLinkTypes.Related,e,(0,o.format)(C.LinkedFromMentionCommentFormat,t,e,this.id))));return this.addLinks(i),i}findMentionsInHTMLFieldValue(e,t){const i=document.createElement("div");i.innerHTML=e;i.querySelectorAll("a[data-vss-mention]").forEach((e=>{if(!e.outerText.startsWith(W.workItemLinkBeginningSign))return;const i=(0,W.getEndingNumberFromUrl)(e.href);!i||i&&(!Number.isFinite(i)||i<=0)||t.add(Number(i))}))}async findMentionsInMarkdownFieldValue(e){const t=new Set,i=[],a=e=>{const t=parseInt(e);(Number.isFinite(t)||t>0)&&i.push(t)},s=e.split(/(?<=\s|^)(#[0-9]+[^#\n]*)/g).filter((e=>Boolean(e)));for(const e of s){if(!e.startsWith(W.workItemLinkBeginningSign))continue;const t=e.match(/#([0-9]+)/g);if(t)for(const e of t){a(e.slice(1))}}return i.length>0&&await(async e=>{const i=this._pageContext.getRestClient("IWorkItemTrackingRestClient"),a=await i.getWorkItems(e,void 0,[r.CoreFieldRefNames.Id],void 0,void 0,2);a&&a.map((e=>t.add(e.id)))})(i),t}async addLinksForNewMentionsInComment(e,t){var i,a;const s=null===(a=null===(i=this._pageContext.getService("IVssPageService").getData())||void 0===i?void 0:i.user)||void 0===a?void 0:a.displayName;if(!s)return;let n=new Set;if(t?n=await this.findMentionsInMarkdownFieldValue(e):this.findMentionsInHTMLFieldValue(e,n),n.has(this.id)&&n.delete(this.id),n.size>0){const e=this.prepareAndAddRelatedlinks(n,s);this.saveLinks(e,[r.CoreField.History,r.CoreField.Rev])}}evaluate(e,t){const i=[],a={};(0,U.getTriggerList)(this._typeData,(e=>!!this.getFieldById(e))).forEach((e=>{a.hasOwnProperty(e)||(i.push(e),a[e]=!0)})),t?(t.forEach((e=>{a.hasOwnProperty(e)||(i.push(e),a[e]=!0)})),a.hasOwnProperty(r.DalFields.HistoryId)||(i.push(r.DalFields.HistoryId),a[r.DalFields.HistoryId]=!0)):this.fields.forEach((e=>{const t=e.fieldDefinition.id;a.hasOwnProperty(t)||(i.push(t),a[t]=!0)})),this.evaluateFields(i,e)}evaluateFields(e,t){const i=new Set;t&&t.forEach((e=>{i.add(e)}));const a=this._getRuleEngine().evaluateFields(e);a&&a.forEach((e=>{i.add(e)})),this._onWorkItemChanged([...i.values()],{workItemChangeType:"field-evaluate"})}resetManualFieldChanges(){this.manuallySetFields.clear()}getFieldWatermark(){return this._fieldWatermark}updateFieldWatermark(e){this._fieldWatermark.notify(this._fieldWatermark.value+1,e)}_getRuleEngine(){if(!this._ruleEngine){const e=[];this.fields.forEach((t=>{t.fieldDefinition.rules&&e.push({fieldId:t.fieldDefinition.id,rules:t.fieldDefinition.rules})})),this.extensions&&this.extensions.forEach((t=>{if(t.fieldRules)for(const[i,a]of Object.entries(t.fieldRules))e.push({fieldId:Number(i),rules:a})})),this._ruleEngine=new A.RuleEngine(this,e)}return this._ruleEngine}_splitTagNames(e){return e?e.trim().split(/;\s*/):[]}reset(){this.resetContributionErrorStatuses(),this.resetChanges(),this.relatedData={};const e=[r.DalFields.RelatedLinks,r.DalFields.BISURI,r.DalFields.LinkedFiles,r.DalFields.AttachedFiles,r.DalFields.Tags];this.fieldMap[r.CoreFieldRefNames.Parent]&&e.push(r.CoreField.Parent),this._onWorkItemChanged(e,{workItemChangeType:"reset"}),this.updateFieldWatermark(T.WorkItemWatermarkAllAction),this._workItemFieldEventService.fireEvent({workItem:this},B.IWorkItemFieldEventType.WorkItemFieldsUpdated),this._workItemEventService.fireEvent({workItem:this},M.IWorkItemEventType.WorkItemReset)}resetChanges(){let e;this._currentLinks=void 0;const t=this._allLinks;for(let i=0,a=t.length;i<a;i++)e=t[i],e.isNew()?(t.splice(i--,1),a--):(e.pendingDeletion=!1,e.linkData.CommentChanged&&(e.linkData.Comment=e.comment,e.linkData.CommentChanged=!1),e.linkData.LockChanged&&(e.linkData.Lock=e.isLocked,e.linkData.LockChanged=!1),e.setState());this.cleanPromisesToWait(),this.fieldUpdates.clear(),this.evaluate(),this.resetManualFieldChanges(),this._resetWorkItemTypeChanges(),this.evaluateDirty()}async refresh(e){if(!this.isNew()){const t=this._pageContext.getService("IWorkItemDataManager"),i=await t.beginGetWorkItemData([this.id],null==e?void 0:e.isDeleted,void 0,null==e?void 0:e.includeHistory);if(!i||0===i.length)return Promise.reject((0,o.format)(C.InvalidWorkItemId,this.id));if((null==e?void 0:e.doNotResetIfManuallyDirty)&&this.isDirty(!0,[r.CoreField.History]))return;return this.updateWorkItemPayload(i[0],null==e?void 0:e.doNotResetComment,null==e?void 0:e.doNotResetFields)}this.reset()}async refreshNewLinks(e){var t,i,a;const s=this._pageContext.getService("IWorkItemDataManager"),r=await s.beginGetWorkItemData([this.id],!1,!1,null==e?void 0:e.includeHistory);if(!r||0===r.length)throw new Error((0,o.format)(C.InvalidWorkItemId,this.id));const n=r[0],l=[...null!==(t=n.files)&&void 0!==t?t:[],...null!==(i=n.relations)&&void 0!==i?i:[],...null!==(a=n.relationRevisions)&&void 0!==a?a:[]].map((e=>j.Link.createFromLinkData(e)));this.addLinks(l,null==e?void 0:e.keepDeleted)}async updateWorkItemPayload(e,t,i){const a=e.fields[r.CoreField.TeamProject],s=e.fields[r.CoreField.WorkItemType];await this._evaluateWorkItemTypeChange(a,s),this.load(e,!i,t),i||(this.updateFieldWatermark(T.WorkItemWatermarkAllAction),this._workItemFieldEventService.fireEvent({workItem:this},B.IWorkItemFieldEventType.WorkItemFieldsUpdated)),this.evaluateDirty()}async takeUpdateResult(e,t,i,a){const{keepDeletedLinks:s,ignoreTelemetry:n}=null!=a?a:{},o=n?()=>{}:e=>{this._perfService.addSplitTiming(e)};o(`${T.WorkItemFormPerfConstants.TakeUpdateResult}.Start`);const l=[],d=this.id;let u,h;try{this._loadTime=t.loadTime,this._ruleEngine=void 0;const e=t.rev!==this.revision.value,i=t.fields&&this._fieldData&&t.fields[r.CoreField.Watermark]!==this._fieldData[r.CoreField.Watermark];if(e||i){let i;this.setFieldValueById(r.CoreField.Id,t.id,{preventFire:!0}),this.id=t.id,void 0!==t.isCommentingAvailable&&null!==t.isCommentingAvailable&&(this._isCommentingAvailable=t.isCommentingAvailable),this.setFieldValueById(r.CoreField.Rev,t.rev,{preventFire:!0}),u=t.rev;const s=t.fields;if(s)for(i in s)s.hasOwnProperty(i)&&(this.setFieldValueById(+i,s[i],{evaluate:!1}),l.push(+i));const n=this.fieldUpdates,o=this._fieldData;let d;1===t.rev?(n.forEach(((e,t)=>{o[t]=e.value})),o[r.CoreField.History]&&this._addDiscussionForRevision(o[r.CoreField.History],o)):e?(d={},o.hasOwnProperty(r.CoreField.ChangedBy)&&(d[r.CoreField.ChangedBy]=o[r.CoreField.ChangedBy]),n.forEach(((e,t)=>{d[t]=o[t],o[t]=e.value})),o.hasOwnProperty(r.CoreField.History)&&(d.hasOwnProperty(r.CoreField.History)||(d[r.CoreField.History]=o[r.CoreField.History],delete o[r.CoreField.History])),this._revisionsPopulated&&this._revisions.push(d),o[r.CoreField.History]&&this._addDiscussionForRevision(o[r.CoreField.History],o)):n.forEach(((e,t)=>{n.hasOwnProperty(t)&&(o[t]=e.value)})),(null==a?void 0:a.fieldsToClear)&&(null==a||a.fieldsToClear.forEach((e=>this.fieldUpdates.delete(e)))),(null==a?void 0:a.ignoreFieldUpdates)&&n.forEach(((e,i)=>{t.fields[i]&&this.fieldUpdates.delete(i)})),(null==a?void 0:a.ignoreFieldUpdates)||(null==a?void 0:a.fieldsToClear)||this.fieldUpdates.clear()}}finally{o(`${T.WorkItemFormPerfConstants.TakeUpdateResult}.Complete`)}o(`${T.WorkItemFormPerfConstants.EvaluateLinkUpdates}.Start`);try{h=await this._takeLinkUpdateResult(e,t,i,s),this.evaluate(h.changedFields,l),this._onWorkItemChanged(l,{workItemChangeType:"field-evaluate"}),this.resetManualFieldChanges(),this.evaluateDirty(),this.updateInfoText()}finally{o(`${T.WorkItemFormPerfConstants.EvaluateLinkUpdates}.Complete`)}o(`${T.WorkItemFormPerfConstants.ResetAfterSave}.Start`);try{const e=this.hasWorkItemTypeChanged(),t=this.hasTeamProjectChanged();this._originalTypeData=this._typeData,this._hasTeamProjectChanged=!1,this._workItemEventService.fireEvent({workItem:this,changedWorkItemLinks:h.changedWorkItemLinks,externalLinkChanged:h.externalLinkChanged,firstSave:d!==this.id,typeChanged:e,projectChanged:t},M.IWorkItemEventType.WorkItemSaved),void 0!==u&&(this.revision.value=u)}finally{o(`${T.WorkItemFormPerfConstants.ResetAfterSave}.Complete`)}}_addDiscussionForRevision(e,t){this._fieldData[r.CoreField.CommentCount]=this._getCommentCount()}async _takeLinkUpdateResult(e,t,i,a){const s={},n=[];let o=!1;const l=async t=>t.SourceID===this.id?{targetId:t.TargetID,linkType:t.LinkType,remoteHostId:t.RemoteHostId}:{targetId:t.SourceID,linkType:(await j.WorkItemLink.findLinkTypeEnd(e,t.LinkType)).oppositeEnd.id,remoteHostId:t.RemoteHostId},d=(e,t,i)=>{let a;return this._allLinks.forEach((s=>{if(s instanceof j.WorkItemLink&&!s.isRemoved()){const r=s;if(r.getTargetId()===e&&(!s.remoteHostId||s.remoteHostId===i)&&r.getWitLinkTypeEndId()===t)return a=r,!1}})),a},u={};i.deletedLinks&&i.deletedLinks.forEach((e=>{e instanceof j.WorkItemLink||(s[e.getFieldId()]=!0,e.linkData.RemovedDate=this.getFieldValueById(r.DalFields.LastChangedDateId),e.linkData.FilePath&&(u[e.linkData.FilePath]=e))}));for(const e of t.deletedLinks)if(e.ExtID){if(!o&&e.FilePath){u[e.FilePath]instanceof j.ExternalLink&&(o=!0)}}else{const t=await l(e),i=d(t.targetId,t.linkType,t.remoteHostId);i&&(s[i.getFieldId()]=!0,i.linkData["Revised Date"]=e.ChangedDate,i.linkData["Revised By"]=e.ChangedBy,n.push({command:"remove",sourceId:this.id,targetId:i.getTargetId(),linkData:i.linkData}))}const h={};i.addedLinks&&i.addedLinks.forEach((e=>{e instanceof j.WorkItemLink||!e.linkData.FilePath||(h[e.linkData.FilePath]=e)}));for(const i of t.addedLinks){let t;if(i.ExtID&&i.FilePath)t=h[i.FilePath],t&&(s[t.getFieldId()]=!0,t.linkData.ExtID=i.ExtID,t.linkData.AddedDate=this.getFieldValueById(r.DalFields.LastChangedDateId),t instanceof j.ExternalLink&&(o=!0));else{const t=await l(i);let a=d(t.targetId,t.linkType,t.remoteHostId);a||(a=await j.WorkItemLink.create(e,t.linkType,t.targetId),this._allLinks.push(a)),s[a.getFieldId()]=!0,a.linkData["Changed Date"]=i.ChangedDate,a.linkData["Changed By"]=i.ChangedBy,n.push({command:"add",sourceId:this.id,targetId:a.getTargetId(),linkData:a.linkData})}}this.resetLinks(void 0,a);const c=[];for(const e in s)s.hasOwnProperty(e)&&c.push(+e);return{changedFields:c,changedWorkItemLinks:n,externalLinkChanged:o}}load(e,t,a,s,n){var o;let l;this.dirty,this.manualDirty,e=e||{},this._isReadOnly=e.isReadOnly||!1,this._loadTime=e.loadTime||new Date,this._fieldData=e.fields||{};for(const e in this._fieldData)if(this._fieldData.hasOwnProperty(e)){const t=this._fieldData[e].fieldDefinition;if(t)if((0,N.isLongTextField)(t.type)){const t=this._fieldData[e];t&&(this._fieldData[e]=t.trim())}else if(t.isIdentity){const t=this._fieldData[e];t&&(0,d.setResolvedByDescriptorIfWorkItemIdentityRef)(t)}if(e===r.CoreField.Title.toString()){const t=this._fieldData[e];t&&(this._fieldData[e]=t.trim())}}if(this._revisions=e.revisions||[],!t&&this.fieldUpdates?this.dirty.value=this.fieldUpdates.size>0:a&&this.fieldUpdates.has(r.CoreField.History)?(this.fieldUpdates=new Map([[r.CoreField.History,this.fieldUpdates.get(r.CoreField.History)]]),this.dirty.value=!0):this.fieldUpdates=new Map,Object.keys(this._fieldData).forEach((e=>{this._defineFieldById(+e)})),t&&(this.fields.forEach((e=>{(0,N.resetField)(e)})),this.resetContributionErrorStatuses()),l=[],e.files&&l.push(...e.files),e.relations&&l.push(...e.relations),e.relationRevisions&&l.push(...e.relationRevisions),this._allLinks=[],this._currentLinks=void 0,this._allLinks.push(...l.map((e=>j.Link.createFromLinkData(e)))),this.relatedData={},this.referencedPersons=e.referencedPersons||{},this.id=this.getFieldValueById(r.CoreField.Id)||0,0===this.id&&(e.tempId?(this.tempId=e.tempId,i.reserveTempId(this.tempId)):this.tempId=i.getTempId()),this.revision.value=this.getFieldValueById(r.CoreField.Rev)||0,this._isCommentingAvailable=null!==(o=e.isCommentingAvailable)&&void 0!==o&&o,this.isNew()){const e=this.project.id;this.setFieldValueById(r.CoreField.AreaId,null!=s?s:e,{setByRule:!0}),this.setFieldValueById(r.CoreField.IterationId,null!=n?n:e,{setByRule:!0}),this.setFieldValueById(r.CoreField.WorkItemType,this._typeData.name,{setByRule:!0}),this.setFieldValueById(r.CoreField.Id,0,{setByRule:!0}),this._revisionsPopulated=!0}else this._revisionsPopulated=null!=e.revisions&&null!=e.revisions&&e.revisions.length>0||null!=e.relationRevisions&&null!=e.relationRevisions&&e.relationRevisions.length>0;const u=[r.DalFields.RelatedLinks,r.DalFields.AttachedFiles,r.DalFields.BISURI,r.DalFields.LinkedFiles];this.fieldMap[r.CoreFieldRefNames.Parent]&&u.push(r.CoreField.Parent),this.evaluate(u),this.isNew()&&(this.initialValues=new Map(this.fieldUpdates),this.dirty.value=!0),!t&&this.manuallySetFields.size>0?(this.dirty.value=!0,this.manualDirty.value=!0):a&&this.manuallySetFields.has(r.CoreField.History)?(this.manuallySetFields=new Map([[r.CoreField.History,this.manuallySetFields.get(r.CoreField.History)]]),this.dirty.value=!0,this.manualDirty.value=!0):this.manuallySetFields=new Map}resetContributionErrorStatuses(){this._contributionErrorMap&&Object.keys(this._contributionErrorMap).length>0&&(this._contributionErrorMap={})}restoreLinkUpdates(e){if(e){if(e.addedLinks){const t=e.addedLinks;for(const e of t){const t=j.Link.createFromLinkData(e);this.addLinks([t])}}if(e.deletedLinks){const t=e.deletedLinks;for(const e of t){const t=this.findLink(j.Link.createFromLinkData(e));t&&this.removeLinks([t])}}}}addLinks(e,t){var i,a;if(this.isReadOnly())return;const s={};for(const t of e){let e=!1,r=!1;for(const s of this._allLinks)if(!s.isRemoved()&&t.isDuplicate(s)){if(s.pendingDeletion){(0,o.localeComparer)(null!==(i=s.getComment())&&void 0!==i?i:"",null!==(a=t.getComment())&&void 0!==a?a:"")||s.setComment(t.getComment()),e=!0,s.pendingDeletion=!1;break}r=!0;break}if(r)continue;const n=t.getFieldId();e?s[n]=0:(s[n]=(s[n]||0)+1,this._allLinks.push(t))}if(e.length){this.resetLinks(void 0,t);const e=[];let i;for(const t in s)if(s.hasOwnProperty(t)){const a=+t;e.push(a),i=j.Link.getCountFieldId(a),this.evaluateField(i,!0,this.getFieldValueById(i)-s[a])}this.evaluateDirty(),this.evaluateFields(e,e),this.evaluateDirty()}}removeLinks(e,t){if(this.isReadOnly())return;let i=0;const a={};let s;for(const t of e)t.getIsLocked()||(s=t.getFieldId(),t.remove({preventEvent:!0}),a[t.getFieldId()]=(a[s]||0)+1,i++);if(i){this.resetLinks(!0,t);const e=[];let i;for(const t in a)if(a.hasOwnProperty(t)){const s=+t;e.push(+s),i=j.Link.getCountFieldId(s),this.evaluateField(i,!0,this.getFieldValueById(i)+a[s])}this.evaluateDirty(),this.evaluateFields(e,e),this.evaluateDirty()}}findLink(e){const t=this._allLinks;for(const i of t)if(i.equals(e))return i}getLinkUpdates(e){const t=[],i=[],a=[];for(const s of this._allLinks)s.isRemoved()||(s.pendingDeletion?(t.push(s.linkData),e&&e.deletedLinks&&e.deletedLinks.push(s)):s.isNew()?(a.push(s.linkData),e&&e.addedLinks&&e.addedLinks.push(s)):s.pendingUpdate&&(i.push(s.linkData),e&&e.updatedLinks&&e.updatedLinks.push(s)));const s={};return t.length>0&&(s.deletedLinks=t),i.length>0&&(s.updatedLinks=i),a.length>0&&(s.addedLinks=a),s}resetLinks(e,t){let i;if(this._currentLinks=void 0,this._allLinks=this._allLinks.filter((i=>!(e&&i.pendingDeletion&&i.isNew())&&(!(!t||i.getLinkType()==r.WorkItemLinkConstants.ATTACHEDLINKTYPE)||!i.isRemoved()))),e){const e=this._allLinks;for(let t=0,a=e.length;t<a;t++)i=e[t],i.pendingDeletion&&i.isNew()&&(e.splice(t--,1),a--)}for(const e of this._allLinks)e.setState(!0)}getLinks(e){return e?this._allLinks:(this._currentLinks||(this._currentLinks=this._allLinks.filter((e=>!e.pendingDeletion&&!e.isRemoved()))),this._currentLinks)}_getLinkCount(e,t){let i=0;return this.getLinks().forEach((a=>{t&&a.isNew()||(e?a instanceof e&&i++:i++)})),i}_getParentLinkId(e){const t=this.getLinks();for(const i of t)if((!e||!i.isNew())&&i instanceof j.WorkItemLink){const e=i;if(e.getWitLinkTypeEndId()===T.CoreLinkTypes.Parent)return e.getTargetId()}}computeFieldValue(e,t,i){var a;let s;const n={success:!1};s=void 0!==i&&i>=0?this.getFieldValueByRevision(t,i):this.getFieldValueById(t);const o=e=>{if(s){const t=this.project.getNodeById(s);if(t){let i;i=t.path?(0,k.getReferencedNodeSegmenets)(t.path):(0,k.getNodeSegments)(t),n.value=i[e],n.success=!0}}};switch(e){case r.CoreField.AreaId:case r.CoreField.IterationId:if(s){const t=this.project.getNode(s,e===r.CoreField.AreaId?0:1);t&&(n.value=t.id,n.success=!0)}break;case r.DalFields.AreaLevel1:case r.DalFields.IterationLevel1:o(0);break;case r.DalFields.AreaLevel2:case r.DalFields.IterationLevel2:o(2);break;case r.DalFields.AreaLevel3:case r.DalFields.IterationLevel3:o(3);break;case r.DalFields.AreaLevel4:case r.DalFields.IterationLevel4:o(4);break;case r.DalFields.AreaLevel5:case r.DalFields.IterationLevel5:o(5);break;case r.DalFields.AreaLevel6:case r.DalFields.IterationLevel6:o(6);break;case r.DalFields.AreaLevel7:case r.DalFields.IterationLevel7:o(7);break;case r.CoreField.AreaPath:case r.CoreField.IterationPath:if(s){let t=this.project.getNodeById(s);t||(t={path:null!==(a=this.getFieldValueById(e))&&void 0!==a?a:this.getFieldValueById(e,!0)}),t?(n.value=t.path||(0,k.getPath)(t,1),n.success=!0):(n.value=e===r.CoreField.AreaPath?C.DeletedAreaPath:C.DeletedIterationPath,n.success=!0)}break;case r.CoreField.NodeName:if(s){const e=this.project.getNodeById(s);e&&(n.value=e.name,n.success=!0)}}return n}getFieldValueByRevision(e,t){const i=this._revisions,a=e+"";if(t<0)return null;if(e===r.CoreField.History)return t<i.length?i[t][e]:this._fieldData[e];{const s=this.getComputedFieldValue(e,t);if(s&&s.success)return s.value;let r,n=!1;for(let e=t;e<i.length;e++)if(i[e].hasOwnProperty(a)){r=(0,d.convertPotentialIdentityRefFromFieldValue)(this._pageContext,i[e][a]),n=!0;break}return n||(r=this.getFieldValueById(e,!0)),r}}getComputedFieldValue(e,t){const i=e+"";if(void 0!==t&&t>=0&&(e===r.CoreField.TeamProject||e===r.CoreField.IterationPath||e===r.CoreField.AreaPath)){const e=this._revisions[t];if(e&&e.hasOwnProperty(i)){const t=e[i];if(t)return{success:!0,value:t}}}switch(e){case r.CoreField.TeamProject:return this.getFieldValueById(e,!0);case r.CoreField.NodeName:case r.CoreField.AreaPath:case r.DalFields.AreaLevel1:case r.DalFields.AreaLevel2:case r.DalFields.AreaLevel3:case r.DalFields.AreaLevel4:case r.DalFields.AreaLevel5:case r.DalFields.AreaLevel6:case r.DalFields.AreaLevel7:return this.computeFieldValue(e,r.CoreField.AreaId,t);case r.CoreField.IterationPath:case r.DalFields.IterationLevel1:case r.DalFields.IterationLevel2:case r.DalFields.IterationLevel3:case r.DalFields.IterationLevel4:case r.DalFields.IterationLevel5:case r.DalFields.IterationLevel6:case r.DalFields.IterationLevel7:return this.computeFieldValue(e,r.CoreField.IterationId,t);default:return null}}isChangeProjectInProgress(){return this._isChangeProjectInProgress}_copyField(e,t,i){if(t&&(0,L.isCloneable)(t)){if(this.getFieldById(t.id)){const a=this.getFieldValueById(t.id);if(!(0,N.isEmpty)(a)){if(!(t.id!==r.CoreField.AreaId&&t.id!==r.CoreField.IterationId||"number"==typeof a&&this.project.id===i.project.id))return;e.setFieldValueById(t.id,a)}}}}async copy(e,t,i,a=!0,s=!0,n=!0,l=[],d=!0,u){var h,c,I;const m=[],g=[],f={},p=e.getService("IVssTelemetryService"),k=this._pageContext.getService("IWorkItemModelService"),v=await this._projectService.getProjectAsync(t),E=this._projectService.getFieldLookup(t);if(!E)throw Error(C.FailedToRetrieveFieldLookupData);const y=new U.WorkItemType(this._pageContext,i,v,E);d="boolean"!=typeof d||d,p.publishEvent("WIT","WorkItem.IncludeWorkItemLinksAndAttachments",{action:"Telemetry for Copy links and attachments checkbox",copyLinks:a,copyAttachments:s});const F=[r.OobFieldRefNames.ResolvedBy,r.OobFieldRefNames.ResolvedDate,r.OobFieldRefNames.ClosedBy,r.OobFieldRefNames.ClosedDate,"Microsoft.Sync.ProjSrv.RequestedAssnGuid","Microsoft.Sync.ProjSrv.RequestedProjGuid","Microsoft.Sync.ProjSrv.ProjGuid","Microsoft.Sync.ProjSrv.TaskGuid"];l=l||[];for(const e of F){const t=this.getFieldByName(e);t&&l.push(t.fieldDefinition.id)}for(const e of l)f[e]=!0;const D=await k.createWorkItem(i,t);for(const e of y.triggerList)if(!f[e]){const t=null===(h=this.getFieldById(e))||void 0===h?void 0:h.fieldDefinition;t&&this._copyField(D,t,y),f[e]=!0}for(const e of y.fields){const t=null===(c=this.getFieldById(e.id))||void 0===c?void 0:c.fieldDefinition;t&&!f[t.id]&&this._copyField(D,t,y)}if(n){let e;if(this.isNew())e=C.CreateCopyCopiedFromNewWorkItem;else{const t=this._isMarkdownDiscussionEnabled?`#${this.id}`:`<a href='x-mvwit:workitem/${this.id}'>${this._typeData.name} ${this.id}</a>`;let i=C.CreateCopyCopiedFrom;a&&s?i=C.CreateCopyCopiedWithAllLinksAndAttachmentsFrom:a?i=C.CreateCopyCopiedWithAllLinksFrom:s&&(i=C.CreateCopyCopiedWithAllAttachmentsFrom),e=(0,o.format)(i,t)}D.setFieldValueById(r.CoreField.History,e)}if(a||s){const t=this.getLinks();for(const i of t){const t=await i.clone(e,D);t instanceof j.Attachment?s&&m.push(t):!a||!t||u&&-1!==u.indexOf(null!==(I=i.linkData.LinkType)&&void 0!==I?I:Number.NaN)||g.push(t)}}!this.isNew()&&d&&g.push(await j.WorkItemLink.create(e,await j.WorkItemLink.findLinkTypeEnd(e,T.LinkTypeName.Related_Link_Name),this.id,"")),m.length>0&&g.push(...m),g.length>0&&D.addLinks(g);const S=[r.DalFields.RelatedLinks,r.DalFields.AttachedFiles,r.DalFields.BISURI,r.DalFields.LinkedFiles];return this.fieldMap[r.CoreFieldRefNames.Parent]&&S.push(r.CoreField.Parent),D.evaluate(S),D}async copyWithChildren(e,t,i,a,s,r,n,l){const d=await this.copy(e,t,i,a,s,r,n,l,[T.CoreLinkTypes.Child]);if(!d.isValid()){const e=d.getInvalidFields()[0].error;throw Error(e)}const u=this.getLinks().filter((e=>e.linkData.LinkType===T.CoreLinkTypes.Child)).map((e=>e.linkData.ID));if(u.length>100)throw Error((0,o.format)(C.CreateCopyTooManyChildren,100));if(u.length>0){const i=this._pageContext.getService("IWorkItemModelService"),h=(await i.getWorkItems(u)).filter((e=>e.project.guid===d.project.guid)),c=await(0,p.mapAsyncSerial)(h,(async i=>{const d=await i.copy(e,t,i.getTypeData(),a,s,r,n,l,[T.CoreLinkTypes.Parent]);if(!d.isValid()){const e=d.getInvalidFields()[0].error;throw Error((0,o.format)(C.CreateCopyErrorCopyingChild,i.id,e))}return d})),I=e.getService("IWorkItemSavingService");await I.saveWorkItemsBatchAsync(c);const m=await(0,p.mapAsyncSerial)(c,(t=>j.WorkItemLink.create(e,T.LinkTypeName.Child_Link_Name,t.id)));d.addLinks(m)}return e.getService("IVssTelemetryService").publishEvent("WIT","WorkItem.CopyWithChildren",{action:"Copy work item with children",copyLinks:a,copyAttachments:s,children:u.length}),d}async changeWorkItemType(e,t,i,a){this._isChangeProjectInProgress=!!t&&this.project.id!==t.id;const s=this._typeData.referenceName,n=this._getFieldChangeOnBugTypeChanged(this._typeData,e);if(this._typeData=e,this._ruleEngine=void 0,this._initializeFields(e),this._typeData.rules.globals.length>0){const e=this._pageContext.getService("IWorkItemDataManager"),t=await e.beginGetConstantSets(this._typeData.rules.globals);t&&(this.store=new b.WorkItemStore(this._pageContext,t))}for(const e of Object.keys(this._fieldData))this._defineFieldById(Number(e));if(null==a||a.forEach((e=>{this.fieldMapById[e.id]||this._defineField(e)})),this.extensions=i||[],this._defineExtensionFields(),t&&this._isChangeProjectInProgress&&await this._setProject(t),s!==e.referenceName){this.setFieldValueById(r.CoreField.WorkItemType,e.name);for(const e in n)this.setFieldValueByName(e,n[e])}this.evaluate(),this._isChangeProjectInProgress=!1}shallowLinkDelete(e){const t=new Set(e.filter((e=>e.linkData&&(e.linkData.FilePath||e.linkData.ID))).map((e=>{var t,i;return null!==(t=e.linkData.FilePath)&&void 0!==t?t:null===(i=e.linkData.ID)||void 0===i?void 0:i.toString()})));0!==t.size&&(this._allLinks=this._allLinks.filter((e=>{var i,a;return!t.has(null!==(i=e.linkData.FilePath)&&void 0!==i?i:null===(a=e.linkData.ID)||void 0===a?void 0:a.toString())})),this._currentLinks=void 0)}async _setProject(e){const t=await this._projectService.getProjectAsync(e.guid);if(!t)throw Error(C.FailedToRetrieveProjectDataForId);this.project=t,this._hasTeamProjectChanged=!0}_getFieldChangeOnBugTypeChanged(e,t){var i;const a={},s=this._isBugTypeChange(e),n=this._isBugTypeChange(t);if(!s&&!n)return a;const l=`<b><u><br/><br/>${(0,o.format)(C.WorkItemChangedReproDescriptionMessage,null===(i=this.getFieldByName(s?T.BugWITFieldReferenceNames.ReproSteps:r.CoreFieldRefNames.Description))||void 0===i?void 0:i.fieldDefinition.name,e.name,t.name)}</u></b><br/>`,d=this.getFieldValueByName(T.BugWITFieldReferenceNames.ReproSteps),u=this.getFieldValueByName(r.CoreFieldRefNames.Description);return s?d&&!(0,W.isHtmlVisuallyBlank)(d)&&(a[r.CoreFieldRefNames.Description]=u?u+l+d:l+d):n&&u&&!(0,W.isHtmlVisuallyBlank)(d)&&(a[T.BugWITFieldReferenceNames.ReproSteps]=d?d+l+u:l+u),a}_isBugTypeChange(e){if(e.fields){const t=this.getFieldLookup();return e.fields.some((e=>{var i,a;return(0,o.equals)(null!==(a=null===(i=t[e])||void 0===i?void 0:i.referenceName)&&void 0!==a?a:"",T.BugWITFieldReferenceNames.ReproSteps,!0)}))}return!1}async _evaluateWorkItemTypeChange(e,t){if((0,o.equals)(e,this.project.name,!0)&&(0,o.equals)(t,this._originalTypeData.name,!0)&&await this._resetWorkItemTypeChanges(),!(0,o.equals)(t,this._typeData.name,!0)){let i;const a=this._pageContext.getService("IWorkItemDataManager");if(!((0,o.equals)(e,this.project.name,!0)||(i=this._projectService.getFieldProjectDataWithNodes(e),i&&i.areaNodes&&i.iterationNodes)))return void console.warn(`Failed to find project data for project ${e}, aborting update of work item type for work item ${this.getUniqueId()}`);const s=await a.beginGetWorkItemTypeData(i.guid,[t]);s&&s[0]&&(this.changeWorkItemType(s[0],i),this._typeData=s[0])}}async _resetWorkItemTypeChanges(){if(this.hasWorkItemTypeChanged()){const e={SourceType:this._originalTypeData.name,DestinationType:this.workItemType.name};(0,o.equals)(this.project.guid,this._originalTypeData.projectGuid)?(0,f.publishEvent)(this._pageContext,T.WITCustomerIntelligenceArea.WORK_ITEM_TRACKING,T.WITCustomerIntelligenceFeature.CLIENTSIDEOPERATION_WIT_MOVE_REVERT,e):(0,f.publishEvent)(this._pageContext,T.WITCustomerIntelligenceArea.WORK_ITEM_TRACKING,T.WITCustomerIntelligenceFeature.CLIENTSIDEOPERATION_WIT_TYPE_CHANGE_REVERT,e);const t=this._projectService.getFieldProjectDataWithNodes(this.project.name);await this.changeWorkItemType(this._originalTypeData,t,this._originalExtensions)}}setExtensions(e){this.extensions=e||[],this._originalExtensions=this.extensions,this._defineExtensionFields(),this._ruleEngine=void 0}_defineExtensionFields(){this.extensions&&this.extensions.forEach((e=>{e.markerField&&this._defineField(e.markerField.field),e.fields&&e.fields.forEach((e=>{this._defineField(e.field)}))}))}addPromiseToWait(e){const t=this.promiseToWaitId++;this.promisesToWait.set(t,e),e.then(void 0,(e=>{this.setError(e),this.promisesToWait.delete(t)}))}cleanPromisesToWait(){this.promisesToWait.clear(),this.promiseToWaitId=0}async waitForPromisesResolving(){try{this.saving.value=!0,await Promise.all(Array.from(this.promisesToWait.values()))}finally{this.saving.value=!1,this.cleanPromisesToWait()}}}t[e].WorkItem=i,i.tempIdSeed=0,i.FIELD_ID_TO_DEPENDENT_ID_MAP={[r.DalFields.AttachedFiles]:[r.CoreField.AttachedFileCount],[r.DalFields.RelatedLinks]:[r.CoreField.RelatedLinkCount,r.CoreField.Parent],[r.DalFields.LinkedFiles]:[r.CoreField.HyperLinkCount],[r.DalFields.BISURI]:[r.CoreField.ExternalLinkCount],[r.DalFields.HistoryId]:[r.CoreField.CommentCount]}}("WorkItemWorkItem"),function(e){t.ServicesWorkItemModelService={};const i="TagsMru",a="Tags";class s extends u.VssService{constructor(){super(...arguments),this.workItemTypeExtensions={},this.workItemPromiseCache=new Map}_serviceStart(e){super._serviceStart(e),this.nodeService=e.getService("IWorkItemNodeService"),this.workItemDataManager=e.getService("IWorkItemDataManager"),this.workItemMap={}}addWorkItemToMap(e,t){this.workItemMap[e]=t}clearWorkItems(){this.workItemPromiseCache.clear(),this.workItemMap={},this.workItemTypeExtensions={}}clearWorkItem(e){this.workItemPromiseCache.delete(e),delete this.workItemMap[e]}async createWorkItem(e,t,i){const a=await this.getFieldProjectData(t),s=await this.getMruNodeData(t);if(a)return await this.createWorkItemModel(e,t,i,s,!0);throw new Error(C.FailedToRetrieveProjectDataForId)}async getMruNodeData(e){var t,i,a,s,r,n,o;const l={};if(l.iterationPathMru=(await this.nodeService.getMruIterations(e))[0],l.areaPathMru=(await this.nodeService.getMruAreaPaths(e))[0],this.isSpecificPageLayout()){const e=this.pageContext.getService("ITeamSettingsService"),d=await e.getTeamSettings();(null===(t=null==d?void 0:d.referencedNodes)||void 0===t?void 0:t.areaNodes)&&(l.areaPathMru=null!==(a=null===(i=null==d?void 0:d.referencedNodes)||void 0===i?void 0:i.areaNodes[0].id)&&void 0!==a?a:l.areaPathMru),d&&(l.iterationPathMru=null!==(o=null!==(r=null===(s=d.defaultIteration)||void 0===s?void 0:s.nodeId)&&void 0!==r?r:null===(n=d.currentIteration)||void 0===n?void 0:n.nodeId)&&void 0!==o?o:l.iterationPathMru)}return l}isSpecificPageLayout(){const e=this.pageContext.getService("IVssNavigationService").getRouteValues().pivot;return"backlog"===e||"board"===e||"taskboard"===e}async getWorkItems(e,t){if(!e||!e.length)return[];const i=[],a=[];if(e.forEach((e=>{const s=this.workItemMap[e];s&&!(null==t?void 0:t.isCacheDisabled)?i.push(s):a.includes(e)||a.push(e)})),a.length){const e=void 0===(null==t?void 0:t.errorPolicy)||1===(null==t?void 0:t.errorPolicy),s=await this.workItemDataManager.beginGetWorkItemData(a,null==t?void 0:t.isDeleted,null==t?void 0:t.includeRecentActivity,null==t?void 0:t.includeHistory,null==t?void 0:t.errorPolicy);if(!s||e&&s.length!==a.length){const e=a.filter((e=>!(null==s?void 0:s.some((e=>{e.fields[r.DalFields.IDId]})))));console.error((0,o.format)(C.FailedToRetrieveWorkItemDataForIds,e.join(", ")))}else{const e=new Map;for(const a of s){let s;const n=`${a.projectId}-${a.fields[r.DalFields.WorkItemTypeId]}`;if(e.has(n)?s=e.get(n):(s=await this.workItemDataManager.beginGetWorkItemTypeData(a.projectId,[a.fields[r.DalFields.WorkItemTypeId]]),e.set(n,s)),s){const e=await this.createWorkItemModel(s[0],a.projectId,a,void 0,null==t?void 0:t.waitForClassificationNodes);i.push(e)}}}}return i}async refreshWorkItemLinks(e){const t=e.getLinks().filter((e=>0===(0,o.localeIgnoreCaseComparer)(e.baseLinkType,"WorkItemLink")));for(const e of t){if(!e.linkData.ID)continue;this.clearWorkItem(e.linkData.ID);(await this.getWorkItem(e.linkData.ID)).refresh().catch((e=>alert(e)))}}async getWorkItem(e,t){let i=this.workItemPromiseCache.get(e);i||(i=this.getWorkItems([e],{isDeleted:null==t?void 0:t.isDeleted,includeRecentActivity:null==t?void 0:t.includeRecentActivity,includeHistory:null==t?void 0:t.includeHistory,waitForClassificationNodes:null==t?void 0:t.waitForClassificationNodes}),this.workItemPromiseCache.set(e,i));const a=await i;if(!a.length)throw Error((0,o.format)(C.InvalidWorkItemId,e));return a[0]}getWorkItemTypeData(e,t){return this.workItemDataManager.beginGetWorkItemTypeData(e,t)}async getConstantSets(e){const t=await this.workItemDataManager.beginGetConstantSets(e);return null!==t?t:{}}getFieldProjectData(e){return this.workItemDataManager.beginGetFieldProjectData(e)}async getFieldLookup(e){const t=await this.getFieldProjectData(e),i={};return t&&t.fields.forEach((e=>{i[e.id]=e,i[e.referenceName]=e})),i}async addTagsMru(e){const t=await this.getTagsMRU(),s=(0,N.subtract)(t,e),r=e.concat(s);r.splice(5),this.workItemTagsMruCache=r;const n={};n[`${i}/${a}`]=r;return this.pageContext.getService("ISettingsService").setEntries(n,0)}async getTagsMRU(){this.workItemTagsMruCache&&this.workItemTagsMruCache.slice();const e=this.pageContext.getService("ISettingsService"),t=await e.getEntriesAsync(i,0),s=t&&t[a]||[];return this.workItemTagsMruCache=(0,N.subtract)(s,[";;;;;",";SUGGESTIONS;"]),this.workItemTagsMruCache.slice()}async createWorkItemModel(e,t,i,a,s){var r;if(!(i=i||{}).isCommentingAvailable){const e=this.pageContext.getService("IVssContributionService"),t={areaId:null==a?void 0:a.areaPathMru},s=await e.getDataAsync("ms.vss-work-web.work-item-permissions-data-provider",t),n=!!(null===(r=null==s?void 0:s.saveWorkItemCommentPermission)||void 0===r?void 0:r.hasPermission);i.isCommentingAvailable=n}const n=await H.WorkItem.createAsync(this.pageContext,t,e,i,a,void 0,s);return this.workItemMap[n.id]=n,n}getWorkItemTypeExtensions(e){return new Promise(((t,i)=>this.beginGetWorkItemTypeExtensions(e,t,i)))}beginGetWorkItemTypeExtensions(e,t,i){const a=[];let s=null,r=0,n=0,o=[];const l=()=>{0===n&&t.call(this,o)},d=e=>{const t={controller:"wit",action:"workItemTypeExtensions"},a=this.pageContext.getService("IVssPageService").getData();new m.WorkItemStoreLevelWITDataSource(this.pageContext).getDataFromCacheAsync(t,{extensionIds:e},a.hostId,t.action,"_").then((e=>{const t=e.data;t.forEach((e=>{e.fields.map((e=>e.field))}));let i=[];t.forEach((e=>{this.workItemTypeExtensions[e.id]=e,e.globals&&(i=i.concat(e.globals))})),o=o.concat(t),n--,l()}),i)};if(e&&e.length>0)if(e.forEach((e=>{if(this.workItemTypeExtensions[e])o.push(this.workItemTypeExtensions[e]);else{const t=e.length+15;r+t>1024&&(r=0,s=null),s?s.push(e):(s=[e],a.push(s),n++),r+=t}})),0===a.length)l();else for(;a.length>0;)d(a.pop());else t.call(this,o)}isWorkItemCached(e){return!!this.workItemMap[e]}}u.Services.add("IWorkItemModelService",{serviceFactory:s})}(),function(e){G=t[e]={};t[e].LegacyField=class{constructor(e,t){this._value=t,this._field=e,this.fieldDefinition=e.fieldDefinition}getValue(){return this._value}getDisplayText(){var e;return null!==(e=(0,N.convertFieldValueToDisplayString)(this._value))&&void 0!==e?e:""}setValue(e,t){const i=this._field.workItem.setFieldValueById(this.fieldDefinition.id,e,t);return this._value=e,i}getAllowedValues(){var e;return null===(e=this._field.lists)||void 0===e?void 0:e.allowedValues[0].items}}}("WorkItemLegacyField"),function(e){Q=t[e]={};t[e].LegacyTfsClient=class{constructor(e){this._pageContext=e,this._restClient=(0,h.getWorkItemTrackingClient)(e)}async beginAttachmentUpload(e,t,i,a,s,r){return this._restClient.createAttachment(t,e,r,void 0,i)}}}("WorkItemLegacyTfsClient"),function(e){K=t[e]={};t[e].LegacyTfsConnection=class{constructor(e){this._client=new Q.LegacyTfsClient(e)}getHttpClient(e){return this._client}}}("WorkItemLegacyTfsConnection"),function(e){q=t[e]={};t[e].LegacyWorkItemStore=class{constructor(e,t){this.tfsConnection=new K.LegacyTfsConnection(e),this._linkTypeEnds=t}findLinkTypeEnd(e){const t=(""+e).toUpperCase();for(const i of this._linkTypeEnds){if(i.id===e)return i;if(i.name.toUpperCase()===t)return i;if(i.immutableName.toUpperCase()===t)return i}throw Error()}}}("WorkItemLegacyStore"),function(e){t[e]={};t[e].LegacyWorkItem=class{constructor(e,t,i){this.sessionId="NewWorkItemFormLegacyContainer",this._pageContext=e,this._workItem=t,this._linkTypeEnds=i,this.rev=t.revision.value,this.id=t.id,this.workItemType={name:this._workItem.getFieldValueById(r.CoreField.WorkItemType)},this.project={guid:this._workItem.project.guid,name:this._workItem.project.name,extras:this._workItem.project.extras},this.store=new q.LegacyWorkItemStore(e,i)}getField(e){if("number"==typeof e){const t=this._workItem.getFieldById(e);if(void 0===t)return;return new G.LegacyField(t,this._workItem.getFieldValueById(e))}{const t=this._workItem.getFieldByName(e);if(void 0===t)return;return new G.LegacyField(t,this._workItem.getFieldValueByName(e))}}getState(){return this.getFieldValue(r.CoreField.State)||""}getTitle(){return this.getFieldValue(r.CoreField.Title)||""}isReadOnly(){return this._workItem.isReadOnly()}isCommentingAvailable(){return this._workItem.isCommentingAvailable()}isNew(){return this._workItem.isNew()}isSaving(){return this._workItem.saving.value}getFieldValue(e,t,i){return"number"==typeof e?this._workItem.getFieldValueById(e):this._workItem.getFieldValueByName(e)}setFieldValue(e,t){this._workItem.setFieldValueByName(e,t)}attachFieldChange(e,t){}detachFieldChange(e,t){}attachWorkItemChanged(e){}detachWorkItemChanged(e){}getComputedFieldValue(e,t){return this._workItem.getComputedFieldValue(e)}getWorkItemContract(){if(this.isNew())return null;const e={};return this._workItem.fields.forEach((t=>{e[t.fieldDefinition.referenceName]=this.getFieldValue(t.fieldDefinition.referenceName)})),{id:this.id,rev:this._workItem.revision.value,relations:null,fields:e,_links:null,url:this.getResourceUrl()}}getResourceUrl(){const e=this._pageContext.getRestClient("IWorkItemTrackingRestClient")._options.rootPath;return`${window.location.origin}${e}_apis/wit/workItems/${this.id}`}getLinks(){return this._workItem.getLinks().map((e=>{const t={linkData:e.linkData,workItem:{id:this._workItem.id},getAddedDate:()=>e.getAddedDate(),getComment:()=>e.getComment(),getFilePath:()=>e.linkData.FilePath,getFieldId:()=>e.getFieldId(),getLength:()=>e.linkData.Length,getName:()=>e.linkData.OriginalName,getUri:e=>"",remove:()=>{this._workItem.removeLinks([e])},getTargetId:()=>e.linkData.ID,getLinkTypeEnd:()=>{var t;for(let i=0;i<this._linkTypeEnds.length;i++){const a=this._linkTypeEnds[i];if(e.linkData.LinkType===a.linkType.reverseEnd.id)return{immutableName:null===(t=a.linkType)||void 0===t?void 0:t.reverseEnd.immutableName}}},open:()=>{var t;null===(t=this.getAttachmentUri)||void 0===t||t.call(this,e.linkData).then((t=>{const i=e.linkData.OriginalName,a=t.concat(i?`?fileName=${i}`:"");window.open(a,"_blank")}))}};return Object.defineProperty(t,"comment",{get:function(){return e.comment},set:function(t){e.setComment(t)}}),t}))}addLink(e){this._workItem.addLinks([this.getReplatLink(e)])}removeLinks(e){const t=e.map((e=>this.getReplatLink(e)));this._workItem.removeLinks(t)}getReplatLink(e){const t={ID:e.linkData.ID,Comment:e.comment,FilePath:e.linkData.FilePath,FldID:e.linkData.FldID,OriginalName:e.linkData.OriginalName,Length:e.linkData.Length,LastWriteDate:e.linkData.LastWriteDate,ExtID:e.linkData.ExtID,CreationDate:e.linkData.CreationDate,RemovedDate:e.linkData.RemovedDate,AddedDate:e.linkData.AddedDate,LinkType:e.linkData.LinkType};return j.Link.createFromLinkData(t)}}}("WorkItemLegacyWorkItem"),function(e){t.ServicesWorkItemFormUnsavedChangesService={};class i extends u.VssService{constructor(){super(...arguments),this.workItems=[],this.saving=new n.ObservableValue(!1),this.unsavedChangesDialogShown=!1,this.errorUnsavedWorkItems=new n.ObservableArray([]),this.filters=new Set,this.resolveDialog=(e,t,i)=>{this.unsavedChangesDialogShown=!1,t(),i(e)},this.onBeforeUnload=e=>{this.isDirty()&&(e.returnValue="dirtyState",e.preventDefault())},this.onFpsStarting=e=>{[...this.filters.values()].some((t=>!t(e)))||!this.isDirty()||e.detail.data&&e.detail.data.userConfirmed||(e.preventDefault(),e.detail.cancellationReason="dirtyState",this.showMessage().then((t=>{t&&(0,E.FastPageSwitch)(e.detail.pageContext,e.detail.href,e.detail.recordHistoryEntry,Object.assign(Object.assign({},e.detail.data),{userConfirmed:!0}))})))},this.isDirty=()=>{for(const e of this.workItems)if(e.dirty.value)return!0;return!1},this.saveWorkItems=(e,t)=>{const i=this.pageContext.getService("IWorkItemSavingService");this.saving.value=!0,i.saveWorkItemsBatchAsync(this.workItems.filter((e=>e.dirty.value))).then(e,t)},this.saveWorkItem=(e,t,i)=>{this.saving.value=!0,i().then(e).catch(t)},this.resetWorkItems=()=>{for(const e of this.workItems)e.resetChanges()},this.resetWorkItem=e=>{e.resetChanges()},this.getWorkItemTitles=e=>e.map((e=>e.getCaption({excludeTempId:!0}))).join(", "),this.getWorkItemTitle=e=>e.getCaption({excludeTempId:!0})}isUnsavedChangesDialogActive(){return this.unsavedChangesDialogShown}_serviceStart(e){super._serviceStart(e),document.body.addEventListener("fpsStarting",this.onFpsStarting),window.addEventListener("beforeunload",this.onBeforeUnload)}_serviceEnd(e){super._serviceEnd(e),document.body.removeEventListener("fpsStarting",this.onFpsStarting),window.removeEventListener("beforeunload",this.onBeforeUnload),this.filters.clear()}register(e){this.workItems.includes(e)||this.workItems.push(e)}unregister(e){this.workItems=this.workItems.filter((t=>t!==e))}registerFPSFilter(e){this.filters.add(e)}async showMessage(e,t){const i=this.pageContext.getService("IVssLayoutManager");return this.unsavedChangesDialogShown?Promise.resolve(!1):(this.unsavedChangesDialogShown=!0,new Promise((a=>i.renderCallout((i=>v.createElement(F.Observer,{errorUnsavedWorkItems:this.errorUnsavedWorkItems,saving:this.saving},(s=>v.createElement(y.Dialog,{footerButtonProps:[{text:C.Cancel,onClick:()=>{this.resolveDialog(!1,i,a)}},{text:C.DiscardChanges,onClick:()=>{e?this.resetWorkItem(e):this.resetWorkItems(),this.resolveDialog(!0,i,a)}},{onClick:()=>{const s=()=>{this.saving.value=!1,this.resolveDialog(!0,i,a)},r=e=>{this.saving.value=!1,this.errorUnsavedWorkItems.value=e.results?e.results.filter((e=>!!e.error)).map((e=>e.workItem)):[]};e&&t?this.saveWorkItem(s,r,t):this.saveWorkItems(s,r)},primary:!0,text:C.SaveChanges}],modal:!0,onDismiss:()=>{this.resolveDialog(!1,i,a)},overlay:s.saving?{spinnerLabel:C.SavingWorkItems}:void 0,titleProps:{text:C.DirtyNavDialogTitle}},v.createElement("div",{className:"padding-vertical-4"},v.createElement("div",null,C.DirtyNavDialogUnsavedChanges),v.createElement("div",null,e?this.getWorkItemTitle(e):this.getWorkItemTitles(this.workItems.filter((e=>e.dirty.value))))),v.createElement("div",{className:"padding-vertical-4"},C.DirtyNavDialogOptions),0!==this.errorUnsavedWorkItems.length&&v.createElement("div",{className:"error-text padding-vertical-4"},v.createElement("div",null,C.DirtyNavDialogSavingFailure," "),v.createElement("div",null,this.getWorkItemTitles(s.errorUnsavedWorkItems)))))))))))}}u.Services.add("IWorkItemFormUnsavedChangesService",{serviceFactory:i})}()}),["Resources","OM/WorkItemConstants","OM/index","RuleEngine/FilterByScope","RuleEngine/FieldValidationKey","RuleEngine/ServerDefaultValue","Utils","WorkItem/Sorting","WorkItem/FieldDefinitionUtils","WorkItem/FieldUtils","RuleEngine/RuleValueFrom","RuleEngine/WorkItemIdentityScope","RuleEngine/RuleEvaluator","RuleEngine/RuleEngine","RuleEngine/WorkItemStore","Services/IWorkItemEventService","Services/IWorkItemFieldEventService","Services/IWorkItemModelService","WorkItem/WorkItemType","WorkItem/Project","Services/ProjectService","WorkItem/Links","Services/WorkItemSavingService","WorkItem/WorkItem","Services/WorkItemModelService","WorkItem/LegacyField","WorkItem/LegacyTfsClient","WorkItem/LegacyTfsConnection","WorkItem/LegacyStore","WorkItem/LegacyWorkItem","Services/WorkItemFormUnsavedChangesService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-model"}}));