"use strict";define("Wit/Common/WorkItemNodeService",["require","exports","VSS/Platform/Context","VSS/Platform/Feature","Wit/Common/Constants/FeatureFlags","Wit/Common/NodeHelpers"],(function(t,e,r,a,o,s){!function(t){var i;e[t]={},function(t){t.maxNodeDepth=15}(e[t].NodeConstants||(e[t].NodeConstants={})),function(t){t.SettingsKey="ClassificationFieldsMru",t.AreaPathMruKey="AreaPath",t.IterationPathMruKey="IterationPath",t.MruLength=5}(i||(i={}));class n extends r.VssService{constructor(){super(...arguments),this.projectToAreaPathMap=new Map,this.projectToIterationMap=new Map,this.projectPromiseMap=new Map,this.projectToMruAreaPathsMap=new Map,this.projectToMruIterationsMap=new Map,this.projectMruPromiseMap=new Map,this.projectNodesById=new Map}_serviceStart(t){super._serviceStart(t)}async findIterationNodeByPath(t,e){this.projectToIterationMap.get(t)||await this.loadNodes(t);const r=this.projectToIterationMap.get(t);return(0,s.findByPath)(r,e,void 0,1)}async getAreaPathNodes(t){return this.projectToAreaPathMap.get(t)||await this.loadNodes(t),this.projectToAreaPathMap.get(t)}async getIterationNodes(t){return this.projectToIterationMap.get(t)||await this.loadNodes(t),this.projectToIterationMap.get(t)}getNodeById(t,e){const r=this.projectNodesById.get(t);if(r&&e in r)return r[e]}removeIterationNodes(t){this.projectToIterationMap.delete(t),this.projectPromiseMap.delete(t)}async getMruAreaPaths(t){return this.projectToMruAreaPathsMap.get(t)||await this.loadMruNodeIds(t),this.projectToMruAreaPathsMap.get(t)}async updateMruAreaPaths(t,e){let r=this.projectToMruAreaPathsMap.get(t);r||(r=await this.getMruAreaPaths(t));const a=await this.updateMru(t,r,e,i.AreaPathMruKey);return this.projectToMruAreaPathsMap.set(t,a),a}async getMruIterations(t){return this.projectToMruIterationsMap.get(t)||await this.loadMruNodeIds(t),this.projectToMruIterationsMap.get(t)}async updateMruIterations(t,e){let r=this.projectToMruIterationsMap.get(t);r||(r=await this.getMruIterations(t));const a=await this.updateMru(t,r,e,i.IterationPathMruKey);return this.projectToMruIterationsMap.set(t,a),a}async updateNodes(t){await this.loadNodes(t,!0)}getNodesPromiseByProjectId(t){return this.projectPromiseMap.get(t)}async updateMru(t,e,r,a){const o=this.buildNewMru(e,r),s={[`${i.SettingsKey}/${a}`]:o},n=this.pageContext.getService("ISettingsService");return await n.setEntries(s,0,"project",t),o}async loadMruNodeIds(t){let e=this.projectMruPromiseMap.get(t);if(!e){e=this.pageContext.getService("ISettingsService").getEntriesAsync(i.SettingsKey,0,"project",t),this.projectMruPromiseMap.set(t,e)}const r=await e;if(!r)return;const a=r&&r[i.AreaPathMruKey]||[],o=r&&r[i.IterationPathMruKey]||[];this.projectToMruAreaPathsMap.set(t,a),this.projectToMruIterationsMap.set(t,o)}async loadNodes(t,e){let r=this.projectPromiseMap.get(t);const s=this.pageContext.getService("IWorkItemDataManager"),i=s.beginGetFieldProjectData(t),n=!(0,a.isFeatureFlagEnabled)(this.pageContext,o.FeatureFlags.MovingToNewIterationFixDisabled,!1);(!r||n&&e)&&(r=s.beginGetNodes(t,e),this.projectPromiseMap.set(t,r));const[c,p]=await Promise.all([r,i]);if(!c)return;const h=null==p?void 0:p.projects[0],d=this.normalizeNode(h,c.find((t=>0===t.structureType))),u=this.normalizeNode(h,c.find((t=>1===t.structureType)));if(d&&this.projectToAreaPathMap.set(t,d),u&&this.projectToIterationMap.set(t,u),n){let e={};const r=t=>{e[t.id]=t,t.hasChildren&&t.children&&t.children.forEach(r)};d&&r(d),u&&r(u),Object.keys(e).length>0&&this.projectNodesById.set(t,e)}}normalizeNode(t,e){return t&&e?{attributes:{},children:e.children,hasChildren:e.hasChildren,id:t.id,identifier:t.guid,name:t.name,path:t.name,structureType:e.structureType}:e}buildNewMru(t,e){if(!e||0===e.length)return t;const r=new Set(e),a=t.filter((t=>!r.has(t))),o=[...r,...a];return o.splice(i.MruLength,o.length-i.MruLength),o}}r.Services.add("IWorkItemNodeService",{serviceFactory:n})}("IWorkItemNodeService")}),["IWorkItemNodeService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-node-service"}}));