"use strict";define("TFS/GlobalBanner",["require","exports","react","VSS/Platform/Components/Format","VSS/Platform/Layout","VSS/Ext/ExternalContent","VSSUI/Link","VSS/Features/PlatformUI/ContributedButton","VSS/Features/PlatformUI/FPSLink","VSSUI/Icon","VSS/Platform/Feature","VSS/Platform/Context","VSS/Platform/Fetch","VSS/Platform/UserClaims"],(function(e,s,t,n,a,o,i,r,l,c,g,m,p,d){var h,u,b,C,f;h=s[f="Resources"]={},s[f].Dismiss="Dismiss",s[f].LearnMore="Learn more",function(e){u=s[e]={};class r extends a.VssComponent{constructor(e,s){super(e,s),this.onCornerDialogClose=()=>{this.globalMessageService.closeDialog()},this.onDialogChanged=e=>{this.setState({dialog:e})},this.globalMessageService=s.pageContext.getService("IGlobalMessagesService");const t=this.globalMessageService.getDialog();this.state={dialog:t}}componentDidMount(){this.globalMessageService.subscribe(this.onDialogChanged,"DIALOG_CHANGED")}render(){const{dialog:e}=this.state;if(!e)return null;const s=e.buttonProps||[];return e.closeButtonProps&&s.push(Object.assign(Object.assign({},e.closeButtonProps),{onClick:this.onCornerDialogClose})),e.contributionId?t.createElement(a.WrappedComponent,Object.assign({wrappedType:"customDialog",dependencies:["ms.vss-features.ui-layer-content"]},Object.assign({onDismiss:()=>{e.onDismiss&&e.onDismiss(),this.onCornerDialogClose()}},e.contentProperties)),t.createElement(o.ExternalContent,{contributionId:e.contributionId,initialHandshakeData:Object.assign({},e.contributionConfiguration)})):e.componentType?t.createElement(a.WrappedComponent,Object.assign({wrappedType:e.componentType,dependencies:e.contentDependencies},Object.assign({onDismiss:this.onCornerDialogClose},e.contentProperties))):t.createElement(a.WrappedComponent,{wrappedType:"cornerDialog",dependencies:["ms.vss-features.ui-layer-content"],onDismiss:this.onCornerDialogClose,footerButtonProps:s.length>0?s:void 0,titleProps:{text:e.title}},e.message||e.messageFormat&&e.messageLinks?e.messageFormat&&e.messageLinks?t.createElement(n.FormatComponent,{className:"message",format:e.messageFormat},e.messageLinks.map(((e,s)=>t.createElement(i.Link,{href:e.href,target:"_blank",rel:"noopener noreferrer",key:s},e.name)))):t.createElement("div",{className:"message"},e.message):null)}componentWillUnmount(){this.globalMessageService.unsubscribe(this.onDialogChanged,"DIALOG_CHANGED"),super.componentWillUnmount()}}s[e].GlobalDialogComponent=r,r.componentType="globalDialog",a.VssComponent.register(r.componentType,r)}("ComponentsGlobalDialog"),function(e){b=s[e]={};class o extends a.VssComponent{constructor(e,s){super(e,s),this.onMessageBannerClose=()=>{this.globalMessagesService.closeBanner()},this.onMessageBannerChanged=e=>{this.setState({messageBanner:e},m)},this.onLearnLinkClicked=e=>{if(e.settingId){this.context.pageContext.getService("IVssTelemetryService").publishEvent("GlobalMessageBanner","bannerLearnMoreClicked",{settingId:e.settingId})}},this.globalMessagesService=s.pageContext.getService("IGlobalMessagesService"),this.globalMessagesService.subscribe(this.onMessageBannerChanged,"MESSAGE_CHANGED");const t=this.globalMessagesService.getBanner();this.state={messageBanner:t}}render(){const{messageBanner:e}=this.state;if(!e)return null;const{level:s}=e;let o="Info";3===s?o="Success":2===s?o="Error":1===s&&(o="Warning");const g=this.getLinkContainerLinkId();return t.createElement("div",{className:"global-message-banner flex-row flex-grow"},t.createElement(a.WrappedComponent,{dependencies:["ms.vss-features.ui-messagebar-content"],wrappedType:"messageBar",buttonProps:e.buttons?e.buttons.map((e=>(0,r.contributedButtonToButtonProps)(this.context.pageContext,e))):void 0,className:"flex-grow",messageClassName:e.componentType?"flex-grow":"",iconProps:e.customIcon?{iconName:e.customIcon}:void 0,onDismiss:!1!==e.dismissable?this.onMessageBannerClose:void 0,severity:o},e.componentType?t.createElement(a.WrappedComponent,Object.assign({wrappedType:e.componentType,dependencies:e.contentDependencies},Object.assign({onDismiss:this.onMessageBannerClose},e.contentProperties))):t.createElement("div",{className:"flex-grow"},e.message||e.messageFormat&&e.messageLinks?e.messageFormat&&e.messageLinks?t.createElement(n.FormatComponent,{id:g,elementType:"span",format:e.messageFormat},e.messageLinks.map(((e,s)=>e.supportsFPS?t.createElement(l.FPSLink,{href:e.href},e.name):t.createElement(i.Link,{href:e.href,target:"_blank",rel:"noopener noreferrer",key:s,ariaLabelledBy:g},e.name)))):t.createElement("span",null,e.message):null,e.helpInfo?t.createElement(i.Link,{className:"help-link font-size-ml",href:e.helpInfo.href,role:e.helpInfo.href?void 0:"presentation",tooltipProps:e.helpInfo.tooltip?{text:e.helpInfo.tooltip}:void 0},t.createElement(c.Icon,{iconName:"Unknown",className:"v-align-middle"})):null,e._links&&e._links.learn?t.createElement(i.Link,{className:"learn-link",href:e._links.learn.href,onClick:()=>this.onLearnLinkClicked(e)},h.LearnMore):null)))}componentWillUnmount(){this.globalMessagesService.unsubscribe(this.onMessageBannerChanged,"MESSAGE_CHANGED"),super.componentWillUnmount()}getLinkContainerLinkId(){return(0,g.isFeatureFlagEnabled)(this.context.pageContext,"GlobalMessageBanner.AccessibleMessageLinks",!1)?"global-messagebar-link-container":void 0}}function m(){const e=document.createEvent("Event");e.initEvent("resize",!1,!0),window.dispatchEvent(e)}s[e].GlobalBannerComponent=o,o.componentType="globalBanner",a.VssComponent.register(o.componentType,o);class p extends a.VssComponent{constructor(e,s){if(super(e,s),this.globalMessagesService=s.pageContext.getService("IGlobalMessagesService"),this.layoutManager=s.pageContext.getService("IVssLayoutManager"),this.actions=this.globalMessagesService.getActions(),this.actions&&this.actions.length)for(const e of this.actions)this.layoutManager.renderCallout((s=>t.createElement(a.WrappedComponent,Object.assign({wrappedType:e.componentType,dependencies:e.contentDependencies},Object.assign({onClose:s},e.contentProperties)))))}render(){return null}}p.componentType="globalActions",a.VssComponent.register(p.componentType,p)}("ComponentsGlobalMessageBanner"),function(e){C=s[e]={};class n extends a.VssComponent{constructor(e,s){super(e,s),this.toastRef=t.createRef(),this.toastQueue=[],this.toastExpiresTimeoutId=-1,this.keyId=0,this.onNewToast=e=>{e.forceOverrideExisting?this.fadeOutAndRenderNew(e):this.state.toast?this.toastQueue.push(e):this.updateCurrentToast(e)},this.onToastExpires=()=>{const e=this.toastQueue.shift();e?this.fadeOutAndRenderNew(e):this.clearToast()},this.globalMessagesService=s.pageContext.getService("IGlobalMessagesService"),this.state={}}render(){const{toast:e}=this.state;return e?t.createElement(a.WrappedComponent,Object.assign({wrappedType:"toast",dependencies:["ms.vss-features.ui-layer-content"],key:"globalToast"+this.keyId,wrappedRef:this.toastRef},e)):null}componentDidMount(){this.globalMessagesService.subscribe(this.onNewToast,"TOAST_CHANGED")}componentWillUnmount(){this.fadeOutPromiseCancelable&&this.fadeOutPromiseCancelable.cancel(),clearTimeout(this.toastExpiresTimeoutId),this.globalMessagesService.unsubscribe(this.onNewToast,"TOAST_CHANGED")}fadeOutAndRenderNew(e){this.toastRef.current?(this.fadeOutPromiseCancelable=this.toastRef.current.fadeOut(),this.fadeOutPromiseCancelable.promise.then((()=>{this.updateCurrentToast(e)})).catch((e=>{if(!e.isCanceled)throw e}))):this.updateCurrentToast(e)}updateCurrentToast(e){this.keyId+=1,clearTimeout(this.toastExpiresTimeoutId),this.setState({toast:e},(()=>{this.toastExpiresTimeoutId=setTimeout(this.onToastExpires,e.duration)}))}clearToast(){this.toastRef.current&&(this.fadeOutPromiseCancelable&&this.fadeOutPromiseCancelable.cancel(),this.fadeOutPromiseCancelable=this.toastRef.current.fadeOut(),this.fadeOutPromiseCancelable.promise.then((()=>{this.setState({toast:void 0})})).catch((e=>{if(!e.isCanceled)throw e})))}}s[e].GlobalToastComponent=n,n.componentType="globalToast",a.VssComponent.register(n.componentType,n)}("ComponentsGlobalToast"),function(e){s.ComponentsGlobalMessages={};class n extends a.VssComponent{render(){return t.createElement(t.Fragment,null,t.createElement(b.GlobalBannerComponent,null),t.createElement(u.GlobalDialogComponent,null),t.createElement(C.GlobalToastComponent,null))}}n.componentType="globalMessages",a.VssComponent.register(n.componentType,n)}(),function(e){s.GlobalMessagesService={};const t="globalMessageData";class n extends m.VssObservableService{constructor(){super(...arguments),this.handleEndRequest=e=>{if(e.response&&e.response.headers){const s=e.response.headers.get("X-VSS-GlobalMessage");if(s)try{const e=JSON.parse(s);this.addBanner(e,!1,!0)}catch(e){console.warn("Failed to deserialize X-VSS-GlobalMessage header: "+e)}}},this.handleLegacyGlobalMessage=e=>{this.addBanner(e.detail,!1,!0)}}_serviceStart(e){super._serviceStart(e);const s=this.pageContext.getService("IVssContributionService"),n=s.getSharedData(t);this.currentMessageBanners=n&&n.banners?n.banners:[];const a=s.getSharedData("globalDialogData");this.currentDialogs=a&&a.dialogs?a.dialogs:[],p.requestListeners.subscribe(this.handleEndRequest,"afterRequest"),document.body.addEventListener("legacyGlobalMessage",this.handleLegacyGlobalMessage)}_serviceEnd(e){p.requestListeners.unsubscribe(this.handleEndRequest,"afterRequest"),document.body.removeEventListener("legacyGlobalMessage",this.handleLegacyGlobalMessage)}addToast(e){this._notify(e,"TOAST_CHANGED")}getDialog(){return this.currentDialogs[0]}addDialog(e,s,t){if(t){const s=this.currentDialogs[0];if(s&&(s.priority||0)>=(e.priority||0))return}s&&this.currentDialogs.shift(),this.currentDialogs.unshift(e),this._notify(e,"DIALOG_CHANGED")}closeDialog(){const e=this.getDialog();if(e&&e.settingId){const s={};if(s["GlobalDialog/Dismissed/"+e.settingId]=!0,(0,d.userHasClaim)(this.pageContext,"member")){this.pageContext.getRestClient("ISettingsRestClient").setEntries(s,"me")}}this.currentDialogs.shift(),this._notify(this.currentDialogs[0],"DIALOG_CHANGED")}getBanner(){return this.currentMessageBanners[0]}addBanner(e,s,t){if(t){const s=this.currentMessageBanners[0];if(s&&(s.level||0)>=(e.level||0))return}s&&this.currentMessageBanners.shift(),this.currentMessageBanners.unshift(e),this._notify(e,"MESSAGE_CHANGED")}getActions(){const e=this.pageContext.getService("IVssContributionService").getSharedData(t);return e&&e.actions?e.actions:void 0}closeBanner(){const e=this.getBanner();if(e&&e.settingId){const s={};s["GlobalMessage/Dismissed/"+e.settingId]=!0;this.pageContext.getRestClient("ISettingsRestClient").setEntries(s,"me")}this.currentMessageBanners.shift(),this._notify(this.currentMessageBanners[0],"MESSAGE_CHANGED")}}m.Services.add("IGlobalMessagesService",{serviceFactory:n});class a extends m.VssService{addBanner(e){this.pageContext.getService("IGlobalMessagesService").addBanner(e)}addDialog(e){this.pageContext.getService("IGlobalMessagesService").addDialog(e)}addToast(e){const s=this.pageContext.getService("IGlobalMessagesService"),t=Object.assign(Object.assign({},e),{onCallToActionClick:()=>{e.onCallToActionClick&&e.onCallToActionClick()}});s.addToast(t)}setGlobalMessageBanner(e){this.addBanner(e)}closeBanner(){this.pageContext.getService("IGlobalMessagesService").closeBanner()}closeDialog(){this.pageContext.getService("IGlobalMessagesService").closeDialog()}}m.Services.add("ms.vss-tfs-web.tfs-global-messages-service",{serviceFactory:a,options:1})}()}),["Resources","Components/GlobalDialog","Components/GlobalMessageBanner","Components/GlobalToast","Components/GlobalMessages","GlobalMessagesService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-tfs-web.global-banner-content"}}));