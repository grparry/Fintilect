"use strict";define("Wiki/ViewCommon",["require","exports","VSS/Platform/Feature","react","VSS/Platform/Layout","VSSUI/Portal","VSSUI/Spinner","VSS/Core/Util/String","VSS/Platform/Util/Url","VSS/Platform/FPS"],(function(e,t,n,i,a,r,s,o,c,l){var g,u,p,d,m;g=t[m="Resources"]={},t[m].WindowTitleWhileEditing="Editing {0} - Wiki",t[m].WindowTitleDefault="Wiki",t[m].LoadingSpinnerLabel="Loading...",t[m].ReservedNameNotAllowedInWikiName="'{0}' is reserved. It cannot be used as wiki name.",t[m].WikiNameEmpty="The wiki name cannot be empty",t[m].WikiNameCannotStartWith="The wiki name cannot start with '.' or '_'",t[m].InvalidCharactersInWikiName="The wiki name should not contain '{0}'",t[m].WikiNameTooLong="The wiki name can be a maximum of {0} characters",t[m].WikiNameCannotEndWith="The wiki name cannot end with '.'",function(e){u=t[e]={},function(e){e.HyphenEncoding="%2D",e.HyphenEncodingRegExp=/%2D/g,e.HyphenRegExp=/-/g,e.SpaceEncoding="%20",e.SpaceRegExp=/\ /g,e.OpeningBracesEncoding="\\(",e.OpeningBracesRegExp=/\(/g,e.ClosingBracesEncoding="\\)",e.ClosingBracesRegExp=/\)/g,e.ContiguousHyphenRegExp=/-{2,}/g}(t[e].UrlEscapeConstants||(t[e].UrlEscapeConstants={})),t[e].UrlConstants={AnchorParam:"anchor",ActionParam:"_a",IsSubPageParam:"isSubPage",PagePathParam:"pagePath",PageIdParam:"pageId",FriendlyNameParam:"friendlyName",ProjectParam:"project",WikiIdentifierParam:"wikiIdentifier",WikiVersionParam:"wikiVersion",ShouldScrollToCommentsParam:"shouldScrollToComments"},function(i){i.ResourceNameInvalidCharacters=["/","\\"],i.PageNameReservedCharacters=["#"],i.MaximumPagePathLength=235,i.AttachmentNameReservedCharacters=["#"],i.GitIllegalSpecialCharsRegExp=[/\:/g,/\?/g,/\*/g,/\</g,/\>/g,/\-/g,/\|/g,/\"/g],i.GitIllegalSpecialChars=[":","?","*","<",">","-","|",'"'],i.GitIllegalSpecialCharEscapes=["%3A","%3F","%2A","%3C","%3E","%2D","%7C","%22"],i.GitIllegalSpecialCharEscapesRegExp=[/%3A/g,/%3F/g,/%2A/g,/%3C/g,/%3E/g,/%2D/g,/%7C/g,/%22/g],i.AllowedAttachmentFileTypes=i=>[".CS",".CSV",".DOC",".DOCX",".GIF",".GZ",".HTM",".HTML",".ICO",".JPEG",".JPG",".JSON",".LYR",".MD",".MOV",".MP4",".MPP",".MSG",".PDF",".PNG",".PPT",".PPTX",".PS1",".RAR",".RDP",".SQL",".TXT",".VSD",".VSDX",".XLS",".XLSX",".XML",".ZIP",...(0,n.isFeatureFlagEnabled)(i,t[e].AttachSvgFileFF,!1)?[".SVG"]:[]]}(t[e].PathConstants||(t[e].PathConstants={})),t[e].AttachSvgFileFF="Wiki.AttachSvgFile",t[e].WikiPageCommentsFF="Wiki.WikiPageComments",t[e].WikiDataProviderContributionId="ms.vss-wiki-web.wiki-data-provider",t[e].RepoServiceContributionId="ms.vss-code.version-control"}("Constants"),function(e){t[e]={};t[e].ActionListener=class{constructor(){this._disposeActions=[]}addListener(e,t){e.addListener(t),this._disposeActions.push((()=>e.removeListener(t)))}removeListeners(){this._disposeActions.map((e=>e()))}}}("ActionListener"),function(e){t[e]={};t[e].LoadingSpinner=()=>i.createElement(r.Portal,null,i.createElement(s.Spinner,{label:g.LoadingSpinnerLabel,className:"absolute-fill wd-loading",size:"large"})),t[e].showWrappedDialog=function(n,r,s,o){n.getService("IVssLayoutManager").renderCallout((n=>i.createElement(a.WrappedComponent,Object.assign({wrappedType:s,dependencies:o},r,{onDismiss:()=>n(),loadingComponent:()=>i.createElement(t[e].LoadingSpinner,null)}))))}}("WrappedDialogHelper"),function(e){t[e]={},t[e].flattenWikiPage=function(e){if(!e)return[];const t=[];let n=[e];for(;n.length>0;){const e=[];for(const i of n)t.push(i),e.push(...i.subPages);n=[],n.push(...e)}return t}}("UtilsPageHelper"),function(e){function n(e){let t=e.replace(/[\/\\]+/g,"/");return(0,o.startsWith)(t,"/")||(t="/"+t),t}function i(e){return e.replace(u.UrlEscapeConstants.HyphenRegExp," ").replace(u.UrlEscapeConstants.HyphenEncodingRegExp,"-")}function a(e){return e.replace(u.UrlEscapeConstants.HyphenRegExp,u.UrlEscapeConstants.HyphenEncoding).replace(u.UrlEscapeConstants.SpaceRegExp,"-")}function r(e){if(!e)return"";const t=e.lastIndexOf("/");return t>=0?e.substring(t+1):e}function s(e){let t=e;for(let e=0;e<u.PathConstants.GitIllegalSpecialCharEscapes.length;e++)t=t.replace(u.PathConstants.GitIllegalSpecialCharsRegExp[e],u.PathConstants.GitIllegalSpecialCharEscapes[e]);return t.replace(u.UrlEscapeConstants.SpaceRegExp,"-")}p=t[e]={},t[e].normalizePath=n,t[e].decodeHyphenAndSpacesInPath=i,t[e].encodeHyphenAndSpacesInPath=a,t[e].getFileName=r,t[e].getGitItemPath=function(e,t){if(t||(t="/"),!e||"/"===e)return t;const n=s(e);return(0,c.combineUrlPaths)(t,n)+".md"},t[e].getEncodedPagePath=s,t[e].getLinkFromPath=function(e){let t=a(e);return t=t.replace(u.UrlEscapeConstants.OpeningBracesRegExp,u.UrlEscapeConstants.OpeningBracesEncoding).replace(u.UrlEscapeConstants.ClosingBracesRegExp,u.UrlEscapeConstants.ClosingBracesEncoding),t},t[e].getParentPath=function(e,t="/"){if(!e)return"";"/"===e[e.length-1]&&(e=e.substr(0,e.length-1));const n=e.lastIndexOf("/");return n>=0&&(e=e.substr(0,n))||(e=t),e},t[e].getDepthOfPage=function(e){return"/"===e?0:e.split("/").length-1},t[e].isInclude=function(e){return(0,o.startsWith)(e,"/.templates")},t[e].normalizeWikiPagePath=function(e){if(!e)return e;let t=n(e);return t=i(t),t},t[e].removeMdExtensionFromPagePath=function(e){const t=e.lastIndexOf(".");return 0===".md".toLocaleUpperCase().localeCompare(e.substring(t).toLocaleUpperCase(),navigator.language)?e.substring(0,t):e},t[e].getFriendlyPageTitle=function(e){if(!e)return"";let t=r(e);return t=t.replace(/[ `\-@$%^&+={}|\[\]:";<>?,*]/g,"-"),t.replace(u.UrlEscapeConstants.ContiguousHyphenRegExp,"-")}}("UtilsPathHelper"),function(e){d=t[e]={};const i="ms.vss-wiki-web.wiki-overview-nwp-route2";function a(e,t,n={}){const i={},a=e.getService("ITfsPageService").getData();a&&a.project&&(i[u.UrlConstants.ProjectParam]=a.project.name);const s=f(e,Object.assign(Object.assign(Object.assign({},n),t),i),{},0);return{url:r(e,"{project}/_wiki/wikis/{*wikiIdentifier}",s),state:s}}function r(e,t,n){const i=(0,c.parseRouteTemplate)(t),a=(0,c.routeUrl)([i],n);let r="";const s=e.getService("IVssPageService").getData();return s&&s.hostPath&&(r=s.hostPath),r?(0,c.combineUrlPaths)(encodeURI(r),a):a}function s(e,t){const n=(0,p.normalizeWikiPagePath)(t.pagePath),i=(0,p.getFileName)(n);let a=i;i&&t._a&&(0,o.equals)(t._a,"edit",!0)&&(a=(0,o.format)(g.WindowTitleWhileEditing,i)),a=a||g.WindowTitleDefault,m(e,a)}function m(e,t){e.getService("ITfsNavigationService").setPageTitle(t)}function P(e){return 0===e?"ProjectWiki":"CodeWiki"}function h(e){return(0,n.isFeatureFlagEnabled)(e,"Wiki.SimpleUrl")}function f(e,t,n={},i=2){let a={};const r=e.getService("IVssHistoryService"),s=r.getState(),c=r.getCurrentRouteValues(),l=Object.assign({},t);return l.pagePath&&(l.pagePath=l.pagePath.replace(u.UrlEscapeConstants.HyphenRegExp,u.UrlEscapeConstants.HyphenEncoding)),l._a&&((0,o.equals)(l._a,"view",!0)?l._a=void 0:l._a=l._a.toLowerCase()),!l.wikiVersion&&s[u.UrlConstants.WikiVersionParam]&&(l.wikiVersion=s[u.UrlConstants.WikiVersionParam]),0===i?a=Object.assign(Object.assign({},n),l):2===i?a=Object.assign(Object.assign(Object.assign({},s),n),l):1===i&&(c[u.UrlConstants.WikiIdentifierParam]||n.wikiIdentifier||!s[u.UrlConstants.WikiIdentifierParam]||(n.wikiIdentifier=s[u.UrlConstants.WikiIdentifierParam]),a=Object.assign(Object.assign(Object.assign({},c),n),l)),a}function S(e,t){return e.getService("IVssLocationService").routeUrl(i,t)}t[e].isCodeWiki=function(e){return 1===e.type},t[e].isEdge=function(){return!!/edge\/([\d+.]+)/i.exec(navigator.userAgent)},t[e].isFirefox=function(){const e=window.navigator.userAgent.toLowerCase();return!!/mozilla.*rv:([\d+.]+)/i.exec(navigator.userAgent)&&-1===e.indexOf("trident")},t[e].isIE=function(){const e=window.navigator.userAgent.toLowerCase();return!!/msie ([\d+.]+)/i.exec(navigator.userAgent)||-1!==e.indexOf("trident")},t[e].isSafari=function(){return!!/Safari\/([\d.]+)/i.exec(window.navigator.userAgent)&&-1===navigator.userAgent.toLowerCase().indexOf("chrome")},t[e].getVersionFromBranchName=function(e){return"GB"+e},t[e].updateUrl=function(e,t,n={},a=2,r){const c=f(e,t,n,a);if(s(e,c),h(e)&&c[u.UrlConstants.PageIdParam]&&(!t._a||(0,o.equals)(t._a,"view",!0)))!function(e,t,n){const a=Object.keys(u.UrlConstants),r={};a.forEach((e=>{const n=u.UrlConstants[e];n!==u.UrlConstants.PagePathParam&&n!==u.UrlConstants.WikiVersionParam&&t[n]&&(r[n]=t[n])}));let s=t[u.UrlConstants.PagePathParam];s&&(s=s.replace(u.UrlEscapeConstants.HyphenEncodingRegExp,"-"),r[u.UrlConstants.FriendlyNameParam]=(0,p.getFriendlyPageTitle)(s));const o=S(e,r),c={[u.UrlConstants.PagePathParam]:s,[u.UrlConstants.WikiVersionParam]:t[u.UrlConstants.WikiVersionParam]},l=e.getService("IVssHistoryService");n?l.replaceState(r,o,i,c):l.pushState(r,o,i,c)}(e,c,r);else{const t=e.getService("IVssHistoryService");r?t.replaceState(c):t.pushState(c)}},t[e].updateToPagePathBasedUrlIfNeeded=function(e,t,n={},i){const r=a(e,t,n),s=e.getService("IVssHistoryService");i?s.replaceState(r.state,r.url):s.pushState(r.state,r.url)},t[e].getPagePathBasedUrlAndState=a,t[e].routeUrlFromRouteTemplate=r,t[e].setWikiWindowTitle=s,t[e].setWindowTitle=m,t[e].getWikiTypeString=P,t[e].publish=function(e,t,n,i){const a=e.getService("IVssTelemetryService"),r=e.getService("ITfsPageService").getData(),s=r&&r.project&&r.project.id;let o;n&&(o="string"==typeof n?n:P(n)),a.publishEvent("Wiki",t,Object.assign(Object.assign({},i),{wikiType:o,newWiki:!0,projectId:s}))},t[e].navigateToUrl=function(e,t,n,i){const a=e.getService("IVssNavigationService").getCurrentRoute().routeId;i||(i={}),i[u.UrlConstants.ProjectParam]=t,n&&(i[u.UrlConstants.WikiIdentifierParam]=n);const r=e.getService("IVssLocationService").routeUrl(a,i);(0,l.onClickFPS)(e,r,!0)},t[e].getWikiUrl=function(e,t,n){const i=f(e,t,{},n);return e.getService("IVssHistoryService").generateUrl(i,n)},t[e].getWikiHomePageUrl=function(e,t){const n=e.getService("IVssNavigationService").getCurrentRoute().routeId;return e.getService("IVssLocationService").routeUrl(n,{[u.UrlConstants.ProjectParam]:t})},t[e].boundedOrderIncrement=function(e){const t=2147483647;return e<t?e+1:t},t[e].isCodeEditEnabled=function(e){return(0,n.isFeatureFlagEnabled)(e,"WebAccess.NewWiki.RichCodeWikiEditing")},t[e].isIncludeEditingAllowed=function(e){return(0,n.isFeatureFlagEnabled)(e,"Wiki.EnableTemplateEditing")&&(0,n.isFeatureEnabled)(e,"ms.vss-wiki-web.wiki-templates-editing")},t[e].isSimpleUrlEnabled=h,t[e].getNewWikiState=f,t[e].getSimpleUrl=S}("UtilsWikiHelper"),function(e){function n(e,t,n){return!n&&a(e,t)}function i(e,t){return"repoV2/"+(e+"/")+(t?t+"/":"")}function a(e,t){return r(e,t.projectId,t.repositoryId,4)}function r(e,t,n,a){return e.getService("IVssSecurityService").hasPermission("2e9eb7ed-3c0a-47d4-87c1-0ffdd275fd87",i(t,n),a)}t[e]={},t[e].hasWikiRenamePermission=function(e,t,i){return!i&&((0,d.isCodeWiki)(t)?n(e,t,i):r(e,t.projectId,t.repositoryId,1024))},t[e].hasWikiContributePermission=n,t[e].hasWikiManagePermission=function(e,t,n){return!n&&r(e,t.projectId,t.repositoryId,8192)},t[e].hasWikiCreatePermission=function(e,t,n){return!n&&r(e,t,void 0,256)},t[e].hasWikiPageCommentsWritePermission=function(e,t,n){return n||a(e,t)},t[e].hasProjectContributePermission=function(e,t,n){return!n&&r(e,t,void 0,4)},t[e].calculateGitSecuredToken=i}("UtilsWikiPermissionsHelper"),function(e){t[e]={};const n=["server","bin","App_code","App_Browsers","App_Data","App_GlobalResources","App_LocalResources","App_Themes","App_WebReferences","web.config","SignalR"],i=["prn","com1","com2","com3","com4","com5","com6","com7","com8","com9","com10","lpt1","lpt2","lpt3","lpt4","lpt5","lpt6","lpt7","lpt8","lpt9","nul","con","aux",".",".."],a=["@","~",";","{","}","'","+","=",",","<",">","|","/","\\","?",":","&","$","*",'"',"#","[","]","&","%"];t[e].validateProjectName=function(e){let t=0;const r={isValid:!0,invalidNameReason:""};if(null===(e=e.trim())||0===e.length)r.isValid=!1,r.invalidNameReason=g.WikiNameEmpty;else if(e.length>64)r.isValid=!1,r.invalidNameReason=(0,o.format)(g.WikiNameTooLong,64);else if("_"===e.substring(0,1)||"."===e.substring(0,1))r.isValid=!1,r.invalidNameReason=g.WikiNameCannotStartWith;else if("."===e.charAt(e.length-1))r.isValid=!1,r.invalidNameReason=g.WikiNameCannotEndWith;else{const s=[];for(t=0;t<a.length;t++){const n=a[t];-1!==e.indexOf(n)&&(r.isValid=!1,-1===s.indexOf(n)&&s.push(n))}if(r.isValid){const a=[...i,...n];for(t=0;t<a.length;t++)if((0,o.equals)(e,a[t],!0)){r.isValid=!1,r.invalidNameReason=(0,o.format)(g.ReservedNameNotAllowedInWikiName,e);break}}else r.invalidNameReason=(0,o.format)(g.InvalidCharactersInWikiName,s.join("','"))}return r}}("UtilsProjectNameValidator")}),["Resources","Constants","ActionListener","WrappedDialogHelper","Utils/PageHelper","Utils/PathHelper","Utils/WikiHelper","Utils/WikiPermissionsHelper","Utils/ProjectNameValidator"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-wiki-web.wiki-view-common-content"}}));