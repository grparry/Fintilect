"use strict";define("Wit/WorkItem/Service",["require","exports","react","VSS/Platform/Context","VSS/Platform/FPS","VSS/Platform/Layout","VSS/Platform/Location","Wit/Clients/Wit/RestClient/WorkItemTracking","Wit/Common/Generated/Constants","Wit/Common/BulkUpdateUtils/BulkUpdateInterfaces","Wit/Common/BulkUpdateUtils/BulkUpdateUtils","Wit/WorkItemModel/WorkItem/FieldUtils"],(function(e,t,o,r,s,a,i,n,l,c,m,p){t.index={},function(e){t.WorkItemService={};class d extends r.VssService{constructor(){super(...arguments),this.workItemsMap=new Map}createWorkItem(e,t,r,n){if(0===t){const t=this.pageContext.getService("ITfsPageService").getData();if(t&&t.project){let o=`${(0,i.routeUrl)(this.pageContext,"ms.vss-work-web.work-items-create-route",{project:t.project.name})}/${e}`;if(n&&Object.keys(n).length>0){o=`${o}?${Object.keys(n).map((e=>`[${e}]=${n[e]}`)).join("&")}`}(0,s.FastPageSwitch)(this.pageContext,o,!0)}}else{this.pageContext.getService("IVssLayoutManager").renderCallout((t=>o.createElement(a.WrappedComponent,{wrappedType:"legacy",dependencies:["ms.vss-web.legacy-content"],wrappedProps:{modules:["WorkItemTracking/SharedScripts/WorkItemDialogShim"],wrappedType:"createNewWorkItemDialog",workItemTypeName:e,onDismiss:t,options:r,initialValues:n}})))}}openWorkItemWithProps(e){this.pageContext.getService("IVssLayoutManager").renderCallout((t=>o.createElement(a.WrappedComponent,{wrappedType:"work-item-form-dialog",dependencies:["ms.vss-work-web.work-item-dialogs"],wrappedProps:Object.assign(Object.assign({},e),{onDismiss:()=>{var o;null===(o=e.onDismiss)||void 0===o||o.call(e),t()}})})))}openWorkItem(e,t,r){this.pageContext.getService("IVssLayoutManager").renderCallout((s=>o.createElement(a.WrappedComponent,{wrappedType:"legacy",dependencies:["ms.vss-web.legacy-content"],wrappedProps:{modules:["WorkItemTracking/SharedScripts/WorkItemDialogShim"],wrappedType:"WorkItemDialog",workItemId:e,onDismiss:s,options:t,tryGetLatest:r}})))}getWorkItemUrl(e,t){return(0,i.routeUrl)(this.pageContext,"ms.vss-work-web.work-item-view-route",{id:e.toString(10),project:t})}async loadWorkItem(e,t,o){const r=(await Promise.all(this.loadWorkItems(e,[t],o))).flat();return r.length?r[0]:void 0}loadWorkItems(e,t,o){const r=[];for(var s=0;s<t.length;s+=d.workItemBatchSize)r.push(t.slice(s,s+d.workItemBatchSize));const a=(0,n.getWorkItemTrackingClient)(this.pageContext);return r.map((t=>{const r={errorPolicy:2,ids:t,fields:o};return a.getWorkItemsBatch(r,e)}))}async setWorkItemInitialState(e){var t;const o=[],r=new Map;for(const s of e){const e=this.getInitialStateForTargetType(s),a=s.getFieldValueByName(l.CoreFieldRefNames.State);e&&a!==e?r.has(e)?null===(t=r.get(e))||void 0===t||t.push(s.id):r.set(e,[s.id]):o.push(s)}for(const e of r){const t=[{fieldName:l.CoreFieldRefNames.State,value:e[0]}],r=new Map;r.set(c.BulkUpdateConstants.AllTypes,t);const s=await(0,m.performBulkUpdate)(this.pageContext,e[1],r);o.push(...s)}return o}getInitialStateForTargetType(e){const t=e.getFieldByName(l.CoreFieldRefNames.State),o=(0,p.getAllowedFieldValues)(t,e).value;if(o.length>0){return o[0]}}async loadWorkItemsWithCaching(e,t,o,r){const s=[],a=Date.now();let i=[];if(r)i=e;else for(const t of e){const e=this.workItemsMap.get(t);e&&a-e.timestamp<d.cacheThreshold?s.push(e.item):i.push(t)}if(i.length){const e=this.loadWorkItems(o,i,t),r=(await Promise.all(e)).flat();r.forEach((e=>this.workItemsMap.set(e.id,{item:e,timestamp:a}))),s.push(...r)}return s}cleanCache(){this.workItemsMap.clear()}deleteItemsFromCache(e){e.forEach((e=>{this.workItemsMap.delete(e)}))}}d.workItemBatchSize=200,d.cacheThreshold=3e5,r.Services.add("work-item-service",{serviceFactory:d})}()}),["index","WorkItemService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-service-content"}}));